# ç”¨æˆ·ç®¡ç†

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [USER_MANAGEMENT.md](file://scripts/USER_MANAGEMENT.md)
- [user_password_manager.py](file://scripts/user_password_manager.py)
- [user_manager.ps1](file://scripts/user_manager.ps1)
- [user_manager.bat](file://scripts/user_manager.bat)
- [auth_manager.py](file://web/utils/auth_manager.py)
- [login.py](file://web/components/login.py)
- [user_activity_logger.py](file://web/utils/user_activity_logger.py)
- [config_management.py](file://web/modules/config_management.py)
- [app.py](file://web/app.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [ç”¨æˆ·è§’è‰²å’Œæƒé™](#ç”¨æˆ·è§’è‰²å’Œæƒé™)
4. [å‘½ä»¤è¡Œç”¨æˆ·ç®¡ç†å·¥å…·](#å‘½ä»¤è¡Œç”¨æˆ·ç®¡ç†å·¥å…·)
5. [Webç•Œé¢ç”¨æˆ·ç®¡ç†](#webç•Œé¢ç”¨æˆ·ç®¡ç†)
6. [ä¼šè¯ç®¡ç†å’Œå®‰å…¨æœºåˆ¶](#ä¼šè¯ç®¡ç†å’Œå®‰å…¨æœºåˆ¶)
7. [ç”¨æˆ·æ´»åŠ¨è®°å½•](#ç”¨æˆ·æ´»åŠ¨è®°å½•)
8. [æ‰¹é‡ç”¨æˆ·ç®¡ç†](#æ‰¹é‡ç”¨æˆ·ç®¡ç†)
9. [å®‰å…¨æœ€ä½³å®è·µ](#å®‰å…¨æœ€ä½³å®è·µ)
10. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

## ç®€ä»‹

TradingAgents-CN æä¾›äº†ä¸€å¥—å®Œæ•´çš„ç”¨æˆ·ç®¡ç†ç³»ç»Ÿï¼Œæ”¯æŒå¤šç”¨æˆ·éƒ¨ç½²åœºæ™¯ã€‚è¯¥ç³»ç»ŸåŒ…å«å‘½ä»¤è¡Œå·¥å…·å’ŒWebç•Œé¢ä¸¤ç§ç®¡ç†æ–¹å¼ï¼Œå…·å¤‡å®Œå–„çš„æƒé™æ§åˆ¶ã€ä¼šè¯ç®¡ç†å’Œå®‰å…¨æœºåˆ¶ã€‚

### æ ¸å¿ƒç‰¹æ€§
- **å¤šç”¨æˆ·æ”¯æŒ**: æ”¯æŒåŒæ—¶ç®¡ç†å¤šä¸ªç”¨æˆ·è´¦æˆ·
- **è§’è‰²æƒé™æ§åˆ¶**: åŒºåˆ†ç®¡ç†å‘˜å’Œæ™®é€šç”¨æˆ·ï¼Œæä¾›ç»†ç²’åº¦æƒé™ç®¡ç†
- **å®‰å…¨å­˜å‚¨**: å¯†ç é‡‡ç”¨SHA256å“ˆå¸ŒåŠ å¯†å­˜å‚¨
- **ä¼šè¯ç®¡ç†**: æ”¯æŒ10åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨è¶…æ—¶
- **æ´»åŠ¨è®°å½•**: å®Œæ•´çš„ç”¨æˆ·æ“ä½œå®¡è®¡æ—¥å¿—
- **è·¨å¹³å°æ”¯æŒ**: æä¾›Windowsæ‰¹å¤„ç†å’ŒPowerShellè„šæœ¬

## ç³»ç»Ÿæ¶æ„

```mermaid
graph TB
subgraph "ç”¨æˆ·ç®¡ç†æ¶æ„"
CLI[å‘½ä»¤è¡Œå·¥å…·] --> Config[ç”¨æˆ·é…ç½®æ–‡ä»¶<br/>users.json]
WebUI[Webç•Œé¢] --> Config
AuthMgr[è®¤è¯ç®¡ç†å™¨] --> Config
ActivityLogger[æ´»åŠ¨è®°å½•å™¨] --> LogFiles[æ´»åŠ¨æ—¥å¿—æ–‡ä»¶]
Config --> Users[ç”¨æˆ·æ•°æ®]
Users --> Hash[SHA256å¯†ç å“ˆå¸Œ]
Users --> Permissions[æƒé™é…ç½®]
AuthMgr --> Session[ä¼šè¯ç®¡ç†]
Session --> Timeout[10åˆ†é’Ÿè¶…æ—¶]
Session --> Cache[å‰ç«¯ç¼“å­˜]
end
subgraph "å®‰å…¨å±‚"
PasswordHash[å¯†ç å“ˆå¸Œ] --> Storage[å®‰å…¨å­˜å‚¨]
SessionMgr[ä¼šè¯ç®¡ç†] --> Security[å®‰å…¨æœºåˆ¶]
ActivityLog[æ´»åŠ¨è®°å½•] --> Audit[å®¡è®¡è¿½è¸ª]
end
```

**æ¶æ„å›¾æºæ–‡ä»¶**
- [auth_manager.py](file://web/utils/auth_manager.py#L25-L61)
- [user_password_manager.py](file://scripts/user_password_manager.py#L18-L25)

## ç”¨æˆ·è§’è‰²å’Œæƒé™

### è§’è‰²å®šä¹‰

ç³»ç»Ÿæä¾›ä¸¤ç§ç”¨æˆ·è§’è‰²ï¼Œæ¯ç§è§’è‰²å…·æœ‰ä¸åŒçš„æƒé™çº§åˆ«ï¼š

| è§’è‰² | æƒé™æè¿° | é»˜è®¤æƒé™ | ç”¨é€” |
|------|----------|----------|------|
| `admin` | ç³»ç»Ÿç®¡ç†å‘˜ | `["analysis", "config", "admin"]` | ç³»ç»Ÿé…ç½®ã€ç”¨æˆ·ç®¡ç†ã€é«˜çº§æ“ä½œ |
| `user` | æ™®é€šç”¨æˆ· | `["analysis"]` | è‚¡ç¥¨åˆ†æã€åŸºç¡€åŠŸèƒ½ä½¿ç”¨ |

### æƒé™åˆ†ç±»

```mermaid
graph LR
subgraph "æƒé™å±‚æ¬¡"
Admin[ç®¡ç†å‘˜æƒé™] --> Config[é…ç½®ç®¡ç†]
Admin --> UserMgmt[ç”¨æˆ·ç®¡ç†]
Admin --> System[ç³»ç»Ÿç®¡ç†]
User[ç”¨æˆ·æƒé™] --> Analysis[è‚¡ç¥¨åˆ†æ]
Config --> ConfigMgmt[é…ç½®ä¿®æ”¹]
UserMgmt --> UserOps[ç”¨æˆ·æ“ä½œ]
System --> SysOps[ç³»ç»Ÿæ“ä½œ]
Analysis --> StockAnalysis[è‚¡ç¥¨åˆ†æ]
end
```

**æƒé™å›¾æºæ–‡ä»¶**
- [auth_manager.py](file://web/utils/auth_manager.py#L363-L383)
- [user_password_manager.py](file://scripts/user_password_manager.py#L100-L122)

### æƒé™æ£€æŸ¥æœºåˆ¶

ç³»ç»Ÿåœ¨æ¯ä¸ªå…³é”®æ“ä½œå‰éƒ½ä¼šè¿›è¡Œæƒé™éªŒè¯ï¼š

```mermaid
sequenceDiagram
participant User as ç”¨æˆ·
participant AuthMgr as è®¤è¯ç®¡ç†å™¨
participant PermCheck as æƒé™æ£€æŸ¥
participant Action as æ‰§è¡Œæ“ä½œ
User->>AuthMgr : è¯·æ±‚æ“ä½œ
AuthMgr->>PermCheck : æ£€æŸ¥æƒé™
PermCheck->>PermCheck : éªŒè¯ç”¨æˆ·è§’è‰²
PermCheck->>PermCheck : æ£€æŸ¥å…·ä½“æƒé™
alt æƒé™éªŒè¯é€šè¿‡
PermCheck->>Action : å…è®¸æ‰§è¡Œ
Action-->>User : æ“ä½œæˆåŠŸ
else æƒé™ä¸è¶³
PermCheck-->>User : æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
end
```

**åºåˆ—å›¾æºæ–‡ä»¶**
- [auth_manager.py](file://web/utils/auth_manager.py#L363-L383)
- [app.py](file://web/app.py#L927-L988)

**ç« èŠ‚æºæ–‡ä»¶**
- [auth_manager.py](file://web/utils/auth_manager.py#L25-L61)
- [user_password_manager.py](file://scripts/user_password_manager.py#L100-L122)

## å‘½ä»¤è¡Œç”¨æˆ·ç®¡ç†å·¥å…·

### å·¥å…·æ¦‚è¿°

ç³»ç»Ÿæä¾›ä¸‰ä¸ªç”¨æˆ·ç®¡ç†è„šæœ¬ï¼Œæ”¯æŒä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œä½¿ç”¨åœºæ™¯ï¼š

| è„šæœ¬æ–‡ä»¶ | å¹³å°æ”¯æŒ | ä½¿ç”¨åœºæ™¯ |
|----------|----------|----------|
| `user_password_manager.py` | è·¨å¹³å° | PythonåŸç”Ÿè„šæœ¬ï¼ŒåŠŸèƒ½å®Œæ•´ |
| `user_manager.bat` | Windows | æ‰¹å¤„ç†è„šæœ¬ï¼Œç®€å•æ˜“ç”¨ |
| `user_manager.ps1` | Windows | PowerShellè„šæœ¬ï¼ŒåŠŸèƒ½ä¸°å¯Œ |

### åŸºæœ¬ä½¿ç”¨æ–¹æ³•

#### Pythonè„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯
python scripts/user_password_manager.py --help

# åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
python scripts/user_password_manager.py list

# ä¿®æ”¹ç”¨æˆ·å¯†ç 
python scripts/user_password_manager.py change-password admin newpassword123

# åˆ›å»ºæ–°ç”¨æˆ·
python scripts/user_password_manager.py create-user newuser password123 --role user

# åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
python scripts/user_password_manager.py create-user newadmin adminpass123 --role admin

# åˆ é™¤ç”¨æˆ·
python scripts/user_password_manager.py delete-user olduser

# é‡ç½®ä¸ºé»˜è®¤é…ç½®
python scripts/user_password_manager.py reset
```

#### Windowsæ‰¹å¤„ç†è„šæœ¬

```cmd
# åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
scripts\user_manager.bat list

# ä¿®æ”¹ç”¨æˆ·å¯†ç 
scripts\user_manager.bat change-password admin newpassword123

# åˆ›å»ºæ–°ç”¨æˆ·
scripts\user_manager.bat create-user newuser password123 user

# åˆ é™¤ç”¨æˆ·
scripts\user_manager.bat delete-user olduser

# é‡ç½®ä¸ºé»˜è®¤é…ç½®
scripts\user_manager.bat reset
```

#### PowerShellè„šæœ¬

```powershell
# åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·
.\scripts\user_manager.ps1 list

# ä¿®æ”¹ç”¨æˆ·å¯†ç 
.\scripts\user_manager.ps1 change-password admin newpassword123

# åˆ›å»ºæ–°ç”¨æˆ·
.\scripts\user_manager.ps1 create-user newuser password123 user

# åˆ é™¤ç”¨æˆ·
.\scripts\user_manager.ps1 delete-user olduser

# é‡ç½®ä¸ºé»˜è®¤é…ç½®
.\scripts\user_manager.ps1 reset
```

### åŠŸèƒ½è¯¦è§£

#### 1. åˆ—å‡ºç”¨æˆ· (list)

æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ï¼š

```bash
ğŸ“‹ ç”¨æˆ·åˆ—è¡¨:
------------------------------------------------------------
ç”¨æˆ·å           è§’è‰²       æƒé™                           åˆ›å»ºæ—¶é—´
------------------------------------------------------------
admin          admin      analysis, config, admin        2024-01-15 10:30:25
user           user       analysis                       2024-01-15 10:30:25
analyst        user       analysis                       2024-01-16 14:20:10
manager        admin      analysis, config, admin        2024-01-17 09:45:30
```

#### 2. ä¿®æ”¹å¯†ç  (change-password)

ä¿®æ”¹æŒ‡å®šç”¨æˆ·çš„å¯†ç ï¼Œç³»ç»Ÿè‡ªåŠ¨è¿›è¡ŒSHA256å“ˆå¸Œå¤„ç†ï¼š

```bash
# è¯­æ³•: change-password <ç”¨æˆ·å> <æ–°å¯†ç >
python scripts/user_password_manager.py change-password admin secure_new_password123
```

#### 3. åˆ›å»ºç”¨æˆ· (create-user)

åˆ›å»ºæ–°çš„ç”¨æˆ·è´¦æˆ·ï¼Œæ”¯æŒè‡ªå®šä¹‰è§’è‰²å’Œæƒé™ï¼š

```bash
# åŸºæœ¬è¯­æ³•
python scripts/user_password_manager.py create-user <ç”¨æˆ·å> <å¯†ç > [--role <è§’è‰²>]

# ç¤ºä¾‹ï¼šåˆ›å»ºåˆ†æå¸ˆç”¨æˆ·
python scripts/user_password_manager.py create-user analyst analyst123 --role user

# ç¤ºä¾‹ï¼šåˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
python scripts/user_password_manager.py create-user manager manager123 --role admin
```

**å‚æ•°è¯´æ˜**ï¼š
- `--role`: ç”¨æˆ·è§’è‰²ï¼Œå¯é€‰å€¼ä¸º `user` æˆ– `admin`ï¼Œé»˜è®¤ä¸º `user`
- `--permissions`: æƒé™åˆ—è¡¨ï¼Œå¦‚ä¸æŒ‡å®šåˆ™æ ¹æ®è§’è‰²è‡ªåŠ¨åˆ†é…

#### 4. åˆ é™¤ç”¨æˆ· (delete-user)

åˆ é™¤æŒ‡å®šçš„ç”¨æˆ·è´¦æˆ·ï¼Œç³»ç»Ÿä¼šé˜²æ­¢åˆ é™¤æœ€åä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·ï¼š

```bash
# è¯­æ³•: delete-user <ç”¨æˆ·å>
python scripts/user_password_manager.py delete-user olduser

# ç³»ç»Ÿä¼šæç¤ºç¡®è®¤
ç¡®è®¤åˆ é™¤ç”¨æˆ· 'olduser'? (y/N): y
âœ… ç”¨æˆ· olduser å·²åˆ é™¤
```

#### 5. é‡ç½®é…ç½® (reset)

å°†ç”¨æˆ·é…ç½®é‡ç½®ä¸ºé»˜è®¤è®¾ç½®ï¼š

```bash
# é‡ç½®å‰ä¼šæç¤ºç¡®è®¤
ç¡®è®¤é‡ç½®ä¸ºé»˜è®¤ç”¨æˆ·é…ç½®? è¿™å°†åˆ é™¤æ‰€æœ‰ç°æœ‰ç”¨æˆ·! (y/N): y

âœ… ç”¨æˆ·é…ç½®å·²é‡ç½®ä¸ºé»˜è®¤è®¾ç½®
   é»˜è®¤ç”¨æˆ·:
   - admin / admin123 (ç®¡ç†å‘˜)
   - user / user123 (æ™®é€šç”¨æˆ·)
```

### é…ç½®æ–‡ä»¶ä½ç½®

ç”¨æˆ·é…ç½®æ–‡ä»¶ä½äºï¼š`web/config/users.json`

**ç« èŠ‚æºæ–‡ä»¶**
- [USER_MANAGEMENT.md](file://scripts/USER_MANAGEMENT.md#L1-L161)
- [user_password_manager.py](file://scripts/user_password_manager.py#L1-L262)
- [user_manager.ps1](file://scripts/user_manager.ps1#L1-L83)
- [user_manager.bat](file://scripts/user_manager.bat#L1-L56)

## Webç•Œé¢ç”¨æˆ·ç®¡ç†

### ç™»å½•ç•Œé¢

Webç•Œé¢æä¾›ç°ä»£åŒ–çš„ç™»å½•ä½“éªŒï¼Œæ”¯æŒå‰ç«¯ç¼“å­˜å’Œè‡ªåŠ¨æ¢å¤åŠŸèƒ½ï¼š

```mermaid
graph TD
Login[ç™»å½•é¡µé¢] --> LoginForm[ç™»å½•è¡¨å•]
LoginForm --> Username[ç”¨æˆ·åè¾“å…¥]
LoginForm --> Password[å¯†ç è¾“å…¥]
LoginForm --> Submit[ç™»å½•æŒ‰é’®]
Submit --> AuthCheck[è®¤è¯æ£€æŸ¥]
AuthCheck --> Success[ç™»å½•æˆåŠŸ]
AuthCheck --> Failure[ç™»å½•å¤±è´¥]
Success --> FrontendCache[å‰ç«¯ç¼“å­˜]
Success --> SessionState[ä¼šè¯çŠ¶æ€]
FrontendCache --> AutoRestore[è‡ªåŠ¨æ¢å¤]
SessionState --> UserDashboard[ç”¨æˆ·ä»ªè¡¨æ¿]
```

**ç™»å½•æµç¨‹å›¾æºæ–‡ä»¶**
- [login.py](file://web/components/login.py#L150-L200)
- [auth_manager.py](file://web/utils/auth_manager.py#L229-L266)

### ä¼šè¯ç®¡ç†

Webç•Œé¢å®ç°äº†å®Œæ•´çš„ä¼šè¯ç®¡ç†æœºåˆ¶ï¼š

#### 1. ä¼šè¯è¶…æ—¶æœºåˆ¶

- **è¶…æ—¶æ—¶é—´**: 10åˆ†é’Ÿæ— æ“ä½œè‡ªåŠ¨è¶…æ—¶
- **æ£€æµ‹é¢‘ç‡**: å®æ—¶æ£€æŸ¥ä¼šè¯çŠ¶æ€
- **è‡ªåŠ¨ç™»å‡º**: è¶…æ—¶æ—¶è‡ªåŠ¨æ¸…é™¤ä¼šè¯

#### 2. å‰ç«¯ç¼“å­˜æœºåˆ¶

ç³»ç»Ÿåœ¨æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ç”¨æˆ·è®¤è¯ä¿¡æ¯ï¼š

```javascript
// å‰ç«¯ç¼“å­˜ç»“æ„
{
    "userInfo": {
        "username": "admin",
        "role": "admin",
        "permissions": ["analysis", "config", "admin"]
    },
    "loginTime": 1640995200.123,
    "lastActivity": 1640995800.456
}
```

#### 3. è‡ªåŠ¨æ¢å¤åŠŸèƒ½

å½“ç”¨æˆ·å…³é—­æµè§ˆå™¨é‡æ–°æ‰“å¼€æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•æ¢å¤ä¹‹å‰çš„ç™»å½•çŠ¶æ€ï¼š

```mermaid
sequenceDiagram
participant Browser as æµè§ˆå™¨
participant JS as JavaScript
participant Backend as åç«¯
participant Cache as å‰ç«¯ç¼“å­˜
Browser->>JS : é¡µé¢åŠ è½½
JS->>Cache : æ£€æŸ¥æœ¬åœ°å­˜å‚¨
Cache-->>JS : è¿”å›è®¤è¯æ•°æ®
alt ç¼“å­˜æœ‰æ•ˆ
JS->>Backend : éªŒè¯è®¤è¯çŠ¶æ€
Backend-->>JS : è®¤è¯æˆåŠŸ
JS->>Browser : æ¢å¤ç”¨æˆ·ç•Œé¢
else ç¼“å­˜æ— æ•ˆ
JS->>Browser : æ˜¾ç¤ºç™»å½•é¡µé¢
end
```

**è‡ªåŠ¨æ¢å¤æµç¨‹å›¾æºæ–‡ä»¶**
- [auth_manager.py](file://web/utils/auth_manager.py#L59-L93)
- [app.py](file://web/app.py#L416-L448)

### æƒé™æ§åˆ¶

Webç•Œé¢åœ¨æ¯ä¸ªé¡µé¢å’ŒåŠŸèƒ½æ¨¡å—éƒ½å®æ–½ä¸¥æ ¼çš„æƒé™æ§åˆ¶ï¼š

#### é¡µé¢çº§æƒé™æ§åˆ¶

```python
# é…ç½®ç®¡ç†é¡µé¢ - éœ€è¦configæƒé™
if not require_permission("config"):
    return

# ç³»ç»Ÿè®¾ç½®é¡µé¢ - éœ€è¦adminæƒé™
if not require_permission("admin"):
    return
```

#### åŠŸèƒ½çº§æƒé™æ§åˆ¶

```python
# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæƒé™
if auth_manager.check_permission("analysis"):
    # å…è®¸è‚¡ç¥¨åˆ†æåŠŸèƒ½
    render_analysis_form()
else:
    st.error("æ‚¨æ²¡æœ‰åˆ†ææƒé™")
```

**ç« èŠ‚æºæ–‡ä»¶**
- [login.py](file://web/components/login.py#L1-L557)
- [auth_manager.py](file://web/utils/auth_manager.py#L25-L384)
- [app.py](file://web/app.py#L927-L988)

## ä¼šè¯ç®¡ç†å’Œå®‰å…¨æœºåˆ¶

### å¯†ç å­˜å‚¨ç­–ç•¥

ç³»ç»Ÿé‡‡ç”¨å¼ºå¯†ç å“ˆå¸Œç­–ç•¥ä¿æŠ¤ç”¨æˆ·å‡­æ®ï¼š

#### å“ˆå¸Œç®—æ³•
- **ç®—æ³•**: SHA256
- **å®ç°**: `hashlib.sha256(password.encode()).hexdigest()`
- **å®‰å…¨æ€§**: å•å‘å“ˆå¸Œï¼Œä¸å¯é€†æ¨

#### å­˜å‚¨æ ¼å¼

```json
{
    "admin": {
        "password_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
        "role": "admin",
        "permissions": ["analysis", "config", "admin"],
        "created_at": 1640995200.123
    }
}
```

### ä¼šè¯è¶…æ—¶æœºåˆ¶

#### è¶…æ—¶é…ç½®

```python
# ä¼šè¯è¶…æ—¶æ—¶é—´ï¼š10åˆ†é’Ÿï¼ˆ600,000æ¯«ç§’ï¼‰
self.session_timeout = 600000
```

#### è¶…æ—¶æ£€æµ‹æµç¨‹

```mermaid
flowchart TD
Start[ä¼šè¯æ£€æŸ¥å¼€å§‹] --> CheckAuth{ç”¨æˆ·å·²è®¤è¯?}
CheckAuth --> |å¦| NotAuthenticated[è¿”å›æœªè®¤è¯]
CheckAuth --> |æ˜¯| CalcElapsed[è®¡ç®—å·²è¿‡æ—¶é—´]
CalcElapsed --> CheckTimeout{è¶…è¿‡è¶…æ—¶æ—¶é—´?}
CheckTimeout --> |æ˜¯| Logout[è‡ªåŠ¨ç™»å‡º]
CheckTimeout --> |å¦| Authenticated[è¿”å›å·²è®¤è¯]
Logout --> ClearSession[æ¸…é™¤ä¼šè¯çŠ¶æ€]
ClearSession --> LogOutEvent[è®°å½•ç™»å‡ºäº‹ä»¶]
NotAuthenticated --> End[ç»“æŸ]
Authenticated --> End
LogOutEvent --> End
```

**è¶…æ—¶æ£€æµ‹æµç¨‹å›¾æºæ–‡ä»¶**
- [auth_manager.py](file://web/utils/auth_manager.py#L229-L266)

### è®¿é—®æ—¥å¿—

ç³»ç»Ÿè®°å½•æ‰€æœ‰é‡è¦çš„è®¿é—®å’Œæ“ä½œäº‹ä»¶ï¼š

#### æ—¥å¿—ç±»å‹

| æ—¥å¿—ç±»å‹ | æè¿° | è®°å½•å†…å®¹ |
|----------|------|----------|
| ç™»å½•æ—¥å¿— | ç”¨æˆ·ç™»å½•/ç™»å‡º | ç”¨æˆ·åã€æ—¶é—´ã€æˆåŠŸ/å¤±è´¥ |
| æƒé™æ—¥å¿— | æƒé™æ£€æŸ¥ç»“æœ | ç”¨æˆ·åã€æƒé™ã€æ£€æŸ¥ç»“æœ |
| æ“ä½œæ—¥å¿— | åŠŸèƒ½ä½¿ç”¨æƒ…å†µ | ç”¨æˆ·åã€æ“ä½œç±»å‹ã€å‚æ•° |
| é”™è¯¯æ—¥å¿— | ç³»ç»Ÿé”™è¯¯ä¿¡æ¯ | é”™è¯¯ç±»å‹ã€å †æ ˆä¿¡æ¯ |

#### æ—¥å¿—æ ¼å¼

```json
{
    "timestamp": 1640995200.123,
    "username": "admin",
    "user_role": "admin",
    "action_type": "auth",
    "action_name": "user_login",
    "details": {"username": "admin"},
    "session_id": "session_1640995200_123456",
    "success": true,
    "ip_address": "192.168.1.100",
    "user_agent": "Mozilla/5.0..."
}
```

**ç« èŠ‚æºæ–‡ä»¶**
- [auth_manager.py](file://web/utils/auth_manager.py#L159-L198)
- [user_activity_logger.py](file://web/utils/user_activity_logger.py#L1-L414)

## ç”¨æˆ·æ´»åŠ¨è®°å½•

### æ´»åŠ¨è®°å½•å™¨åŠŸèƒ½

ç³»ç»Ÿæä¾›å®Œæ•´çš„ç”¨æˆ·æ´»åŠ¨è®°å½•åŠŸèƒ½ï¼Œæ”¯æŒå®¡è®¡å’Œç›‘æ§ï¼š

#### è®°å½•çš„æ´»åŠ¨ç±»å‹

```mermaid
graph LR
subgraph "æ´»åŠ¨åˆ†ç±»"
Auth[è®¤è¯æ´»åŠ¨]
Analysis[åˆ†ææ´»åŠ¨]
Config[é…ç½®æ´»åŠ¨]
Navigation[å¯¼èˆªæ´»åŠ¨]
Export[å¯¼å‡ºæ´»åŠ¨]
UserMgmt[ç”¨æˆ·ç®¡ç†æ´»åŠ¨]
System[ç³»ç»Ÿæ´»åŠ¨]
end
Auth --> Login[ç™»å½•/ç™»å‡º]
Auth --> AuthFail[è®¤è¯å¤±è´¥]
Analysis --> StockAnalysis[è‚¡ç¥¨åˆ†æ]
Analysis --> AnalysisFail[åˆ†æå¤±è´¥]
Config --> ConfigChange[é…ç½®ä¿®æ”¹]
Config --> ConfigView[é…ç½®æŸ¥çœ‹]
Navigation --> PageVisit[é¡µé¢è®¿é—®]
Navigation --> NavFail[å¯¼èˆªå¤±è´¥]
Export --> DataExport[æ•°æ®å¯¼å‡º]
Export --> ExportFail[å¯¼å‡ºå¤±è´¥]
UserMgmt --> CreateUser[åˆ›å»ºç”¨æˆ·]
UserMgmt --> DeleteUser[åˆ é™¤ç”¨æˆ·]
UserMgmt --> ModifyUser[ä¿®æ”¹ç”¨æˆ·]
System --> SystemRestart[ç³»ç»Ÿé‡å¯]
System --> SystemError[ç³»ç»Ÿé”™è¯¯]
```

**æ´»åŠ¨åˆ†ç±»å›¾æºæ–‡ä»¶**
- [user_activity_logger.py](file://web/utils/user_activity_logger.py#L50-L70)

### æ´»åŠ¨è®°å½•API

#### åŸºæœ¬è®°å½•æ–¹æ³•

```python
# è®°å½•ç™»å½•æ´»åŠ¨
user_activity_logger.log_login(username, success, error_message)

# è®°å½•åˆ†æè¯·æ±‚
user_activity_logger.log_analysis_request(stock_code, analysis_type, success)

# è®°å½•é…ç½®å˜æ›´
user_activity_logger.log_config_change(config_type, changes)

# è®°å½•ç”¨æˆ·ç®¡ç†æ“ä½œ
user_activity_logger.log_user_management(operation, target_user, success)
```

#### é«˜çº§æŸ¥è¯¢åŠŸèƒ½

```python
# è·å–ç”¨æˆ·æ´»åŠ¨è®°å½•
activities = user_activity_logger.get_user_activities(
    username="admin",
    start_date=datetime.now() - timedelta(days=7),
    end_date=datetime.now(),
    action_type="auth",
    limit=100
)

# è·å–æ´»åŠ¨ç»Ÿè®¡
stats = user_activity_logger.get_activity_statistics(days=7)
```

### æ—¥å¿—æ–‡ä»¶ç®¡ç†

#### æ–‡ä»¶ç»„ç»‡ç»“æ„

```
web/data/user_activities/
â”œâ”€â”€ user_activities_2024-01-15.jsonl
â”œâ”€â”€ user_activities_2024-01-16.jsonl
â”œâ”€â”€ user_activities_2024-01-17.jsonl
â””â”€â”€ ...
```

#### è‡ªåŠ¨æ¸…ç†æœºåˆ¶

ç³»ç»Ÿè‡ªåŠ¨æ¸…ç†è¶…è¿‡90å¤©çš„æ—§æ—¥å¿—æ–‡ä»¶ï¼š

```python
# æ¸…ç†æ—§æ´»åŠ¨è®°å½•
deleted_count = user_activity_logger.cleanup_old_activities(days_to_keep=90)
print(f"å·²åˆ é™¤ {deleted_count} ä¸ªæ—§æ—¥å¿—æ–‡ä»¶")
```

**ç« èŠ‚æºæ–‡ä»¶**
- [user_activity_logger.py](file://web/utils/user_activity_logger.py#L1-L414)

## æ‰¹é‡ç”¨æˆ·ç®¡ç†

### æ‰¹é‡æ“ä½œè„šæœ¬

ç³»ç»Ÿæ”¯æŒé€šè¿‡Pythonè„šæœ¬è¿›è¡Œæ‰¹é‡ç”¨æˆ·ç®¡ç†æ“ä½œï¼š

#### æ‰¹é‡åˆ›å»ºç”¨æˆ·

```python
#!/usr/bin/env python3
"""
æ‰¹é‡åˆ›å»ºç”¨æˆ·è„šæœ¬ç¤ºä¾‹
"""

import sys
import os
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from scripts.user_password_manager import create_user, load_users, save_users

def batch_create_users(user_list):
    """æ‰¹é‡åˆ›å»ºç”¨æˆ·"""
    users = load_users()
    
    for username, password, role in user_list:
        if username in users:
            print(f"ç”¨æˆ· {username} å·²å­˜åœ¨ï¼Œè·³è¿‡")
            continue
        
        success = create_user(username, password, role)
        if success:
            print(f"âœ… ç”¨æˆ· {username} åˆ›å»ºæˆåŠŸ")
        else:
            print(f"âŒ ç”¨æˆ· {username} åˆ›å»ºå¤±è´¥")

# ç”¨æˆ·åˆ—è¡¨æ ¼å¼ï¼š(ç”¨æˆ·å, å¯†ç , è§’è‰²)
users_to_create = [
    ("analyst1", "analyst_pass123", "user"),
    ("analyst2", "analyst_pass123", "user"),
    ("analyst3", "analyst_pass123", "user"),
    ("manager1", "manager_pass123", "admin"),
    ("manager2", "manager_pass123", "admin")
]

batch_create_users(users_to_create)
```

#### æ‰¹é‡ä¿®æ”¹å¯†ç 

```python
#!/usr/bin/env python3
"""
æ‰¹é‡ä¿®æ”¹å¯†ç è„šæœ¬ç¤ºä¾‹
"""

import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from scripts.user_password_manager import change_password, load_users

def batch_change_passwords(password_map):
    """æ‰¹é‡ä¿®æ”¹å¯†ç """
    users = load_users()
    
    for username, new_password in password_map.items():
        if username not in users:
            print(f"ç”¨æˆ· {username} ä¸å­˜åœ¨ï¼Œè·³è¿‡")
            continue
        
        success = change_password(username, new_password)
        if success:
            print(f"âœ… ç”¨æˆ· {username} å¯†ç ä¿®æ”¹æˆåŠŸ")
        else:
            print(f"âŒ ç”¨æˆ· {username} å¯†ç ä¿®æ”¹å¤±è´¥")

# ç”¨æˆ·å¯†ç æ˜ å°„
password_updates = {
    "analyst1": "new_analyst_pass123",
    "analyst2": "new_analyst_pass123", 
    "manager1": "new_manager_pass123"
}

batch_change_passwords(password_updates)
```

#### æ‰¹é‡åˆ é™¤ç”¨æˆ·

```python
#!/usr/bin/env python3
"""
æ‰¹é‡åˆ é™¤ç”¨æˆ·è„šæœ¬ç¤ºä¾‹
"""

import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from scripts.user_password_manager import delete_user, load_users

def batch_delete_users(usernames):
    """æ‰¹é‡åˆ é™¤ç”¨æˆ·"""
    users = load_users()
    
    for username in usernames:
        if username not in users:
            print(f"ç”¨æˆ· {username} ä¸å­˜åœ¨ï¼Œè·³è¿‡")
            continue
        
        success = delete_user(username)
        if success:
            print(f"âœ… ç”¨æˆ· {username} åˆ é™¤æˆåŠŸ")
        else:
            print(f"âŒ ç”¨æˆ· {username} åˆ é™¤å¤±è´¥")

# è¦åˆ é™¤çš„ç”¨æˆ·åˆ—è¡¨
users_to_delete = ["test_user1", "test_user2", "test_user3"]

batch_delete_users(users_to_delete)
```

### é…ç½®æ¨¡æ¿ç®¡ç†

#### ç”¨æˆ·é…ç½®æ¨¡æ¿

```python
# ç”¨æˆ·é…ç½®æ¨¡æ¿
USER_TEMPLATES = {
    "analyst": {
        "role": "user",
        "permissions": ["analysis"],
        "default_password": "analyst123"
    },
    "admin": {
        "role": "admin", 
        "permissions": ["analysis", "config", "admin"],
        "default_password": "admin123"
    },
    "readonly": {
        "role": "user",
        "permissions": ["analysis"],
        "default_password": "readonly123"
    }
}

def create_user_with_template(username, template_name):
    """ä½¿ç”¨æ¨¡æ¿åˆ›å»ºç”¨æˆ·"""
    if template_name not in USER_TEMPLATES:
        print(f"æ¨¡æ¿ {template_name} ä¸å­˜åœ¨")
        return False
    
    template = USER_TEMPLATES[template_name]
    return create_user(
        username, 
        template["default_password"], 
        template["role"], 
        template["permissions"]
    )
```

**ç« èŠ‚æºæ–‡ä»¶**
- [user_password_manager.py](file://scripts/user_password_manager.py#L80-L170)

## å®‰å…¨æœ€ä½³å®è·µ

### å¯†ç å®‰å…¨

#### å¯†ç ç­–ç•¥

1. **æœ€å°é•¿åº¦**: å»ºè®®è‡³å°‘8ä½å­—ç¬¦
2. **å¤æ‚åº¦è¦æ±‚**: åŒ…å«å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
3. **å®šæœŸæ›´æ¢**: å»ºè®®æ¯90å¤©æ›´æ¢ä¸€æ¬¡å¯†ç 
4. **å”¯ä¸€æ€§**: ä¸åŒè´¦æˆ·ä½¿ç”¨ä¸åŒå¯†ç 

#### å¯†ç å­˜å‚¨å®‰å…¨

```python
# å¼ºå¯†ç å“ˆå¸Œç¤ºä¾‹
def secure_password_hash(password):
    """å®‰å…¨çš„å¯†ç å“ˆå¸Œå‡½æ•°"""
    # ä½¿ç”¨SHA256å“ˆå¸Œ
    hashed = hashlib.sha256(password.encode()).hexdigest()
    
    # å¯é€‰ï¼šæ·»åŠ ç›å€¼ï¼ˆå®é™…å®ç°ä¸­åº”ä½¿ç”¨éšæœºç›ï¼‰
    salted_hash = hashlib.sha256((hashed + "random_salt").encode()).hexdigest()
    
    return salted_hash
```

### è®¿é—®æ§åˆ¶

#### ç½‘ç»œå®‰å…¨

1. **HTTPSåè®®**: ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨HTTPS
2. **é˜²ç«å¢™é…ç½®**: é™åˆ¶è®¿é—®ç«¯å£
3. **IPç™½åå•**: å¯é€‰çš„IPè®¿é—®æ§åˆ¶
4. **DDoSé˜²æŠ¤**: éƒ¨ç½²é€‚å½“çš„é˜²æŠ¤æªæ–½

#### æ–‡ä»¶æƒé™

```bash
# è®¾ç½®ç”¨æˆ·é…ç½®æ–‡ä»¶æƒé™
chmod 600 web/config/users.json
chmod 700 web/config/

# è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™
chmod +x scripts/user_password_manager.py
chmod +x scripts/user_manager.bat
chmod +x scripts/user_manager.ps1
```

### ç›‘æ§å’Œå®¡è®¡

#### å…³é”®ç›‘æ§æŒ‡æ ‡

| ç›‘æ§é¡¹ç›® | é˜ˆå€¼ | å‘Šè­¦æ¡ä»¶ |
|----------|------|----------|
| ç™»å½•å¤±è´¥ç‡ | < 5% | è¿ç»­3æ¬¡å¤±è´¥ |
| å¼‚å¸¸ç™»å½•æ—¶é—´ | - | éå·¥ä½œæ—¶é—´ç™»å½• |
| æƒé™æ»¥ç”¨ | - | è¶…çº§æƒé™é¢‘ç¹ä½¿ç”¨ |
| å¹¶å‘ç”¨æˆ·æ•° | < 100 | è¶…è¿‡ç³»ç»Ÿå®¹é‡ |

#### å®¡è®¡æ—¥å¿—

```python
# å®¡è®¡æ—¥å¿—ç¤ºä¾‹
audit_log = {
    "timestamp": time.time(),
    "event_type": "security_audit",
    "severity": "high",
    "message": "æ£€æµ‹åˆ°å¼‚å¸¸ç™»å½•è¡Œä¸º",
    "details": {
        "username": "admin",
        "ip_address": "192.168.1.100",
        "location": "æœªçŸ¥åœ°åŒº",
        "risk_score": 85
    }
}
```

### å¤‡ä»½å’Œæ¢å¤

#### é…ç½®å¤‡ä»½

```bash
#!/bin/bash
# ç”¨æˆ·é…ç½®å¤‡ä»½è„šæœ¬

BACKUP_DIR="backup/user_configs"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# å¤‡ä»½ç”¨æˆ·é…ç½®æ–‡ä»¶
cp web/config/users.json "$BACKUP_DIR/users_backup_$DATE.json"

# å¤‡ä»½æ´»åŠ¨æ—¥å¿—
tar -czf "$BACKUP_DIR/activity_logs_$DATE.tar.gz" web/data/user_activities/

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
```

#### æ¢å¤æ“ä½œ

```bash
#!/bin/bash
# ç”¨æˆ·é…ç½®æ¢å¤è„šæœ¬

BACKUP_FILE="$1"

if [ -z "$BACKUP_FILE" ]; then
    echo "ç”¨æ³•: $0 <å¤‡ä»½æ–‡ä»¶>"
    exit 1
fi

# åœæ­¢WebæœåŠ¡
# systemctl stop tradingagents-web

# æ¢å¤é…ç½®æ–‡ä»¶
cp "$BACKUP_FILE" web/config/users.json

# é‡å¯WebæœåŠ¡
# systemctl start tradingagents-web

echo "é…ç½®æ¢å¤å®Œæˆ"
```

**ç« èŠ‚æºæ–‡ä»¶**
- [USER_MANAGEMENT.md](file://scripts/USER_MANAGEMENT.md#L100-L130)
- [auth_manager.py](file://web/utils/auth_manager.py#L159-L198)

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. æ‰¾ä¸åˆ°Python

**é—®é¢˜**: æ‰§è¡Œè„šæœ¬æ—¶æç¤ºæ‰¾ä¸åˆ°Python

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥Pythonæ˜¯å¦å®‰è£…
python --version

# å¦‚æœæœªå®‰è£…ï¼Œä¸‹è½½å¹¶å®‰è£…Python 3.8+

# æ·»åŠ åˆ°ç³»ç»ŸPATHï¼ˆWindowsï¼‰
set PATH=%PATH%;C:\Python39\;C:\Python39\Scripts\

# éªŒè¯PATHè®¾ç½®
echo %PATH%
```

#### 2. æƒé™é”™è¯¯

**é—®é¢˜**: Windowsä¸Šæ— æ³•è¿è¡Œæ‰¹å¤„ç†æˆ–PowerShellè„šæœ¬

**è§£å†³æ–¹æ¡ˆ**:
```powershell
# ä¿®æ”¹PowerShellæ‰§è¡Œç­–ç•¥
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# æˆ–è€…ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
Run as Administrator
```

#### 3. é…ç½®æ–‡ä»¶ä¸å­˜åœ¨

**é—®é¢˜**: ç”¨æˆ·é…ç½®æ–‡ä»¶ä¸¢å¤±æˆ–æŸå

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ä½¿ç”¨é‡ç½®åŠŸèƒ½æ¢å¤é»˜è®¤é…ç½®
python scripts/user_password_manager.py reset

# æˆ–æ‰‹åŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶
cat > web/config/users.json << EOF
{
    "admin": {
        "password_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
        "role": "admin",
        "permissions": ["analysis", "config", "admin"],
        "created_at": 1640995200.123
    },
    "user": {
        "password_hash": "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
        "role": "user",
        "permissions": ["analysis"],
        "created_at": 1640995200.123
    }
}
EOF
```

#### 4. ä¼šè¯è¶…æ—¶é—®é¢˜

**é—®é¢˜**: ç”¨æˆ·é¢‘ç¹è¢«å¼ºåˆ¶ç™»å‡º

**è§£å†³æ–¹æ¡ˆ**:
```python
# ä¿®æ”¹ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆåœ¨auth_manager.pyä¸­ï¼‰
class AuthManager:
    def __init__(self):
        self.session_timeout = 1800000  # 30åˆ†é’Ÿ
```

#### 5. å‰ç«¯ç¼“å­˜é—®é¢˜

**é—®é¢˜**: ç™»å½•çŠ¶æ€æ— æ³•æŒä¹…åŒ–

**è§£å†³æ–¹æ¡ˆ**:
```javascript
// æ£€æŸ¥æµè§ˆå™¨Cookieå’ŒLocalStorage
console.log('LocalStorage:', localStorage.getItem('tradingagents_auth'));
console.log('Cookies:', document.cookie);

// æ¸…é™¤ç¼“å­˜åé‡è¯•
localStorage.removeItem('tradingagents_auth');
localStorage.removeItem('tradingagents_last_activity');
```

### è°ƒè¯•æŠ€å·§

#### 1. å¯ç”¨è¯¦ç»†æ—¥å¿—

```python
# åœ¨auth_manager.pyä¸­å¯ç”¨è°ƒè¯•æ¨¡å¼
import logging
logging.basicConfig(level=logging.DEBUG)
```

#### 2. æ£€æŸ¥é…ç½®æ–‡ä»¶

```bash
# éªŒè¯JSONæ ¼å¼
python -m json.tool web/config/users.json

# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la web/config/users.json
```

#### 3. æµ‹è¯•è¿æ¥

```python
# æµ‹è¯•è®¤è¯åŠŸèƒ½
from web.utils.auth_manager import auth_manager

# æµ‹è¯•ç™»å½•
result = auth_manager.authenticate("admin", "admin123")
print(f"è®¤è¯ç»“æœ: {result}")

# æ£€æŸ¥æƒé™
has_permission = auth_manager.check_permission("admin")
print(f"ç®¡ç†å‘˜æƒé™: {has_permission}")
```

### æ€§èƒ½ä¼˜åŒ–

#### 1. ç¼“å­˜ä¼˜åŒ–

```python
# ä¼˜åŒ–ç”¨æˆ·é…ç½®åŠ è½½
class OptimizedAuthManager(AuthManager):
    def __init__(self):
        super().__init__()
        self._user_cache = None
        self._cache_timestamp = 0
    
    def _load_users(self):
        # å®ç°ç¼“å­˜æœºåˆ¶
        current_time = time.time()
        if self._user_cache is None or (current_time - self._cache_timestamp) > 60:
            self._user_cache = super()._load_users()
            self._cache_timestamp = current_time
        return self._user_cache
```

#### 2. å¹¶å‘å¤„ç†

```python
# ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†å¤§é‡ç”¨æˆ·æ“ä½œ
from concurrent.futures import ThreadPoolExecutor

def batch_process_users(user_operations):
    with ThreadPoolExecutor(max_workers=5) as executor:
        futures = []
        for op in user_operations:
            future = executor.submit(op['func'], *op['args'])
            futures.append(future)
        
        results = []
        for future in futures:
            try:
                results.append(future.result())
            except Exception as e:
                results.append({'error': str(e)})
        
        return results
```

**ç« èŠ‚æºæ–‡ä»¶**
- [USER_MANAGEMENT.md](file://scripts/USER_MANAGEMENT.md#L130-L161)
- [auth_manager.py](file://web/utils/auth_manager.py#L159-L198)