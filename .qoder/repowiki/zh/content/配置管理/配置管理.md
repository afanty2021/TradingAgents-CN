# é…ç½®ç®¡ç†

<cite>
**æœ¬æ–‡æ¡£å¼•ç”¨çš„æ–‡ä»¶**
- [logging.toml](file://config/logging.toml)
- [logging_docker.toml](file://config/logging_docker.toml)
- [default_config.py](file://tradingagents/default_config.py)
- [config_manager.py](file://tradingagents/config/config_manager.py)
- [env_utils.py](file://tradingagents/config/env_utils.py)
- [database_config.py](file://tradingagents/config/database_config.py)
- [tushare_config.py](file://tradingagents/config/tushare_config.py)
- [config.py](file://tradingagents/dataflows/config.py)
- [config_management.py](file://web/modules/config_management.py)
- [token_statistics.py](file://web/modules/token_statistics.py)
</cite>

## ç›®å½•
1. [é…ç½®ä½“ç³»æ¦‚è¿°](#é…ç½®ä½“ç³»æ¦‚è¿°)
2. [æ ¸å¿ƒé…ç½®æ–‡ä»¶](#æ ¸å¿ƒé…ç½®æ–‡ä»¶)
3. [ç¯å¢ƒå˜é‡ä½¿ç”¨](#ç¯å¢ƒå˜é‡ä½¿ç”¨)
4. [é…ç½®åŠ è½½æµç¨‹](#é…ç½®åŠ è½½æµç¨‹)
5. [æ—¥å¿—é…ç½®ç®¡ç†](#æ—¥å¿—é…ç½®ç®¡ç†)
6. [LLMä¸æˆæœ¬é…ç½®](#llmä¸æˆæœ¬é…ç½®)
7. [æ•°æ®æºä¸ç¼“å­˜é…ç½®](#æ•°æ®æºä¸ç¼“å­˜é…ç½®)
8. [æ•°æ®åº“é…ç½®](#æ•°æ®åº“é…ç½®)
9. [Webç•Œé¢é…ç½®ç®¡ç†](#webç•Œé¢é…ç½®ç®¡ç†)
10. [é…ç½®éªŒè¯ä¸æœ€ä½³å®è·µ](#é…ç½®éªŒè¯ä¸æœ€ä½³å®è·µ)

## é…ç½®ä½“ç³»æ¦‚è¿°

äº¤æ˜“ä»£ç†ç³»ç»Ÿçš„é…ç½®ç®¡ç†ä½“ç³»é‡‡ç”¨å¤šå±‚æ¶æ„è®¾è®¡ï¼Œé€šè¿‡å¤šç§é…ç½®æºå’Œä¼˜å…ˆçº§è§„åˆ™ç¡®ä¿ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ç³»ç»Ÿé…ç½®ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒç»„ä»¶æ„æˆï¼š

1. **é»˜è®¤é…ç½®**ï¼šåœ¨ `default_config.py` ä¸­å®šä¹‰çš„é»˜è®¤é…ç½®ï¼Œä¸ºç³»ç»Ÿæä¾›åŸºç¡€è®¾ç½®
2. **JSONé…ç½®æ–‡ä»¶**ï¼šå­˜å‚¨åœ¨ `config/` ç›®å½•ä¸‹çš„ JSON æ–‡ä»¶ï¼Œç”¨äºæŒä¹…åŒ–å­˜å‚¨æ¨¡å‹ã€å®šä»·å’Œä½¿ç”¨è®°å½•
3. **ç¯å¢ƒå˜é‡**ï¼šé€šè¿‡ `.env` æ–‡ä»¶æˆ–ç³»ç»Ÿç¯å¢ƒå˜é‡æä¾›æ•æ„Ÿä¿¡æ¯å’Œè¿è¡Œæ—¶é…ç½®
4. **Webç•Œé¢é…ç½®**ï¼šé€šè¿‡ Streamlit Web ç•Œé¢æä¾›çš„å¯è§†åŒ–é…ç½®ç®¡ç†
5. **è¿è¡Œæ—¶é…ç½®**ï¼šåœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆå’Œè°ƒæ•´çš„é…ç½®

é…ç½®ä½“ç³»éµå¾ª"ç¯å¢ƒå˜é‡ > Webç•Œé¢ > JSONé…ç½®æ–‡ä»¶ > é»˜è®¤é…ç½®"çš„ä¼˜å…ˆçº§è§„åˆ™ï¼Œç¡®ä¿å…³é”®é…ç½®å¯ä»¥è¢«çµæ´»è¦†ç›–ã€‚

**Section sources**
- [default_config.py](file://tradingagents/default_config.py)
- [config_manager.py](file://tradingagents/config/config_manager.py)

## æ ¸å¿ƒé…ç½®æ–‡ä»¶

### default_config.py

`default_config.py` æ–‡ä»¶å®šä¹‰äº†ç³»ç»Ÿçš„é»˜è®¤é…ç½®ï¼ŒåŒ…å«é¡¹ç›®ç›®å½•ã€æ•°æ®ç›®å½•ã€ç»“æœç›®å½•ç­‰åŸºç¡€è·¯å¾„è®¾ç½®ï¼Œä»¥åŠLLMç›¸å…³é…ç½®ã€‚

```python
DEFAULT_CONFIG = {
    "project_dir": os.path.abspath(os.path.join(os.path.dirname(__file__), ".")),
    "results_dir": os.getenv("TRADINGAGENTS_RESULTS_DIR", "./results"),
    "data_dir": os.path.join(os.path.expanduser("~"), "Documents", "TradingAgents", "data"),
    "data_cache_dir": os.path.join(
        os.path.abspath(os.path.join(os.path.dirname(__file__), ".")),
        "dataflows/data_cache",
    ),
    # LLM settings
    "llm_provider": "openai",
    "deep_think_llm": "o4-mini",
    "quick_think_llm": "gpt-4o-mini",
    "backend_url": "https://api.openai.com/v1",
    # Debate and discussion settings
    "max_debate_rounds": 1,
    "max_risk_discuss_rounds": 1,
    "max_recur_limit": 100,
    # Tool settings - ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œæä¾›é»˜è®¤å€¼
    "online_tools": os.getenv("ONLINE_TOOLS_ENABLED", "false").lower() == "true",
    "online_news": os.getenv("ONLINE_NEWS_ENABLED", "true").lower() == "true", 
    "realtime_data": os.getenv("REALTIME_DATA_ENABLED", "false").lower() == "true",
}
```

è¯¥é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„è®¾ç½®ä¼šä¼˜å…ˆä»ç¯å¢ƒå˜é‡è·å–ï¼Œå¦‚æœç¯å¢ƒå˜é‡æœªè®¾ç½®åˆ™ä½¿ç”¨é»˜è®¤å€¼ã€‚

**Section sources**
- [default_config.py](file://tradingagents/default_config.py)

### config_manager.py

`config_manager.py` æ˜¯é…ç½®ç®¡ç†çš„æ ¸å¿ƒæ¨¡å—ï¼Œè´Ÿè´£ç®¡ç†APIå¯†é’¥ã€æ¨¡å‹é…ç½®ã€è´¹ç‡è®¾ç½®ç­‰ã€‚å®ƒé€šè¿‡ `ConfigManager` ç±»æä¾›ç»Ÿä¸€çš„é…ç½®ç®¡ç†æ¥å£ã€‚

```mermaid
classDiagram
class ConfigManager {
+config_dir Path
+models_file Path
+pricing_file Path
+usage_file Path
+settings_file Path
+mongodb_storage MongoDBStorage
-_load_env_file() void
-_get_env_api_key(provider) str
-_init_mongodb_storage() void
-_init_default_configs() void
+load_models() List[ModelConfig]
+save_models(models) void
+load_pricing() List[PricingConfig]
+save_pricing(pricing) void
+load_usage_records() List[UsageRecord]
+save_usage_records(records) void
+add_usage_record(provider, model_name, input_tokens, output_tokens, session_id, analysis_type) UsageRecord
+calculate_cost(provider, model_name, input_tokens, output_tokens) float
+load_settings() Dict[str, Any]
+save_settings(settings) void
+get_enabled_models() List[ModelConfig]
+get_model_by_name(provider, model_name) Optional[ModelConfig]
+get_usage_statistics(days) Dict[str, Any]
+get_data_dir() str
+set_data_dir(data_dir) void
+ensure_directories_exist() void
+set_openai_enabled(enabled) void
+is_openai_enabled() bool
+get_openai_config_status() Dict[str, Any]
}
class ModelConfig {
+provider str
+model_name str
+api_key str
+base_url Optional[str]
+max_tokens int
+temperature float
+enabled bool
}
class PricingConfig {
+provider str
+model_name str
+input_price_per_1k float
+output_price_per_1k float
+currency str
}
class UsageRecord {
+timestamp str
+provider str
+model_name str
+input_tokens int
+output_tokens int
+cost float
+session_id str
+analysis_type str
}
ConfigManager --> ModelConfig : "åŒ…å«"
ConfigManager --> PricingConfig : "åŒ…å«"
ConfigManager --> UsageRecord : "åŒ…å«"
```

**Diagram sources**
- [config_manager.py](file://tradingagents/config/config_manager.py)

**Section sources**
- [config_manager.py](file://tradingagents/config/config_manager.py)

## ç¯å¢ƒå˜é‡ä½¿ç”¨

### ç¯å¢ƒå˜é‡è§£æå·¥å…·

`env_utils.py` æ¨¡å—æä¾›äº†å¼ºå¤§çš„ç¯å¢ƒå˜é‡è§£æåŠŸèƒ½ï¼Œæ”¯æŒå¤šç§æ•°æ®ç±»å‹çš„è§£æï¼Œç¡®ä¿é…ç½®çš„çµæ´»æ€§å’Œå…¼å®¹æ€§ã€‚

```python
def parse_bool_env(env_var: str, default: bool = False) -> bool:
    """
    è§£æå¸ƒå°”ç±»å‹ç¯å¢ƒå˜é‡ï¼Œå…¼å®¹å¤šç§æ ¼å¼
    
    æ”¯æŒçš„æ ¼å¼ï¼š
    - true/True/TRUE
    - false/False/FALSE  
    - 1/0
    - yes/Yes/YES
    - no/No/NO
    - on/On/ON
    - off/Off/OFF
    """
    pass

def parse_int_env(env_var: str, default: int = 0) -> int:
    """è§£ææ•´æ•°ç±»å‹ç¯å¢ƒå˜é‡"""
    pass

def parse_float_env(env_var: str, default: float = 0.0) -> float:
    """è§£ææµ®ç‚¹æ•°ç±»å‹ç¯å¢ƒå˜é‡"""
    pass

def parse_str_env(env_var: str, default: str = "") -> str:
    """è§£æå­—ç¬¦ä¸²ç±»å‹ç¯å¢ƒå˜é‡"""
    pass

def parse_list_env(env_var: str, separator: str = ",", default: Optional[list] = None) -> list:
    """è§£æåˆ—è¡¨ç±»å‹ç¯å¢ƒå˜é‡"""
    pass
```

è¿™äº›å·¥å…·å‡½æ•°ç¡®ä¿äº†ç¯å¢ƒå˜é‡çš„è§£æå…·æœ‰é«˜åº¦çš„å®¹é”™æ€§å’Œå…¼å®¹æ€§ï¼Œæ”¯æŒPython 3.13+ç‰ˆæœ¬ã€‚

**Section sources**
- [env_utils.py](file://tradingagents/config/env_utils.py)

### ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§è§„åˆ™

ç³»ç»Ÿéµå¾ªä¸¥æ ¼çš„ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§è§„åˆ™ï¼Œç¡®ä¿å…³é”®é…ç½®å¯ä»¥è¢«æ­£ç¡®è¦†ç›–ï¼š

1. **æœ€é«˜ä¼˜å…ˆçº§**ï¼šç¯å¢ƒå˜é‡ï¼ˆåŒ…æ‹¬ `.env` æ–‡ä»¶å’Œç³»ç»Ÿç¯å¢ƒå˜é‡ï¼‰
2. **ä¸­ç­‰ä¼˜å…ˆçº§**ï¼šWebç•Œé¢é…ç½®
3. **è¾ƒä½ä¼˜å…ˆçº§**ï¼šJSONé…ç½®æ–‡ä»¶
4. **æœ€ä½ä¼˜å…ˆçº§**ï¼šé»˜è®¤é…ç½®

è¿™ç§ä¼˜å…ˆçº§è®¾è®¡å…è®¸ç”¨æˆ·é€šè¿‡ç¯å¢ƒå˜é‡å¿«é€Ÿè¦†ç›–é…ç½®ï¼ŒåŒæ—¶ä¿ç•™æŒä¹…åŒ–çš„é…ç½®æ–‡ä»¶ä½œä¸ºå¤‡ä»½ã€‚

```mermaid
flowchart TD
Start([é…ç½®åŠ è½½å¼€å§‹]) --> CheckEnv["æ£€æŸ¥ç¯å¢ƒå˜é‡"]
CheckEnv --> EnvExists{"ç¯å¢ƒå˜é‡å­˜åœ¨?"}
EnvExists --> |æ˜¯| UseEnv["ä½¿ç”¨ç¯å¢ƒå˜é‡å€¼"]
EnvExists --> |å¦| CheckWeb["æ£€æŸ¥Webç•Œé¢é…ç½®"]
CheckWeb --> WebExists{"Webé…ç½®å­˜åœ¨?"}
WebExists --> |æ˜¯| UseWeb["ä½¿ç”¨Webé…ç½®å€¼"]
WebExists --> |å¦| CheckJSON["æ£€æŸ¥JSONé…ç½®æ–‡ä»¶"]
CheckJSON --> JSONExists{"JSONæ–‡ä»¶å­˜åœ¨?"}
JSONExists --> |æ˜¯| UseJSON["ä½¿ç”¨JSONé…ç½®å€¼"]
JSONExists --> |å¦| UseDefault["ä½¿ç”¨é»˜è®¤é…ç½®"]
UseEnv --> End([é…ç½®åŠ è½½å®Œæˆ])
UseWeb --> End
UseJSON --> End
UseDefault --> End
```

**Diagram sources**
- [env_utils.py](file://tradingagents/config/env_utils.py)
- [config_manager.py](file://tradingagents/config/config_manager.py)

## é…ç½®åŠ è½½æµç¨‹

### é…ç½®åˆå§‹åŒ–æµç¨‹

ç³»ç»Ÿçš„é…ç½®åŠ è½½æµç¨‹éµå¾ªç‰¹å®šçš„é¡ºåºï¼Œç¡®ä¿æ‰€æœ‰é…ç½®é¡¹éƒ½èƒ½è¢«æ­£ç¡®åˆå§‹åŒ–ã€‚

```mermaid
sequenceDiagram
participant App as "åº”ç”¨ç¨‹åº"
participant ConfigManager as "ConfigManager"
participant Env as "ç¯å¢ƒå˜é‡"
participant JSON as "JSONæ–‡ä»¶"
participant Web as "Webç•Œé¢"
App->>ConfigManager : åˆå§‹åŒ–ConfigManager
ConfigManager->>Env : åŠ è½½.envæ–‡ä»¶
Env-->>ConfigManager : è¿”å›ç¯å¢ƒå˜é‡
ConfigManager->>JSON : æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
JSON-->>ConfigManager : è¿”å›æ–‡ä»¶çŠ¶æ€
alt é…ç½®æ–‡ä»¶ä¸å­˜åœ¨
ConfigManager->>ConfigManager : åˆå§‹åŒ–é»˜è®¤é…ç½®
ConfigManager->>JSON : åˆ›å»ºå¹¶ä¿å­˜é»˜è®¤é…ç½®
else é…ç½®æ–‡ä»¶å­˜åœ¨
ConfigManager->>JSON : åŠ è½½ç°æœ‰é…ç½®
end
ConfigManager->>Env : åˆå¹¶ç¯å¢ƒå˜é‡é…ç½®
Env-->>ConfigManager : è¿”å›åˆå¹¶åçš„é…ç½®
ConfigManager->>Web : å‡†å¤‡Webç•Œé¢é…ç½®
Web-->>ConfigManager : è¿”å›Webé…ç½®çŠ¶æ€
ConfigManager-->>App : è¿”å›åˆå§‹åŒ–å®Œæˆçš„é…ç½®ç®¡ç†å™¨
```

**Diagram sources**
- [config_manager.py](file://tradingagents/config/config_manager.py)

### é…ç½®åŠ è½½é¡ºåº

é…ç½®åŠ è½½çš„å…·ä½“é¡ºåºå¦‚ä¸‹ï¼š

1. **åŠ è½½ç¯å¢ƒå˜é‡**ï¼šé¦–å…ˆä» `.env` æ–‡ä»¶å’Œç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­åŠ è½½é…ç½®
2. **æ£€æŸ¥é…ç½®æ–‡ä»¶**ï¼šæ£€æŸ¥ `config/` ç›®å½•ä¸‹çš„ JSON é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
3. **åˆå§‹åŒ–é»˜è®¤é…ç½®**ï¼šå¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
4. **åŠ è½½ç°æœ‰é…ç½®**ï¼šå¦‚æœé…ç½®æ–‡ä»¶å­˜åœ¨ï¼ŒåŠ è½½å…¶ä¸­çš„é…ç½®
5. **åˆå¹¶ç¯å¢ƒå˜é‡**ï¼šå°†ç¯å¢ƒå˜é‡ä¸­çš„é…ç½®ä¸æ–‡ä»¶é…ç½®åˆå¹¶
6. **è¿”å›é…ç½®å®ä¾‹**ï¼šè¿”å›åˆå§‹åŒ–å®Œæˆçš„é…ç½®ç®¡ç†å™¨å®ä¾‹

è¿™ç§åŠ è½½é¡ºåºç¡®ä¿äº†å³ä½¿åœ¨æ²¡æœ‰é…ç½®æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚

**Section sources**
- [config_manager.py](file://tradingagents/config/config_manager.py)

## æ—¥å¿—é…ç½®ç®¡ç†

### logging.toml é…ç½®æ–‡ä»¶

`logging.toml` æ–‡ä»¶å®šä¹‰äº†ç³»ç»Ÿçš„æ—¥å¿—é…ç½®ï¼Œæ”¯æŒä¸åŒç¯å¢ƒçš„æ—¥å¿—è®¾ç½®ã€‚

```toml
[logging]
# å…¨å±€æ—¥å¿—çº§åˆ«ï¼šDEBUG, INFO, WARNING, ERROR, CRITICAL
level = "INFO"

# æ—¥å¿—æ ¼å¼é…ç½®
[logging.format]
console = "%(asctime)s | %(name)-20s | %(levelname)-8s | %(message)s"
file = "%(asctime)s | %(name)-20s | %(levelname)-8s | %(module)s:%(funcName)s:%(lineno)d | %(message)s"
structured = "json"

# å¤„ç†å™¨é…ç½®
[logging.handlers]

# æ§åˆ¶å°å¤„ç†å™¨
[logging.handlers.console]
enabled = true
colored = true  # æ˜¯å¦å¯ç”¨å½©è‰²è¾“å‡º
level = "INFO"

# æ–‡ä»¶å¤„ç†å™¨
[logging.handlers.file]
enabled = true
level = "DEBUG"
max_size = "10MB"
backup_count = 5
directory = "./logs"

# ç»“æ„åŒ–æ—¥å¿—å¤„ç†å™¨ï¼ˆJSONæ ¼å¼ï¼‰
[logging.handlers.structured]
enabled = false  # é»˜è®¤å…³é—­ï¼Œç”Ÿäº§ç¯å¢ƒå¯å¯ç”¨
level = "INFO"
directory = "./logs"
```

**Section sources**
- [logging.toml](file://config/logging.toml)

### logging_docker.toml é…ç½®æ–‡ä»¶

`logging_docker.toml` æ˜¯ä¸“é—¨ä¸ºDockerç¯å¢ƒè®¾è®¡çš„æ—¥å¿—é…ç½®æ–‡ä»¶ï¼Œè§£å†³äº†åœ¨å®¹å™¨åŒ–ç¯å¢ƒä¸­æ—¥å¿—è¾“å‡ºçš„é—®é¢˜ã€‚

```toml
[logging]
level = "INFO"

[logging.format]
# å¿…é¡»åŒ…å«æ‰€æœ‰æ ¼å¼é…ç½®
console = "%(asctime)s | %(levelname)-8s | %(name)s | %(message)s"
file = "%(asctime)s | %(name)-20s | %(levelname)-8s | %(module)s:%(funcName)s:%(lineno)d | %(message)s"
structured = "json"

[logging.handlers]

# æ§åˆ¶å°è¾“å‡º
[logging.handlers.console]
enabled = true
colored = false
level = "INFO"

# æ–‡ä»¶è¾“å‡º - å®Œæ•´é…ç½®
[logging.handlers.file]
enabled = true
level = "DEBUG"
max_size = "100MB"
backup_count = 5
directory = "/app/logs"

# ç»“æ„åŒ–æ—¥å¿—
[logging.handlers.structured]
enabled = true
level = "INFO"
directory = "/app/logs"
```

**Section sources**
- [logging_docker.toml](file://config/logging_docker.toml)

### æ—¥å¿—é…ç½®ç»“æ„

```mermaid
erDiagram
LOGGING_CONFIG {
string level PK
string format_console
string format_file
string format_structured
boolean handlers_console_enabled
boolean handlers_console_colored
string handlers_console_level
boolean handlers_file_enabled
string handlers_file_level
string handlers_file_max_size
int handlers_file_backup_count
string handlers_file_directory
boolean handlers_structured_enabled
string handlers_structured_level
string handlers_structured_directory
}
LOGGING_LOGGERS {
string logger_name PK
string level
}
LOGGING_ENVIRONMENTS {
string environment_name PK
boolean enabled
string config_details
}
LOGGING_PERFORMANCE {
boolean enabled
boolean log_slow_operations
float slow_threshold_seconds
boolean log_memory_usage
}
LOGGING_SECURITY {
boolean enabled
boolean log_api_calls
boolean log_token_usage
boolean mask_sensitive_data
}
LOGGING_BUSINESS {
boolean enabled
boolean log_analysis_events
boolean log_user_actions
boolean log_export_events
}
LOGGING_CONFIG ||--o{ LOGGING_LOGGERS : "åŒ…å«"
LOGGING_CONFIG ||--o{ LOGGING_ENVIRONMENTS : "åŒ…å«"
LOGGING_CONFIG ||--o{ LOGGING_PERFORMANCE : "åŒ…å«"
LOGGING_CONFIG ||--o{ LOGGING_SECURITY : "åŒ…å«"
LOGGING_CONFIG ||--o{ LOGGING_BUSINESS : "åŒ…å«"
```

**Diagram sources**
- [logging.toml](file://config/logging.toml)
- [logging_docker.toml](file://config/logging_docker.toml)

## LLMä¸æˆæœ¬é…ç½®

### æ¨¡å‹é…ç½®

ç³»ç»Ÿæ”¯æŒå¤šç§LLMæä¾›å•†ï¼ŒåŒ…æ‹¬é˜¿é‡Œç™¾ç‚¼ã€OpenAIã€Googleç­‰ã€‚æ¨¡å‹é…ç½®å­˜å‚¨åœ¨ `config/models.json` æ–‡ä»¶ä¸­ã€‚

```python
@dataclass
class ModelConfig:
    """æ¨¡å‹é…ç½®"""
    provider: str  # ä¾›åº”å•†ï¼šdashscope, openai, google, etc.
    model_name: str  # æ¨¡å‹åç§°
    api_key: str  # APIå¯†é’¥
    base_url: Optional[str] = None  # è‡ªå®šä¹‰APIåœ°å€
    max_tokens: int = 4000  # æœ€å¤§tokenæ•°
    temperature: float = 0.7  # æ¸©åº¦å‚æ•°
    enabled: bool = True  # æ˜¯å¦å¯ç”¨
```

ç³»ç»Ÿä¼šä¼˜å…ˆä»ç¯å¢ƒå˜é‡ä¸­è·å–APIå¯†é’¥ï¼Œç¡®ä¿æ•æ„Ÿä¿¡æ¯çš„å®‰å…¨æ€§ã€‚

**Section sources**
- [config_manager.py](file://tradingagents/config/config_manager.py)

### å®šä»·é…ç½®

å®šä»·é…ç½®ç”¨äºè®¡ç®—LLMè°ƒç”¨çš„æˆæœ¬ï¼Œæ”¯æŒå¤šç§è´§å¸å•ä½ã€‚

```python
@dataclass
class PricingConfig:
    """å®šä»·é…ç½®"""
    provider: str  # ä¾›åº”å•†
    model_name: str  # æ¨¡å‹åç§°
    input_price_per_1k: float  # è¾“å…¥tokenä»·æ ¼ï¼ˆæ¯1000ä¸ªtokenï¼‰
    output_price_per_1k: float  # è¾“å‡ºtokenä»·æ ¼ï¼ˆæ¯1000ä¸ªtokenï¼‰
    currency: str = "CNY"  # è´§å¸å•ä½
```

ç³»ç»Ÿå†…ç½®äº†ä¸»æµLLMæä¾›å•†çš„é»˜è®¤å®šä»·ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®å®é™…ä»·æ ¼è¿›è¡Œè°ƒæ•´ã€‚

**Section sources**
- [config_manager.py](file://tradingagents/config/config_manager.py)

### æˆæœ¬è·Ÿè¸ª

ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„æˆæœ¬è·Ÿè¸ªåŠŸèƒ½ï¼Œå¯ä»¥è®°å½•æ¯æ¬¡LLMè°ƒç”¨çš„tokenä½¿ç”¨æƒ…å†µå’Œæˆæœ¬ã€‚

```python
@dataclass
class UsageRecord:
    """ä½¿ç”¨è®°å½•"""
    timestamp: str  # æ—¶é—´æˆ³
    provider: str  # ä¾›åº”å•†
    model_name: str  # æ¨¡å‹åç§°
    input_tokens: int  # è¾“å…¥tokenæ•°
    output_tokens: int  # è¾“å‡ºtokenæ•°
    cost: float  # æˆæœ¬
    session_id: str  # ä¼šè¯ID
    analysis_type: str  # åˆ†æç±»å‹
```

æˆæœ¬è·Ÿè¸ªæ•°æ®å¯ä»¥å­˜å‚¨åœ¨MongoDBæˆ–JSONæ–‡ä»¶ä¸­ï¼Œæ”¯æŒè¯¦ç»†çš„ç»Ÿè®¡åˆ†æã€‚

**Section sources**
- [config_manager.py](file://tradingagents/config/config_manager.py)

## æ•°æ®æºä¸ç¼“å­˜é…ç½®

### æ•°æ®æºé…ç½®

`dataflows/config.py` æ–‡ä»¶ç®¡ç†æ•°æ®æµç›¸å…³çš„é…ç½®ï¼ŒåŒ…æ‹¬æ•°æ®ç›®å½•ã€ç¼“å­˜ç›®å½•ç­‰ã€‚

```python
def initialize_config():
    """Initialize the configuration with default values."""
    global _config, DATA_DIR
    if _config is None:
        # ä¼˜å…ˆä½¿ç”¨é…ç½®ç®¡ç†å™¨çš„è®¾ç½®
        settings = config_manager.load_settings()
        _config = default_config.DEFAULT_CONFIG.copy()
        
        # å¦‚æœé…ç½®ç®¡ç†å™¨ä¸­æœ‰æ•°æ®ç›®å½•è®¾ç½®ï¼Œä½¿ç”¨å®ƒ
        if settings.get("data_dir"):
            _config["data_dir"] = settings["data_dir"]
        
        DATA_DIR = _config["data_dir"]
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        config_manager.ensure_directories_exist()

def get_config() -> Dict:
    """Get the current configuration."""
    if _config is None:
        initialize_config()

    # åŠ¨æ€è·å–æœ€æ–°çš„æ•°æ®ç›®å½•é…ç½®
    current_data_dir = config_manager.get_data_dir()
    if _config["data_dir"] != current_data_dir:
        _config["data_dir"] = current_data_dir
        global DATA_DIR
        DATA_DIR = current_data_dir

    config_copy = _config.copy()
    return config_copy
```

**Section sources**
- [config.py](file://tradingagents/dataflows/config.py)

### æ•°æ®æºä¼˜å…ˆçº§

ç³»ç»Ÿå®ç°äº†æ™ºèƒ½çš„æ•°æ®æºä¼˜å…ˆçº§ç®¡ç†ï¼Œç¡®ä¿åœ¨ä¸»è¦æ•°æ®æºä¸å¯ç”¨æ—¶èƒ½å¤Ÿè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®æºã€‚

```mermaid
flowchart TD
Start([è·å–æ•°æ®å¼€å§‹]) --> CheckPrimary["æ£€æŸ¥ä¸»æ•°æ®æº"]
CheckPrimary --> PrimaryAvailable{"ä¸»æ•°æ®æºå¯ç”¨?"}
PrimaryAvailable --> |æ˜¯| UsePrimary["ä½¿ç”¨ä¸»æ•°æ®æº"]
PrimaryAvailable --> |å¦| CheckFallback["æ£€æŸ¥å¤‡ç”¨æ•°æ®æº"]
CheckFallback --> FallbackAvailable{"å¤‡ç”¨æ•°æ®æºå¯ç”¨?"}
FallbackAvailable --> |æ˜¯| UseFallback["ä½¿ç”¨å¤‡ç”¨æ•°æ®æº"]
FallbackAvailable --> |å¦| ReturnError["è¿”å›é”™è¯¯"]
UsePrimary --> End([æ•°æ®è·å–å®Œæˆ])
UseFallback --> End
ReturnError --> End
```

**Diagram sources**
- [config.py](file://tradingagents/dataflows/config.py)

## æ•°æ®åº“é…ç½®

### database_config.py

`database_config.py` æ¨¡å—ç»Ÿä¸€ç®¡ç†MongoDBå’ŒRedisçš„è¿æ¥é…ç½®ã€‚

```python
class DatabaseConfig:
    """æ•°æ®åº“é…ç½®ç®¡ç†ç±»"""
    
    @staticmethod
    def get_mongodb_config() -> Dict[str, Any]:
        """
        è·å–MongoDBé…ç½®
        
        Returns:
            Dict[str, Any]: MongoDBé…ç½®å­—å…¸
            
        Raises:
            ValueError: å½“å¿…è¦çš„é…ç½®æœªè®¾ç½®æ—¶
        """
        connection_string = os.getenv('MONGODB_CONNECTION_STRING')
        if not connection_string:
            raise ValueError(
                "MongoDBè¿æ¥å­—ç¬¦ä¸²æœªé…ç½®ã€‚è¯·è®¾ç½®ç¯å¢ƒå˜é‡ MONGODB_CONNECTION_STRING\n"
                "ä¾‹å¦‚: MONGODB_CONNECTION_STRING=mongodb://localhost:27017/"
            )
        
        return {
            'connection_string': connection_string,
            'database': os.getenv('MONGODB_DATABASE', 'tradingagents'),
            'auth_source': os.getenv('MONGODB_AUTH_SOURCE', 'admin')
        }
    
    @staticmethod
    def get_redis_config() -> Dict[str, Any]:
        """
        è·å–Redisé…ç½®
        
        Returns:
            Dict[str, Any]: Redisé…ç½®å­—å…¸
            
        Raises:
            ValueError: å½“å¿…è¦çš„é…ç½®æœªè®¾ç½®æ—¶
        """
        # ä¼˜å…ˆä½¿ç”¨è¿æ¥å­—ç¬¦ä¸²
        connection_string = os.getenv('REDIS_CONNECTION_STRING')
        if connection_string:
            return {
                'connection_string': connection_string,
                'database': int(os.getenv('REDIS_DATABASE', 0))
            }
        
        # ä½¿ç”¨åˆ†ç¦»çš„é…ç½®å‚æ•°
        host = os.getenv('REDIS_HOST')
        port = os.getenv('REDIS_PORT')
        
        if not host or not port:
            raise ValueError(
                "Redisè¿æ¥é…ç½®æœªå®Œæ•´è®¾ç½®ã€‚è¯·è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ä¹‹ä¸€ï¼š\n"
                "1. REDIS_CONNECTION_STRING=redis://localhost:6379/0\n"
                "2. REDIS_HOST + REDIS_PORT (ä¾‹å¦‚: REDIS_HOST=localhost, REDIS_PORT=6379)"
            )
        
        return {
            'host': host,
            'port': int(port),
            'password': os.getenv('REDIS_PASSWORD'),
            'database': int(os.getenv('REDIS_DATABASE', 0))
        }
```

**Section sources**
- [database_config.py](file://tradingagents/config/database_config.py)

### tushare_config.py

`tushare_config.py` æ¨¡å—ä¸“é—¨å¤„ç†Tushareç›¸å…³çš„ç¯å¢ƒå˜é‡é…ç½®ã€‚

```python
class TushareConfig:
    """Tushareé…ç½®ç®¡ç†å™¨"""
    
    def __init__(self):
        """åˆå§‹åŒ–Tushareé…ç½®"""
        self.load_config()
    
    def load_config(self):
        """åŠ è½½Tushareé…ç½®"""
        # å°è¯•åŠ è½½python-dotenv
        try:
            from dotenv import load_dotenv
            load_dotenv()
        except ImportError:
            pass
        
        # è§£æé…ç½®
        self.token = parse_str_env("TUSHARE_TOKEN", "")
        self.enabled = parse_bool_env("TUSHARE_ENABLED", False)
        self.default_source = parse_str_env("DEFAULT_CHINA_DATA_SOURCE", "akshare")
        
        # ç¼“å­˜é…ç½®
        self.cache_enabled = parse_bool_env("ENABLE_DATA_CACHE", True)
        self.cache_ttl_hours = parse_str_env("TUSHARE_CACHE_TTL_HOURS", "24")
```

**Section sources**
- [tushare_config.py](file://tradingagents/config/tushare_config.py)

## Webç•Œé¢é…ç½®ç®¡ç†

### config_management.py

`config_management.py` æ¨¡å—æä¾›äº†Webç•Œé¢çš„é…ç½®ç®¡ç†åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡Streamlitç•Œé¢ç›´è§‚åœ°ç®¡ç†å„ç§é…ç½®ã€‚

```python
def render_config_management():
    """æ¸²æŸ“é…ç½®ç®¡ç†é¡µé¢"""
    st.title("âš™ï¸ é…ç½®ç®¡ç†")

    # æ˜¾ç¤º.envé…ç½®çŠ¶æ€
    render_env_status()

    # ä¾§è¾¹æ é€‰æ‹©åŠŸèƒ½
    st.sidebar.title("é…ç½®é€‰é¡¹")
    page = st.sidebar.selectbox(
        "é€‰æ‹©åŠŸèƒ½",
        ["æ¨¡å‹é…ç½®", "å®šä»·è®¾ç½®", "ä½¿ç”¨ç»Ÿè®¡", "ç³»ç»Ÿè®¾ç½®"]
    )
    
    if page == "æ¨¡å‹é…ç½®":
        render_model_config()
    elif page == "å®šä»·è®¾ç½®":
        render_pricing_config()
    elif page == "ä½¿ç”¨ç»Ÿè®¡":
        render_usage_statistics()
    elif page == "ç³»ç»Ÿè®¾ç½®":
        render_system_settings()
```

**Section sources**
- [config_management.py](file://web/modules/config_management.py)

### token_statistics.py

`token_statistics.py` æ¨¡å—æä¾›äº†Tokenä½¿ç”¨ç»Ÿè®¡å’Œæˆæœ¬åˆ†æåŠŸèƒ½ã€‚

```python
def render_token_statistics():
    """æ¸²æŸ“Tokenç»Ÿè®¡é¡µé¢"""
    st.markdown("**ğŸ’° Tokenä½¿ç”¨ç»Ÿè®¡ä¸æˆæœ¬åˆ†æ**")
    
    # ä¾§è¾¹æ æ§åˆ¶
    with st.sidebar:
        st.subheader("ğŸ“Š ç»Ÿè®¡è®¾ç½®")
        
        # æ—¶é—´èŒƒå›´é€‰æ‹©
        time_range = st.selectbox(
            "ç»Ÿè®¡æ—¶é—´èŒƒå›´",
            ["ä»Šå¤©", "æœ€è¿‘7å¤©", "æœ€è¿‘30å¤©", "æœ€è¿‘90å¤©", "å…¨éƒ¨"],
            index=2
        )
        
        # è½¬æ¢ä¸ºå¤©æ•°
        days_map = {
            "ä»Šå¤©": 1,
            "æœ€è¿‘7å¤©": 7,
            "æœ€è¿‘30å¤©": 30,
            "æœ€è¿‘90å¤©": 90,
            "å…¨éƒ¨": 365  # ä½¿ç”¨ä¸€å¹´ä½œä¸º"å…¨éƒ¨"
        }
        days = days_map[time_range]
        
        # åˆ·æ–°æŒ‰é’®
        if st.button("ğŸ”„ åˆ·æ–°æ•°æ®", use_container_width=True):
            st.rerun()
        
        # å¯¼å‡ºæ•°æ®æŒ‰é’®
        if st.button("ğŸ“¥ å¯¼å‡ºç»Ÿè®¡æ•°æ®", use_container_width=True):
            export_statistics_data(days)
```

**Section sources**
- [token_statistics.py](file://web/modules/token_statistics.py)

## é…ç½®éªŒè¯ä¸æœ€ä½³å®è·µ

### é…ç½®éªŒè¯

ç³»ç»Ÿæä¾›äº†å¤šç§é…ç½®éªŒè¯æœºåˆ¶ï¼Œç¡®ä¿é…ç½®çš„æ­£ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚

```python
def validate_required_env_vars(required_vars: list) -> dict:
    """
    éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡æ˜¯å¦å·²è®¾ç½®
    
    Args:
        required_vars: å¿…éœ€çš„ç¯å¢ƒå˜é‡åˆ—è¡¨
        
    Returns:
        dict: éªŒè¯ç»“æœ
    """
    results = {
        'all_set': True,
        'missing': [],
        'empty': [],
        'valid': []
    }
    
    for var in required_vars:
        info = get_env_info(var)
        
        if not info['exists']:
            results['missing'].append(var)
            results['all_set'] = False
        elif info['empty']:
            results['empty'].append(var)
            results['all_set'] = False
        else:
            results['valid'].append(var)
    
    return results
```

**Section sources**
- [env_utils.py](file://tradingagents/config/env_utils.py)

### é…ç½®æœ€ä½³å®è·µ

#### æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

1. **ä½¿ç”¨ç¯å¢ƒå˜é‡**ï¼šå°†APIå¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ä¸­ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
2. **.envæ–‡ä»¶**ï¼šä½¿ç”¨`.env`æ–‡ä»¶ç®¡ç†ç¯å¢ƒå˜é‡ï¼Œå°†å…¶æ·»åŠ åˆ°`.gitignore`ä¸­é¿å…æ³„éœ²
3. **æƒé™æ§åˆ¶**ï¼šé™åˆ¶å¯¹åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ–‡ä»¶çš„è®¿é—®æƒé™

#### å¤šç¯å¢ƒé…ç½®ç®¡ç†

1. **å¼€å‘ç¯å¢ƒ**ï¼šä½¿ç”¨å®½æ¾çš„é…ç½®ï¼Œå¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•
2. **æµ‹è¯•ç¯å¢ƒ**ï¼šä½¿ç”¨ä¸ç”Ÿäº§ç¯å¢ƒç›¸ä¼¼çš„é…ç½®ï¼Œä½†ä½¿ç”¨æµ‹è¯•æ•°æ®
3. **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨ä¸¥æ ¼çš„é…ç½®ï¼Œå¯ç”¨å®‰å…¨å’Œæ€§èƒ½ä¼˜åŒ–è®¾ç½®

#### é…ç½®åŠ è½½é”™è¯¯å¤„ç†

ç³»ç»Ÿå®ç°äº†å®Œå–„çš„é…ç½®åŠ è½½é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿åœ¨é…ç½®é”™è¯¯æ—¶èƒ½å¤Ÿæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œä¿®å¤å»ºè®®ã€‚

```python
def get_mongodb_config() -> Dict[str, Any]:
    """
    è·å–MongoDBé…ç½®
    
    Returns:
        Dict[str, Any]: MongoDBé…ç½®å­—å…¸
        
    Raises:
        ValueError: å½“å¿…è¦çš„é…ç½®æœªè®¾ç½®æ—¶
    """
    connection_string = os.getenv('MONGODB_CONNECTION_STRING')
    if not connection_string:
        raise ValueError(
            "MongoDBè¿æ¥å­—ç¬¦ä¸²æœªé…ç½®ã€‚è¯·è®¾ç½®ç¯å¢ƒå˜é‡ MONGODB_CONNECTION_STRING\n"
            "ä¾‹å¦‚: MONGODB_CONNECTION_STRING=mongodb://localhost:27017/"
        )
```

**Section sources**
- [database_config.py](file://tradingagents/config/database_config.py)
- [tushare_config.py](file://tradingagents/config/tushare_config.py)