# 附录

<cite>
**本文档引用的文件**
- [mongo-init.js](file://scripts/docker/mongo-init.js)
- [stock_api.py](file://tradingagents/api/stock_api.py)
- [VERSION_0.1.6_RELEASE_NOTES.md](file://VERSION_0.1.6_RELEASE_NOTES.md)
- [VERSION_0.1.7_RELEASE_NOTES.md](file://VERSION_0.1.7_RELEASE_NOTES.md)
</cite>

## 目录
1. [数据库模式设计](#数据库模式设计)
2. [API参考](#api参考)
3. [版本发布说明](#版本发布说明)
4. [术语表](#术语表)

## 数据库模式设计

本项目使用MongoDB作为主要数据存储，通过`mongo-init.js`脚本初始化数据库结构。数据库名为`tradingagents`，包含四个核心集合：`stock_data`（股票数据）、`analysis_results`（分析结果）、`user_sessions`（用户会话）和`configurations`（配置项）。

### 集合结构与索引

**股票数据集合 (stock_data)**
该集合存储所有股票的基础信息和市场数据。
- **索引**:
  - `{ "symbol": 1, "market_type": 1 }`: 基于股票代码和市场类型的复合索引，用于快速查询特定股票。
  - `{ "created_at": -1 }`: 按创建时间倒序的索引，用于获取最新数据。
  - `{ "updated_at": -1 }`: 按更新时间倒序的索引，用于跟踪数据更新。
- **示例数据**:
  ```json
  {
    "symbol": "000001",
    "market_type": "china",
    "data": { "company_name": "平安银行", "sector": "金融", "last_price": 12.50 },
    "created_at": "2025-07-13T00:00:00Z",
    "updated_at": "2025-07-13T00:00:00Z"
  }
  ```

**分析结果集合 (analysis_results)**
该集合存储由AI智能体生成的各种分析报告。
- **索引**:
  - `{ "symbol": 1, "analysis_type": 1 }`: 基于股票代码和分析类型（如基本面、技术面）的复合索引。
  - `{ "created_at": -1 }`: 按创建时间倒序的索引。
  - `{ "symbol": 1, "created_at": -1 }`: 用于快速获取某只股票的最新分析。

**用户会话集合 (user_sessions)**
该集合管理用户的会话状态。
- **索引**:
  - `{ "session_id": 1 }` (唯一): 确保每个会话ID的唯一性。
  - `{ "created_at": -1 }`: 按创建时间倒序。
  - `{ "last_activity": -1 }`: 按最后活动时间倒序，用于会话清理。

**配置集合 (configurations)**
该集合存储系统的全局配置，采用键值对形式，支持不同类型和名称的配置。
- **索引**:
  - `{ "config_type": 1, "config_name": 1 }` (唯一): 确保配置类型和名称的组合唯一。
  - `{ "updated_at": -1 }`: 按更新时间倒序。

### 数据关系与数据流

系统通过`dataflows`模块与MongoDB交互。数据流如下：
1.  **数据获取**: `stock_data_service`从Tushare、AKShare等数据源获取原始数据。
2.  **数据缓存**: 获取的数据首先被缓存到Redis，然后持久化到MongoDB的`stock_data`集合。
3.  **分析触发**: 用户请求分析时，系统从`stock_data`读取数据，由AI智能体（如`fundamentals_analyst`）进行处理。
4.  **结果存储**: 分析结果以结构化形式写入`analysis_results`集合。
5.  **配置管理**: 系统启动时，从`configurations`集合读取缓存TTL、默认LLM模型等配置。

**Diagram sources**
- [mongo-init.js](file://scripts/docker/mongo-init.js#L1-L140)

## API参考

`stock_api.py`文件提供了与股票数据服务交互的公共接口。以下是所有公开接口的详细说明。

### 公开接口列表

**`get_stock_info(stock_code: str) -> Dict[str, Any]`**
- **功能**: 获取单个股票的基础信息。
- **参数**:
  - `stock_code` (str): 股票代码（例如 '000001'）。
- **返回值**: 包含股票信息的字典，如公司名称、市场、类别等。若失败，返回包含错误信息的字典。
- **使用示例**:
  ```python
  info = get_stock_info('000001')
  print(info['name'])  # 输出: 平安银行
  ```

**`get_all_stocks() -> List[Dict[str, Any]]`**
- **功能**: 获取所有股票的基础信息列表。
- **参数**: 无。
- **返回值**: 所有股票信息的字典列表。若失败，返回包含错误信息的列表。
- **使用示例**:
  ```python
  stocks = get_all_stocks()
  print(f"共有{len(stocks)}只股票")
  ```

**`get_stock_data(stock_code: str, start_date: str = None, end_date: str = None) -> str`**
- **功能**: 获取股票的历史数据（带降级机制）。
- **参数**:
  - `stock_code` (str): 股票代码。
  - `start_date` (str, 可选): 开始日期（格式：YYYY-MM-DD），默认为30天前。
  - `end_date` (str, 可选): 结束日期（格式：YYYY-MM-DD），默认为今天。
- **返回值**: 股票数据的字符串表示或错误信息。
- **使用示例**:
  ```python
  data = get_stock_data('000001', '2024-01-01', '2024-01-31')
  print(data)
  ```

**`search_stocks(keyword: str) -> List[Dict[str, Any]]`**
- **功能**: 根据关键词搜索股票（支持代码或名称匹配）。
- **参数**:
  - `keyword` (str): 搜索关键词。
- **返回值**: 匹配的股票信息列表。
- **使用示例**:
  ```python
  results = search_stocks('平安')
  for stock in results:
      print(f"{stock['code']}: {stock['name']}")
  ```

**`get_market_summary() -> Dict[str, Any]`**
- **功能**: 获取市场概览统计信息。
- **参数**: 无。
- **返回值**: 包含总股票数、沪市/深市数量、行业统计等信息的字典。
- **使用示例**:
  ```python
  summary = get_market_summary()
  print(f"沪市股票数量: {summary['shanghai_count']}")
  ```

**`check_service_status() -> Dict[str, Any]`**
- **功能**: 检查核心服务（如MongoDB、Tushare API）的连接状态。
- **参数**: 无。
- **返回值**: 包含各项服务状态的字典。
- **使用示例**:
  ```python
  status = check_service_status()
  print(f"MongoDB状态: {status['mongodb_status']}")
  ```

此外，API还提供了便捷的别名函数：`get_stock` (等同于 `get_stock_info`)、`get_stocks` (等同于 `get_all_stocks`)、`search` (等同于 `search_stocks`) 和 `status` (等同于 `check_service_status`)。

**Section sources**
- [stock_api.py](file://tradingagents/api/stock_api.py#L1-L294)

## 版本发布说明

### TradingAgents-CN v0.1.7 发布说明

**发布日期**: 2025-07-13
**版本号**: cn-0.1.7
**代号**: "导出卓越版"

#### 新增功能
- **Docker容器化部署系统**: 通过`docker-compose.yml`实现一键部署，集成Web应用、MongoDB和Redis。
- **完整报告导出系统**: 支持将分析结果导出为Markdown、Word和PDF格式，文件名自动标准化。
- **开发环境优化**: 支持Docker Volume映射，实现代码实时同步，提升开发效率。

#### 重要修复
- **导出功能核心修复**: 解决了YAML解析冲突和PDF生成中的内容清理问题。
- **系统稳定性修复**: 修复了内存空指针和缓存类型安全问题。

#### 技术架构改进
- 实现了基于Pandoc的多格式转换引擎。
- 优化了Docker容器化架构，便于开发和生产部署。

### TradingAgents-CN v0.1.6 正式版发布

**发布日期**: 2025-07-03
**版本号**: v0.1.6

#### 版本亮点
- **阿里百炼完全修复**: 通过新的`ChatDashScopeOpenAI`适配器解决了工具调用问题，响应速度提升50%。
- **数据源全面升级**: 主数据源从通达信迁移到Tushare，并采用Tushare+AKShare+BaoStock的混合策略。
- **LLM集成优化**: 引入DeepSeek V3作为高性价比选项，并实现统一的Token追踪。

#### 性能提升
| 指标 | 提升幅度 |
|------|----------|
| 响应速度 | 50% |
| 工具调用成功率 | 35% |
| 报告完整性 | 5000% |

**Section sources**
- [VERSION_0.1.6_RELEASE_NOTES.md](file://VERSION_0.1.6_RELEASE_NOTES.md#L1-L208)
- [VERSION_0.1.7_RELEASE_NOTES.md](file://VERSION_0.1.7_RELEASE_NOTES.md#L1-L322)

## 术语表

- **智能体 (Agent)**: 指系统中模拟人类分析师的AI模块，如`fundamentals_analyst`（基本面分析师）和`market_analyst`（市场分析师），它们通过协作和辩论生成投资建议。
- **辩论机制 (Debate Mechanism)**: 一种风险控制策略，通过`bull_researcher`（看涨研究员）和`bear_researcher`（看跌研究员）的对抗性分析，对投资决策进行压力测试，以提高结论的稳健性。
- **缓存穿透 (Cache Penetration)**: 一种缓存失效问题，指查询一个在数据库中也不存在的数据，导致每次请求都直接打到数据库。本项目通过`db_cache_manager`实现缓存空值或布隆过滤器来缓解此问题。
- **降级机制 (Fallback Mechanism)**: 当主数据源（如Tushare）不可用时，系统自动切换到备用数据源（如AKShare或BaoStock）以保证服务的可用性。
- **LLM适配器 (LLM Adapter)**: 一个封装层，用于统一不同大语言模型（如DeepSeek、阿里百炼、OpenAI）的API调用方式，使核心业务逻辑与具体LLM提供商解耦。