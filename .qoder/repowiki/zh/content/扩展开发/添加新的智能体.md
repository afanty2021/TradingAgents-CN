# æ·»åŠ æ–°çš„æ™ºèƒ½ä½“

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**   
- [fundamentals_analyst.py](file://tradingagents/agents/analysts/fundamentals_analyst.py)
- [market_analyst.py](file://tradingagents/agents/analysts/market_analyst.py)
- [news_analyst.py](file://tradingagents/agents/analysts/news_analyst.py)
- [social_media_analyst.py](file://tradingagents/agents/analysts/social_media_analyst.py)
- [research_manager.py](file://tradingagents/agents/managers/research_manager.py)
- [risk_manager.py](file://tradingagents/agents/managers/risk_manager.py)
- [bull_researcher.py](file://tradingagents/agents/researchers/bull_researcher.py)
- [bear_researcher.py](file://tradingagents/agents/researchers/bear_researcher.py)
- [trader.py](file://tradingagents/agents/trader/trader.py)
- [agent_states.py](file://tradingagents/agents/utils/agent_states.py)
- [memory.py](file://tradingagents/agents/utils/memory.py)
- [tool_logging.py](file://tradingagents/utils/tool_logging.py)
- [agent_utils.py](file://tradingagents/agents/utils/agent_utils.py)
- [trading_graph.py](file://tradingagents/graph/trading_graph.py)
- [setup.py](file://tradingagents/graph/setup.py)
</cite>

## ç›®å½•
1. [æ™ºèƒ½ä½“æ¥å£è§„èŒƒä¸ç»§æ‰¿ç»“æ„](#æ™ºèƒ½ä½“æ¥å£è§„èŒƒä¸ç»§æ‰¿ç»“æ„)
2. [æ™ºèƒ½ä½“åœ¨LangGraphå·¥ä½œæµä¸­çš„æ³¨å†Œä¸è°ƒç”¨](#æ™ºèƒ½ä½“åœ¨langgraphå·¥ä½œæµä¸­çš„æ³¨å†Œä¸è°ƒç”¨)
3. [çŠ¶æ€ç®¡ç†ã€å·¥å…·è°ƒç”¨ä¸è®°å¿†æœºåˆ¶](#çŠ¶æ€ç®¡ç†å·¥å…·è°ƒç”¨ä¸è®°å¿†æœºåˆ¶)
4. [åˆ›å»ºæ–°çš„åˆ†æå¸ˆæ™ºèƒ½ä½“ç¤ºä¾‹](#åˆ›å»ºæ–°çš„åˆ†æå¸ˆæ™ºèƒ½ä½“ç¤ºä¾‹)
5. [æ™ºèƒ½ä½“ä¸äº¤æ˜“å›¾çš„é›†æˆ](#æ™ºèƒ½ä½“ä¸äº¤æ˜“å›¾çš„é›†æˆ)
6. [é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ä¸æ€§èƒ½ä¼˜åŒ–](#é”™è¯¯å¤„ç†æ—¥å¿—è®°å½•ä¸æ€§èƒ½ä¼˜åŒ–)

## æ™ºèƒ½ä½“æ¥å£è§„èŒƒä¸ç»§æ‰¿ç»“æ„

TradingAgents-CNç³»ç»Ÿä¸­çš„æ™ºèƒ½ä½“éµå¾ªç»Ÿä¸€çš„æ¥å£è§„èŒƒå’Œç»§æ‰¿ç»“æ„ï¼Œä¸»è¦åˆ†ä¸ºå››ç±»ï¼šåˆ†æå¸ˆã€ç ”ç©¶å‘˜ã€ç®¡ç†è€…å’Œäº¤æ˜“å‘˜ã€‚æ¯ç±»æ™ºèƒ½ä½“éƒ½é€šè¿‡å·¥å‚å‡½æ•°åˆ›å»ºï¼Œè¿”å›ä¸€ä¸ªç¬¦åˆç‰¹å®šç­¾åçš„èŠ‚ç‚¹å‡½æ•°ã€‚

### åˆ†æå¸ˆæ™ºèƒ½ä½“

åˆ†æå¸ˆæ™ºèƒ½ä½“è´Ÿè´£ä»ä¸åŒè§’åº¦åˆ†æè‚¡ç¥¨ï¼ŒåŒ…æ‹¬å¸‚åœºã€æ–°é—»ã€ç¤¾äº¤åª’ä½“å’ŒåŸºæœ¬é¢ã€‚æ‰€æœ‰åˆ†æå¸ˆæ™ºèƒ½ä½“éƒ½éµå¾ªç›¸åŒçš„æ¥å£è§„èŒƒï¼š

```python
@log_analyst_module("analyst_type")
def analyst_node(state):
    # åˆ†æé€»è¾‘
    return {"report_key": analysis_result}
```

- **æ¥å£è§„èŒƒ**ï¼š
  - ä½¿ç”¨`@log_analyst_module`è£…é¥°å™¨è¿›è¡Œæ—¥å¿—è®°å½•
  - æ¥æ”¶`state`å‚æ•°ï¼ŒåŒ…å«å½“å‰åˆ†æçŠ¶æ€
  - è¿”å›åŒ…å«æŠ¥å‘Šé”®å€¼å¯¹çš„å­—å…¸
  - æŠ¥å‘Šé”®å¦‚`market_report`ã€`news_report`ç­‰åœ¨`agent_states.py`ä¸­å®šä¹‰

- **ç»§æ‰¿ç»“æ„**ï¼š
  - æ‰€æœ‰åˆ†æå¸ˆç»§æ‰¿è‡ª`ChatPromptTemplate`å’ŒLLMæ¨¡å‹
  - é€šè¿‡`bind_tools`æ–¹æ³•ç»‘å®šç›¸å…³å·¥å…·
  - ä½¿ç”¨ç»Ÿä¸€çš„ç³»ç»Ÿæç¤ºæ¨¡æ¿

**åˆ†æå¸ˆç±»å‹**ï¼š
- **å¸‚åœºåˆ†æå¸ˆ**ï¼šåˆ†ææŠ€æœ¯æŒ‡æ ‡å’Œå¸‚åœºè¶‹åŠ¿
- **æ–°é—»åˆ†æå¸ˆ**ï¼šåˆ†æå®è§‚ç»æµå’Œå…¬å¸æ–°é—»
- **ç¤¾äº¤åª’ä½“åˆ†æå¸ˆ**ï¼šåˆ†æç¤¾äº¤åª’ä½“æƒ…ç»ª
- **åŸºæœ¬é¢åˆ†æå¸ˆ**ï¼šåˆ†æè´¢åŠ¡æ•°æ®å’Œå…¬å¸åŸºæœ¬é¢

```mermaid
classDiagram
class Analyst {
<<abstract>>
+create_analyst_node(llm, toolkit) NodeFunction
}
class MarketAnalyst {
+create_market_analyst(llm, toolkit) NodeFunction
-system_message : str
-prompt : ChatPromptTemplate
}
class NewsAnalyst {
+create_news_analyst(llm, toolkit) NodeFunction
-system_message : str
-prompt : ChatPromptTemplate
}
class SocialMediaAnalyst {
+create_social_media_analyst(llm, toolkit) NodeFunction
-system_message : str
-prompt : ChatPromptTemplate
}
class FundamentalsAnalyst {
+create_fundamentals_analyst(llm, toolkit) NodeFunction
-system_message : str
-prompt : ChatPromptTemplate
}
Analyst <|-- MarketAnalyst
Analyst <|-- NewsAnalyst
Analyst <|-- SocialMediaAnalyst
Analyst <|-- FundamentalsAnalyst
```

**å›¾è¡¨æ¥æº**
- [market_analyst.py](file://tradingagents/agents/analysts/market_analyst.py)
- [news_analyst.py](file://tradingagents/agents/analysts/news_analyst.py)
- [social_media_analyst.py](file://tradingagents/agents/analysts/social_media_analyst.py)
- [fundamentals_analyst.py](file://tradingagents/agents/analysts/fundamentals_analyst.py)

### ç ”ç©¶å‘˜æ™ºèƒ½ä½“

ç ”ç©¶å‘˜æ™ºèƒ½ä½“åˆ†ä¸ºçœ‹æ¶¨ç ”ç©¶å‘˜å’Œçœ‹è·Œç ”ç©¶å‘˜ï¼Œå®ƒä»¬åŸºäºåˆ†æå¸ˆçš„æŠ¥å‘Šè¿›è¡Œè¾©è®ºï¼Œå½¢æˆæŠ•èµ„è§‚ç‚¹ã€‚

```python
def create_researcher(llm, memory):
    def researcher_node(state):
        # è¾©è®ºé€»è¾‘
        return {"investment_debate_state": debate_state}
    return researcher_node
```

- **æ¥å£è§„èŒƒ**ï¼š
  - æ¥æ”¶`llm`å’Œ`memory`å‚æ•°
  - è¿”å›æ›´æ–°åçš„`investment_debate_state`
  - ä½¿ç”¨å†å²è®°å¿†è¿›è¡Œå†³ç­–

```mermaid
classDiagram
class Researcher {
<<abstract>>
+create_researcher_node(llm, memory) NodeFunction
}
class BullResearcher {
+create_bull_researcher(llm, memory) NodeFunction
-prompt : str
}
class BearResearcher {
+create_bear_researcher(llm, memory) NodeFunction
-prompt : str
}
Researcher <|-- BullResearcher
Researcher <|-- BearResearcher
```

**å›¾è¡¨æ¥æº**
- [bull_researcher.py](file://tradingagents/agents/researchers/bull_researcher.py)
- [bear_researcher.py](file://tradingagents/agents/researchers/bear_researcher.py)

### ç®¡ç†è€…æ™ºèƒ½ä½“

ç®¡ç†è€…æ™ºèƒ½ä½“è´Ÿè´£åè°ƒå’Œå†³ç­–ï¼ŒåŒ…æ‹¬ç ”ç©¶ç®¡ç†è€…å’Œé£é™©ç®¡ç†ã€‚

```python
def create_manager(llm, memory):
    def manager_node(state):
        # å†³ç­–é€»è¾‘
        return {"investment_plan": plan, "final_trade_decision": decision}
    return manager_node
```

- **æ¥å£è§„èŒƒ**ï¼š
  - æ¥æ”¶`llm`å’Œ`memory`å‚æ•°
  - è¿”å›æŠ•èµ„è®¡åˆ’å’Œæœ€ç»ˆå†³ç­–
  - ç»¼åˆå¤šæ–¹ä¿¡æ¯åšå‡ºå†³ç­–

```mermaid
classDiagram
class Manager {
<<abstract>>
+create_manager_node(llm, memory) NodeFunction
}
class ResearchManager {
+create_research_manager(llm, memory) NodeFunction
-prompt : str
}
class RiskManager {
+create_risk_manager(llm, memory) NodeFunction
-prompt : str
}
Manager <|-- ResearchManager
Manager <|-- RiskManager
```

**å›¾è¡¨æ¥æº**
- [research_manager.py](file://tradingagents/agents/managers/research_manager.py)
- [risk_manager.py](file://tradingagents/agents/managers/risk_manager.py)

### äº¤æ˜“å‘˜æ™ºèƒ½ä½“

äº¤æ˜“å‘˜æ™ºèƒ½ä½“è´Ÿè´£æœ€ç»ˆçš„äº¤æ˜“å†³ç­–å’Œæ‰§è¡Œã€‚

```python
def create_trader(llm, memory):
    def trader_node(state, name):
        # äº¤æ˜“å†³ç­–é€»è¾‘
        return {"trader_investment_plan": plan, "sender": name}
    return functools.partial(trader_node, name="Trader")
```

- **æ¥å£è§„èŒƒ**ï¼š
  - ä½¿ç”¨`functools.partial`é¢„è®¾åç§°
  - è¿”å›äº¤æ˜“è®¡åˆ’å’Œå‘é€è€…ä¿¡æ¯
  - åŸºäºæ‰€æœ‰åˆ†æç»“æœåšå‡ºå…·ä½“äº¤æ˜“å»ºè®®

```mermaid
classDiagram
class Trader {
+create_trader(llm, memory) NodeFunction
-prompt : str
}
```

**å›¾è¡¨æ¥æº**
- [trader.py](file://tradingagents/agents/trader/trader.py)

## æ™ºèƒ½ä½“åœ¨LangGraphå·¥ä½œæµä¸­çš„æ³¨å†Œä¸è°ƒç”¨

æ™ºèƒ½ä½“åœ¨LangGraphå·¥ä½œæµä¸­çš„æ³¨å†Œå’Œè°ƒç”¨æ˜¯é€šè¿‡`GraphSetup`ç±»å®Œæˆçš„ï¼Œè¯¥ç±»è´Ÿè´£æ„å»ºæ•´ä¸ªæ™ºèƒ½ä½“åä½œçš„å·¥ä½œæµã€‚

### å·¥ä½œæµæ³¨å†Œæœºåˆ¶

`GraphSetup.setup_graph()`æ–¹æ³•è´Ÿè´£æ³¨å†Œæ‰€æœ‰æ™ºèƒ½ä½“èŠ‚ç‚¹å¹¶å»ºç«‹å®ƒä»¬ä¹‹é—´çš„è¿æ¥ã€‚

```python
def setup_graph(self, selected_analysts=["market", "social", "news", "fundamentals"]):
    # åˆ›å»ºåˆ†æèŠ‚ç‚¹
    analyst_nodes = {}
    delete_nodes = {}
    tool_nodes = {}
    
    # æ ¹æ®é€‰æ‹©çš„åˆ†æå¸ˆç±»å‹æ³¨å†ŒèŠ‚ç‚¹
    if "market" in selected_analysts:
        analyst_nodes["market"] = create_market_analyst(self.quick_thinking_llm, self.toolkit)
        delete_nodes["market"] = create_msg_delete()
        tool_nodes["market"] = self.tool_nodes["market"]
    
    # ... å…¶ä»–åˆ†æå¸ˆç±»å‹
```

- **æ³¨å†Œæµç¨‹**ï¼š
  1. æ ¹æ®`selected_analysts`å‚æ•°ç¡®å®šéœ€è¦æ³¨å†Œçš„åˆ†æå¸ˆç±»å‹
  2. ä¸ºæ¯ç§åˆ†æå¸ˆç±»å‹åˆ›å»ºä¸‰ä¸ªèŠ‚ç‚¹ï¼šåˆ†æèŠ‚ç‚¹ã€æ¶ˆæ¯æ¸…é™¤èŠ‚ç‚¹å’Œå·¥å…·èŠ‚ç‚¹
  3. å°†èŠ‚ç‚¹æ·»åŠ åˆ°`StateGraph`ä¸­
  4. å»ºç«‹èŠ‚ç‚¹é—´çš„è¿æ¥

### è°ƒç”¨æµç¨‹

æ™ºèƒ½ä½“çš„è°ƒç”¨æµç¨‹éµå¾ªé¢„å®šä¹‰çš„å·¥ä½œæµï¼Œé€šè¿‡æ¡ä»¶è¾¹ï¼ˆconditional edgesï¼‰æ§åˆ¶æ‰§è¡Œé¡ºåºã€‚

```mermaid
sequenceDiagram
participant TradingGraph as TradingAgentsGraph
participant GraphSetup as GraphSetup
participant StateGraph as StateGraph
participant Analyst as Analyst Node
participant ToolNode as ToolNode
TradingGraph->>GraphSetup : setup_graph(selected_analysts)
GraphSetup->>StateGraph : åˆ›å»ºStateGraph(AgentState)
loop ä¸ºæ¯ä¸ªåˆ†æå¸ˆç±»å‹
GraphSetup->>StateGraph : add_node(åˆ†æèŠ‚ç‚¹)
GraphSetup->>StateGraph : add_node(æ¶ˆæ¯æ¸…é™¤èŠ‚ç‚¹)
GraphSetup->>StateGraph : add_node(å·¥å…·èŠ‚ç‚¹)
GraphSetup->>StateGraph : add_conditional_edges()
end
GraphSetup->>StateGraph : add_edge(START, ç¬¬ä¸€ä¸ªåˆ†æå¸ˆ)
GraphSetup->>StateGraph : ç¼–è¯‘å·¥ä½œæµ
StateGraph-->>TradingGraph : è¿”å›ç¼–è¯‘åçš„å·¥ä½œæµ
TradingGraph->>StateGraph : invoke(åˆå§‹çŠ¶æ€)
loop å·¥ä½œæµæ‰§è¡Œ
StateGraph->>Analyst : è°ƒç”¨åˆ†æèŠ‚ç‚¹
alt éœ€è¦å·¥å…·è°ƒç”¨
Analyst->>StateGraph : è¿”å›åŒ…å«å·¥å…·è°ƒç”¨çš„æ¶ˆæ¯
StateGraph->>ToolNode : è°ƒç”¨ç›¸åº”å·¥å…·
ToolNode->>StateGraph : è¿”å›å·¥å…·ç»“æœ
StateGraph->>Analyst : å°†ç»“æœä¼ é€’å›åˆ†æèŠ‚ç‚¹
else ä¸éœ€è¦å·¥å…·è°ƒç”¨
Analyst->>StateGraph : è¿”å›æœ€ç»ˆç»“æœ
end
StateGraph->>StateGraph : æ¸…é™¤æ¶ˆæ¯
StateGraph->>StateGraph : è¿æ¥åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
end
StateGraph-->>TradingGraph : è¿”å›æœ€ç»ˆçŠ¶æ€
```

**å›¾è¡¨æ¥æº**
- [setup.py](file://tradingagents/graph/setup.py)
- [trading_graph.py](file://tradingagents/graph/trading_graph.py)

### æ‰§è¡Œé¡ºåº

æ™ºèƒ½ä½“çš„æ‰§è¡Œé¡ºåºæ˜¯çº¿æ€§çš„ï¼ŒæŒ‰ç…§æ³¨å†Œæ—¶çš„é¡ºåºä¾æ¬¡æ‰§è¡Œï¼š

1. **åˆ†æå¸ˆé˜¶æ®µ**ï¼šæŒ‰é¡ºåºæ‰§è¡Œå¸‚åœºã€ç¤¾äº¤åª’ä½“ã€æ–°é—»ã€åŸºæœ¬é¢åˆ†æ
2. **ç ”ç©¶å‘˜é˜¶æ®µ**ï¼šçœ‹æ¶¨å’Œçœ‹è·Œç ”ç©¶å‘˜è¿›è¡Œè¾©è®º
3. **ç®¡ç†é˜¶æ®µ**ï¼šç ”ç©¶ç®¡ç†è€…åšå‡ºæŠ•èµ„å†³ç­–
4. **é£é™©è¯„ä¼°é˜¶æ®µ**ï¼šé£é™©åˆ†æå¸ˆè¯„ä¼°æŠ•èµ„é£é™©
5. **äº¤æ˜“é˜¶æ®µ**ï¼šäº¤æ˜“å‘˜åšå‡ºæœ€ç»ˆäº¤æ˜“å†³ç­–

```mermaid
flowchart TD
START([å¼€å§‹])
--> MarketAnalyst["å¸‚åœºåˆ†æå¸ˆ"]
--> MsgClearMarket["æ¸…é™¤æ¶ˆæ¯"]
--> SocialAnalyst["ç¤¾äº¤åª’ä½“åˆ†æå¸ˆ"]
--> MsgClearSocial["æ¸…é™¤æ¶ˆæ¯"]
--> NewsAnalyst["æ–°é—»åˆ†æå¸ˆ"]
--> MsgClearNews["æ¸…é™¤æ¶ˆæ¯"]
--> FundamentalsAnalyst["åŸºæœ¬é¢åˆ†æå¸ˆ"]
--> MsgClearFundamentals["æ¸…é™¤æ¶ˆæ¯"]
--> BullResearcher["çœ‹æ¶¨ç ”ç©¶å‘˜"]
--> BearResearcher["çœ‹è·Œç ”ç©¶å‘˜"]
--> ResearchManager["ç ”ç©¶ç®¡ç†è€…"]
--> RiskyAnalyst["æ¿€è¿›åˆ†æå¸ˆ"]
--> SafeAnalyst["ä¿å®ˆåˆ†æå¸ˆ"]
--> NeutralAnalyst["ä¸­ç«‹åˆ†æå¸ˆ"]
--> RiskManager["é£é™©ç®¡ç†"]
--> Trader["äº¤æ˜“å‘˜"]
--> END([ç»“æŸ])
subgraph "å·¥å…·è°ƒç”¨"
MarketTools["å¸‚åœºå·¥å…·èŠ‚ç‚¹"]
SocialTools["ç¤¾äº¤åª’ä½“å·¥å…·èŠ‚ç‚¹"]
NewsTools["æ–°é—»å·¥å…·èŠ‚ç‚¹"]
FundamentalsTools["åŸºæœ¬é¢å·¥å…·èŠ‚ç‚¹"]
end
MarketAnalyst -- éœ€è¦å·¥å…· --> MarketTools
MarketTools -- å·¥å…·ç»“æœ --> MarketAnalyst
SocialAnalyst -- éœ€è¦å·¥å…· --> SocialTools
SocialTools -- å·¥å…·ç»“æœ --> SocialAnalyst
NewsAnalyst -- éœ€è¦å·¥å…· --> NewsTools
NewsTools -- å·¥å…·ç»“æœ --> NewsAnalyst
FundamentalsAnalyst -- éœ€è¦å·¥å…· --> FundamentalsTools
FundamentalsTools -- å·¥å…·ç»“æœ --> FundamentalsAnalyst
```

**å›¾è¡¨æ¥æº**
- [setup.py](file://tradingagents/graph/setup.py)

## çŠ¶æ€ç®¡ç†ã€å·¥å…·è°ƒç”¨ä¸è®°å¿†æœºåˆ¶

### çŠ¶æ€ç®¡ç†ï¼ˆagent_states.pyï¼‰

çŠ¶æ€ç®¡ç†æ˜¯æ™ºèƒ½ä½“åä½œçš„æ ¸å¿ƒï¼Œé€šè¿‡`AgentState`ç±»å®šä¹‰äº†æ‰€æœ‰æ™ºèƒ½ä½“å…±äº«çš„çŠ¶æ€ç»“æ„ã€‚

```python
class AgentState(MessagesState):
    company_of_interest: Annotated[str, "æ„Ÿå…´è¶£çš„å…¬å¸"]
    trade_date: Annotated[str, "äº¤æ˜“æ—¥æœŸ"]
    
    # åˆ†æé˜¶æ®µ
    market_report: Annotated[str, "å¸‚åœºåˆ†æå¸ˆæŠ¥å‘Š"]
    sentiment_report: Annotated[str, "ç¤¾äº¤åª’ä½“åˆ†æå¸ˆæŠ¥å‘Š"]
    news_report: Annotated[str, "æ–°é—»åˆ†æå¸ˆæŠ¥å‘Š"]
    fundamentals_report: Annotated[str, "åŸºæœ¬é¢åˆ†æå¸ˆæŠ¥å‘Š"]
    
    # ç ”ç©¶å‘˜è¾©è®ºé˜¶æ®µ
    investment_debate_state: Annotated[InvestDebateState, "æŠ•èµ„è¾©è®ºçŠ¶æ€"]
    investment_plan: Annotated[str, "æŠ•èµ„è®¡åˆ’"]
    
    # é£é™©ç®¡ç†é˜¶æ®µ
    risk_debate_state: Annotated[RiskDebateState, "é£é™©è¾©è®ºçŠ¶æ€"]
    final_trade_decision: Annotated[str, "æœ€ç»ˆäº¤æ˜“å†³ç­–"]
```

- **çŠ¶æ€æµè½¬**ï¼š
  - åˆå§‹çŠ¶æ€ç”±`Propagator.create_initial_state()`åˆ›å»º
  - æ¯ä¸ªæ™ºèƒ½ä½“èŠ‚ç‚¹æ›´æ–°ç›¸åº”çš„çŠ¶æ€å­—æ®µ
  - çŠ¶æ€åœ¨æ™ºèƒ½ä½“é—´ä¼ é€’ï¼Œå½¢æˆå®Œæ•´çš„åˆ†æé“¾

```mermaid
erDiagram
AgentState {
string company_of_interest PK
string trade_date
string market_report
string sentiment_report
string news_report
string fundamentals_report
InvestDebateState investment_debate_state
string investment_plan
RiskDebateState risk_debate_state
string final_trade_decision
}
InvestDebateState {
string bull_history
string bear_history
string history
string current_response
string judge_decision
int count
}
RiskDebateState {
string risky_history
string safe_history
string neutral_history
string history
string latest_speaker
string current_risky_response
string current_safe_response
string current_neutral_response
string judge_decision
int count
}
AgentState ||--o{ InvestDebateState : "åŒ…å«"
AgentState ||--o{ RiskDebateState : "åŒ…å«"
```

**å›¾è¡¨æ¥æº**
- [agent_states.py](file://tradingagents/agents/utils/agent_states.py)

### å·¥å…·è°ƒç”¨ï¼ˆtool_logging.pyï¼‰

å·¥å…·è°ƒç”¨æœºåˆ¶é€šè¿‡`Toolkit`ç±»å®ç°ï¼Œä¸ºæ™ºèƒ½ä½“æä¾›è®¿é—®å¤–éƒ¨æ•°æ®æºçš„èƒ½åŠ›ã€‚

```python
class Toolkit:
    def __init__(self, config=None):
        if config:
            self.update_config(config)
    
    @staticmethod
    @tool
    def get_YFin_data(symbol, start_date, end_date) -> str:
        """ä»Yahoo Financeè·å–è‚¡ç¥¨æ•°æ®"""
        result_data = interface.get_YFin_data(symbol, start_date, end_date)
        return result_data
    
    @staticmethod
    @tool
    def get_finnhub_news(ticker, start_date, end_date) -> str:
        """ä»Finnhubè·å–æ–°é—»"""
        finnhub_news_result = interface.get_finnhub_news(ticker, end_date_str, look_back_days)
        return finnhub_news_result
```

- **å·¥å…·æ³¨å†Œ**ï¼š
  - ä½¿ç”¨`@tool`è£…é¥°å™¨æ ‡è®°å·¥å…·æ–¹æ³•
  - å·¥å…·é€šè¿‡`ToolNode`åŒ…è£…ï¼Œé›†æˆåˆ°LangGraphå·¥ä½œæµ
  - åœ¨`trading_graph.py`ä¸­é€šè¿‡`_create_tool_nodes()`æ–¹æ³•åˆ›å»ºå·¥å…·èŠ‚ç‚¹

```mermaid
classDiagram
class Toolkit {
+config : Dict[str, Any]
+update_config(config) void
+get_YFin_data(symbol, start_date, end_date) str
+get_finnhub_news(ticker, start_date, end_date) str
+get_stock_fundamentals_unified(ticker, start_date, end_date) str
}
class ToolNode {
+tools : List[Callable]
+invoke(state) Dict[str, Any]
}
class Analyst {
+llm : LLM
+toolkit : Toolkit
}
Toolkit --> ToolNode : "æä¾›å·¥å…·"
ToolNode --> Analyst : "æ‰§è¡Œå·¥å…·è°ƒç”¨"
Analyst --> Toolkit : "è¯·æ±‚å·¥å…·"
```

**å›¾è¡¨æ¥æº**
- [agent_utils.py](file://tradingagents/agents/utils/agent_utils.py)
- [tool_logging.py](file://tradingagents/utils/tool_logging.py)

### è®°å¿†æœºåˆ¶ï¼ˆmemory.pyï¼‰

è®°å¿†æœºåˆ¶é€šè¿‡`FinancialSituationMemory`ç±»å®ç°ï¼Œä½¿ç”¨ChromaDBä½œä¸ºå‘é‡æ•°æ®åº“å­˜å‚¨å†å²å†³ç­–å’Œç»éªŒã€‚

```python
class FinancialSituationMemory:
    def __init__(self, name, config):
        self.config = config
        self.llm_provider = config.get("llm_provider", "openai").lower()
        self.chroma_manager = ChromaDBManager()
        self.situation_collection = self.chroma_manager.get_or_create_collection(name)
    
    def add_situations(self, situations_and_advice):
        """æ·»åŠ è´¢åŠ¡æƒ…å†µå’Œç›¸åº”å»ºè®®"""
        # ... å®ç°ç»†èŠ‚
        pass
    
    def get_memories(self, current_situation, n_matches=1):
        """æ ¹æ®å½“å‰æƒ…å†µæŸ¥æ‰¾åŒ¹é…çš„å»ºè®®"""
        # ... å®ç°ç»†èŠ‚
        pass
```

- **è®°å¿†æµç¨‹**ï¼š
  1. åˆå§‹åŒ–æ—¶åˆ›å»ºChromaDBé›†åˆ
  2. é€šè¿‡`add_situations()`æ–¹æ³•æ·»åŠ å†å²å†³ç­–
  3. é€šè¿‡`get_memories()`æ–¹æ³•æ£€ç´¢ç›¸ä¼¼å†å²æƒ…å†µ
  4. åœ¨æ™ºèƒ½ä½“å†³ç­–æ—¶å‚è€ƒå†å²ç»éªŒ

```mermaid
sequenceDiagram
participant Analyst as åˆ†æå¸ˆ
participant Memory as FinancialSituationMemory
participant ChromaDB as ChromaDB
Analyst->>Memory : get_memories(å½“å‰æƒ…å†µ)
Memory->>ChromaDB : è®¡ç®—å½“å‰æƒ…å†µçš„åµŒå…¥
ChromaDB-->>Memory : è¿”å›åµŒå…¥å‘é‡
Memory->>ChromaDB : æŸ¥è¯¢ç›¸ä¼¼çš„å†å²æƒ…å†µ
ChromaDB-->>Memory : è¿”å›æœ€ç›¸ä¼¼çš„Nä¸ªè®°å¿†
Memory-->>Analyst : è¿”å›åŒ¹é…çš„è®°å¿†
Analyst->>Analyst : åŸºäºå†å²è®°å¿†è°ƒæ•´å†³ç­–
```

**å›¾è¡¨æ¥æº**
- [memory.py](file://tradingagents/agents/utils/memory.py)

## åˆ›å»ºæ–°çš„åˆ†æå¸ˆæ™ºèƒ½ä½“ç¤ºä¾‹

æœ¬èŠ‚å°†æ¼”ç¤ºå¦‚ä½•ä¸ºTradingAgents-CNç³»ç»Ÿåˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†æå¸ˆæ™ºèƒ½ä½“â€”â€”æŠ€æœ¯åˆ†ææ™ºèƒ½ä½“ã€‚

### æ­¥éª¤1ï¼šåˆ›å»ºæ–°çš„åˆ†æå¸ˆæ–‡ä»¶

åœ¨`tradingagents/agents/analysts/`ç›®å½•ä¸‹åˆ›å»º`technical_analyst.py`æ–‡ä»¶ï¼š

```python
"""
æŠ€æœ¯åˆ†ææ™ºèƒ½ä½“
ä½¿ç”¨æŠ€æœ¯æŒ‡æ ‡è¿›è¡Œè‚¡ç¥¨åˆ†æ
"""

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.messages import AIMessage

# å¯¼å…¥åˆ†ææ¨¡å—æ—¥å¿—è£…é¥°å™¨
from tradingagents.utils.tool_logging import log_analyst_module

# å¯¼å…¥ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
from tradingagents.utils.logging_init import get_logger
logger = get_logger("default")


def create_technical_analyst(llm, toolkit):
    @log_analyst_module("technical")
    def technical_analyst_node(state):
        logger.debug(f"ğŸ“Š [DEBUG] ===== æŠ€æœ¯åˆ†ææ™ºèƒ½ä½“èŠ‚ç‚¹å¼€å§‹ =====")
        
        current_date = state["trade_date"]
        ticker = state["company_of_interest"]
        
        logger.debug(f"ğŸ“Š [DEBUG] è¾“å…¥å‚æ•°: ticker={ticker}, date={current_date}")
        
        # è·å–è‚¡ç¥¨å¸‚åœºä¿¡æ¯
        from tradingagents.utils.stock_utils import StockUtils
        market_info = StockUtils.get_market_info(ticker)
        
        # é€‰æ‹©æŠ€æœ¯åˆ†æå·¥å…·
        tools = [
            toolkit.get_stockstats_indicators_report,
            toolkit.get_YFin_data
        ]
        
        # æŠ€æœ¯åˆ†æç³»ç»Ÿæç¤º
        system_message = (
            f"ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æŠ€æœ¯åˆ†æå¸ˆã€‚"
            f"ä»»åŠ¡ï¼šåˆ†æ{ticker}çš„æŠ€æœ¯æŒ‡æ ‡å’Œä»·æ ¼èµ°åŠ¿"
            "ğŸ“Š åˆ†æè¦æ±‚ï¼š"
            "- åŸºäºçœŸå®æ•°æ®è¿›è¡ŒæŠ€æœ¯åˆ†æ"
            "- åˆ†æä¸»è¦æŠ€æœ¯æŒ‡æ ‡ï¼ˆå¦‚MACDã€RSIã€å¸ƒæ—å¸¦ç­‰ï¼‰"
            "- è¯†åˆ«å…³é”®æ”¯æ’‘ä½å’Œé˜»åŠ›ä½"
            "- åˆ¤æ–­å½“å‰è¶‹åŠ¿ï¼ˆä¸Šå‡ã€ä¸‹é™ã€ç›˜æ•´ï¼‰"
            "- æä¾›åŸºäºæŠ€æœ¯åˆ†æçš„äº¤æ˜“å»ºè®®"
            "ğŸŒ è¯­è¨€è¦æ±‚ï¼š"
            "- æ‰€æœ‰åˆ†æå†…å®¹å¿…é¡»ä½¿ç”¨ä¸­æ–‡"
            "- æŠ•èµ„å»ºè®®å¿…é¡»ä½¿ç”¨ä¸­æ–‡ï¼šä¹°å…¥ã€æŒæœ‰ã€å–å‡º"
            "ç°åœ¨ç«‹å³å¼€å§‹åˆ†æï¼"
        )
        
        # åˆ›å»ºæç¤ºæ¨¡æ¿
        prompt = ChatPromptTemplate.from_messages([
            ("system", system_message),
            MessagesPlaceholder(variable_name="messages"),
        ])
        
        # ç»‘å®šå·¥å…·
        chain = prompt | llm.bind_tools(tools)
        
        # è°ƒç”¨LLM
        result = chain.invoke(state["messages"])
        
        # å¤„ç†ç»“æœ
        return {
            "technical_report": result.content if hasattr(result, 'content') else str(result)
        }
    
    return technical_analyst_node
```

### æ­¥éª¤2ï¼šæ›´æ–°`__init__.py`æ–‡ä»¶

åœ¨`tradingagents/agents/analysts/__init__.py`ä¸­æ·»åŠ æ–°æ™ºèƒ½ä½“çš„å¯¼å…¥ï¼š

```python
from .technical_analyst import create_technical_analyst

__all__ = [
    "create_fundamentals_analyst",
    "create_market_analyst",
    "create_news_analyst",
    "create_social_media_analyst",
    "create_technical_analyst"
]
```

### æ­¥éª¤3ï¼šæ›´æ–°ä¸»`__init__.py`æ–‡ä»¶

åœ¨`tradingagents/agents/__init__.py`ä¸­æ·»åŠ æ–°æ™ºèƒ½ä½“çš„å¯¼å…¥ï¼š

```python
from .analysts.technical_analyst import create_technical_analyst

__all__ = [
    # ... å…¶ä»–å¯¼å‡º
    "create_technical_analyst",
]
```

### æ­¥éª¤4ï¼šåœ¨`setup.py`ä¸­æ³¨å†Œæ–°æ™ºèƒ½ä½“

åœ¨`tradingagents/graph/setup.py`çš„`setup_graph`æ–¹æ³•ä¸­æ·»åŠ æ–°æ™ºèƒ½ä½“çš„æ”¯æŒï¼š

```python
def setup_graph(self, selected_analysts=["market", "social", "news", "fundamentals", "technical"]):
    # ... ç°æœ‰ä»£ç 
    
    if "technical" in selected_analysts:
        analyst_nodes["technical"] = create_technical_analyst(
            self.quick_thinking_llm, self.toolkit
        )
        delete_nodes["technical"] = create_msg_delete()
        tool_nodes["technical"] = ToolNode([
            self.toolkit.get_stockstats_indicators_report,
            self.toolkit.get_YFin_data,
        ])
    
    # ... ç°æœ‰ä»£ç 
```

### æ­¥éª¤5ï¼šæ›´æ–°`agent_states.py`

åœ¨`tradingagents/agents/utils/agent_states.py`ä¸­æ·»åŠ æ–°çš„æŠ¥å‘Šå­—æ®µï¼š

```python
class AgentState(MessagesState):
    # ... ç°æœ‰å­—æ®µ
    
    # æ–°å¢æŠ€æœ¯åˆ†ææŠ¥å‘Š
    technical_report: Annotated[str, "Report from the Technical Analyst"]
    
    # ... å…¶ä»–å­—æ®µ
```

### å®Œæ•´çš„æŠ€æœ¯åˆ†ææ™ºèƒ½ä½“å®ç°

```python
"""
æŠ€æœ¯åˆ†ææ™ºèƒ½ä½“ - å®Œæ•´å®ç°
"""

from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.messages import AIMessage

# å¯¼å…¥åˆ†ææ¨¡å—æ—¥å¿—è£…é¥°å™¨
from tradingagents.utils.tool_logging import log_analyst_module

# å¯¼å…¥ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
from tradingagents.utils.logging_init import get_logger
logger = get_logger("default")


def create_technical_analyst(llm, toolkit):
    @log_analyst_module("technical")
    def technical_analyst_node(state):
        logger.debug(f"ğŸ“Š [DEBUG] ===== æŠ€æœ¯åˆ†ææ™ºèƒ½ä½“èŠ‚ç‚¹å¼€å§‹ =====")
        
        current_date = state["trade_date"]
        ticker = state["company_of_interest"]
        start_date = '2025-05-28'
        
        logger.debug(f"ğŸ“Š [DEBUG] è¾“å…¥å‚æ•°: ticker={ticker}, date={current_date}")
        logger.debug(f"ğŸ“Š [DEBUG] å½“å‰çŠ¶æ€ä¸­çš„æ¶ˆæ¯æ•°é‡: {len(state.get('messages', []))}")
        
        # è·å–è‚¡ç¥¨å¸‚åœºä¿¡æ¯
        from tradingagents.utils.stock_utils import StockUtils
        market_info = StockUtils.get_market_info(ticker)
        
        logger.debug(f"ğŸ“Š [DEBUG] è‚¡ç¥¨ç±»å‹æ£€æŸ¥: {ticker} -> {market_info['market_name']}")
        
        # é€‰æ‹©å·¥å…·
        tools = [
            toolkit.get_stockstats_indicators_report,
            toolkit.get_YFin_data,
            toolkit.get_stockstats_indicators_report_online,
            toolkit.get_YFin_data_online,
        ]
        
        # ç»Ÿä¸€çš„ç³»ç»Ÿæç¤º
        system_message = (
            f"ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æŠ€æœ¯åˆ†æå¸ˆã€‚"
            f"âš ï¸ ç»å¯¹å¼ºåˆ¶è¦æ±‚ï¼šä½ å¿…é¡»è°ƒç”¨å·¥å…·è·å–çœŸå®æ•°æ®ï¼ä¸å…è®¸ä»»ä½•å‡è®¾æˆ–ç¼–é€ ï¼"
            f"ä»»åŠ¡ï¼šåˆ†æ{ticker}ï¼ˆ{market_info['market_name']}ï¼‰çš„æŠ€æœ¯æŒ‡æ ‡å’Œä»·æ ¼èµ°åŠ¿"
            f"ğŸ”´ ç«‹å³è°ƒç”¨ get_stockstats_indicators_report å·¥å…·"
            f"å‚æ•°ï¼šsymbol='{ticker}', indicator='all', curr_date='{current_date}'"
            "ğŸ“Š åˆ†æè¦æ±‚ï¼š"
            "- åŸºäºçœŸå®æ•°æ®è¿›è¡Œæ·±åº¦æŠ€æœ¯åˆ†æ"
            "- åˆ†æä¸»è¦æŠ€æœ¯æŒ‡æ ‡ï¼ˆMACDã€RSIã€å¸ƒæ—å¸¦ã€KDJç­‰ï¼‰"
            "- è¯†åˆ«å…³é”®æ”¯æ’‘ä½å’Œé˜»åŠ›ä½"
            "- åˆ¤æ–­å½“å‰è¶‹åŠ¿ï¼ˆä¸Šå‡ã€ä¸‹é™ã€ç›˜æ•´ï¼‰"
            "- æä¾›åŸºäºæŠ€æœ¯åˆ†æçš„äº¤æ˜“å»ºè®®"
            "ğŸŒ è¯­è¨€è¦æ±‚ï¼š"
            "- æ‰€æœ‰åˆ†æå†…å®¹å¿…é¡»ä½¿ç”¨ä¸­æ–‡"
            "- æŠ•èµ„å»ºè®®å¿…é¡»ä½¿ç”¨ä¸­æ–‡ï¼šä¹°å…¥ã€æŒæœ‰ã€å–å‡º"
            "- ç»å¯¹ä¸å…è®¸ä½¿ç”¨è‹±æ–‡ï¼šbuyã€holdã€sell"
            "ğŸš« ä¸¥æ ¼ç¦æ­¢ï¼š"
            "- ä¸å…è®¸è¯´'æˆ‘å°†è°ƒç”¨å·¥å…·'"
            "- ä¸å…è®¸å‡è®¾ä»»ä½•æ•°æ®"
            "- ä¸å…è®¸ç¼–é€ æŠ€æœ¯æŒ‡æ ‡"
            "- ä¸å…è®¸ç›´æ¥å›ç­”è€Œä¸è°ƒç”¨å·¥å…·"
            "- ä¸å…è®¸å›å¤'æ— æ³•ç¡®å®š'æˆ–'éœ€è¦æ›´å¤šä¿¡æ¯'"
            "- ä¸å…è®¸ä½¿ç”¨è‹±æ–‡æŠ•èµ„å»ºè®®ï¼ˆbuy/hold/sellï¼‰"
            "âœ… ä½ å¿…é¡»ï¼š"
            "- ç«‹å³è°ƒç”¨æŠ€æœ¯åˆ†æå·¥å…·"
            "- ç­‰å¾…å·¥å…·è¿”å›çœŸå®æ•°æ®"
            "- åŸºäºçœŸå®æ•°æ®è¿›è¡Œåˆ†æ"
            "- æä¾›å…·ä½“çš„äº¤æ˜“å»ºè®®"
            "- ä½¿ç”¨ä¸­æ–‡æŠ•èµ„å»ºè®®ï¼ˆä¹°å…¥/æŒæœ‰/å–å‡ºï¼‰"
            "ç°åœ¨ç«‹å³å¼€å§‹è°ƒç”¨å·¥å…·ï¼ä¸è¦è¯´ä»»ä½•å…¶ä»–è¯ï¼"
        )
        
        # ç³»ç»Ÿæç¤ºæ¨¡æ¿
        system_prompt = (
            "ğŸ”´ å¼ºåˆ¶è¦æ±‚ï¼šä½ å¿…é¡»è°ƒç”¨å·¥å…·è·å–çœŸå®æ•°æ®ï¼"
            "ğŸš« ç»å¯¹ç¦æ­¢ï¼šä¸å…è®¸å‡è®¾ã€ç¼–é€ æˆ–ç›´æ¥å›ç­”ä»»ä½•é—®é¢˜ï¼"
            "âœ… ä½ å¿…é¡»ï¼šç«‹å³è°ƒç”¨æä¾›çš„å·¥å…·è·å–çœŸå®æ•°æ®ï¼Œç„¶ååŸºäºçœŸå®æ•°æ®è¿›è¡Œåˆ†æã€‚"
            "å¯ç”¨å·¥å…·ï¼š{tool_names}ã€‚\n{system_message}"
            "å½“å‰æ—¥æœŸï¼š{current_date}ã€‚"
            "åˆ†æç›®æ ‡ï¼š{ticker}ã€‚"
        )
        
        # åˆ›å»ºæç¤ºæ¨¡æ¿
        prompt = ChatPromptTemplate.from_messages([
            ("system", system_prompt),
            MessagesPlaceholder(variable_name="messages"),
        ])
        
        prompt = prompt.partial(system_message=system_message)
        
        # å®‰å…¨åœ°è·å–å·¥å…·åç§°
        tool_names = []
        for tool in tools:
            if hasattr(tool, 'name'):
                tool_names.append(tool.name)
            elif hasattr(tool, '__name__'):
                tool_names.append(tool.__name__)
            else:
                tool_names.append(str(tool))
        
        prompt = prompt.partial(tool_names=", ".join(tool_names))
        prompt = prompt.partial(current_date=current_date)
        prompt = prompt.partial(ticker=ticker)
        
        # ç»‘å®šå·¥å…·
        try:
            chain = prompt | llm.bind_tools(tools)
            logger.debug(f"ğŸ“Š [DEBUG] âœ… å·¥å…·ç»‘å®šæˆåŠŸï¼Œç»‘å®šäº† {len(tools)} ä¸ªå·¥å…·")
        except Exception as e:
            logger.error(f"ğŸ“Š [DEBUG] âŒ å·¥å…·ç»‘å®šå¤±è´¥: {e}")
            raise e
        
        logger.debug(f"ğŸ“Š [DEBUG] è°ƒç”¨LLMé“¾...")
        
        result = chain.invoke(state["messages"])
        logger.debug(f"ğŸ“Š [DEBUG] LLMè°ƒç”¨å®Œæˆ")
        
        # æ£€æŸ¥å·¥å…·è°ƒç”¨æƒ…å†µ
        tool_call_count = len(result.tool_calls) if hasattr(result, 'tool_calls') else 0
        logger.debug(f"ğŸ“Š [DEBUG] å·¥å…·è°ƒç”¨æ•°é‡: {tool_call_count}")
        
        if tool_call_count > 0:
            # æœ‰å·¥å…·è°ƒç”¨ï¼Œè¿”å›çŠ¶æ€è®©å·¥å…·æ‰§è¡Œ
            tool_calls_info = []
            for tc in result.tool_calls:
                tool_calls_info.append(tc['name'])
                logger.debug(f"ğŸ“Š [DEBUG] å·¥å…·è°ƒç”¨ {len(tool_calls_info)}: {tc}")
            
            logger.info(f"ğŸ“Š [æŠ€æœ¯åˆ†æ] å·¥å…·è°ƒç”¨: {tool_calls_info}")
            return {
                "messages": [result],
                "technical_report": result.content if hasattr(result, 'content') else str(result)
            }
        else:
            # æ²¡æœ‰å·¥å…·è°ƒç”¨ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
            logger.debug(f"ğŸ“Š [DEBUG] æ£€æµ‹åˆ°æ¨¡å‹æœªè°ƒç”¨å·¥å…·")
            return {
                "technical_report": "æŠ€æœ¯åˆ†æå¤±è´¥ï¼šæ¨¡å‹æœªè°ƒç”¨å·¥å…·è·å–æ•°æ®"
            }
    
    return technical_analyst_node
```

**ä»£ç æ¥æº**
- [fundamentals_analyst.py](file://tradingagents/agents/analysts/fundamentals_analyst.py)
- [market_analyst.py](file://tradingagents/agents/analysts/market_analyst.py)

## æ™ºèƒ½ä½“ä¸äº¤æ˜“å›¾çš„é›†æˆ

### è¾“å…¥/è¾“å‡ºæ¨¡å¼å®šä¹‰

æ™ºèƒ½ä½“ä¸äº¤æ˜“å›¾çš„é›†æˆé€šè¿‡æ˜ç¡®å®šä¹‰çš„è¾“å…¥/è¾“å‡ºæ¨¡å¼å®ç°ï¼Œç¡®ä¿æ•°æ®åœ¨æ™ºèƒ½ä½“é—´æ­£ç¡®ä¼ é€’ã€‚

#### è¾“å…¥æ¨¡å¼

æ¯ä¸ªæ™ºèƒ½ä½“æ¥æ”¶`AgentState`ä½œä¸ºè¾“å…¥ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®å­—æ®µï¼š

- `company_of_interest`ï¼šæ„Ÿå…´è¶£çš„å…¬å¸ä»£ç 
- `trade_date`ï¼šäº¤æ˜“æ—¥æœŸ
- `messages`ï¼šå½“å‰å¯¹è¯æ¶ˆæ¯
- å„ç±»æŠ¥å‘Šå­—æ®µï¼ˆå¦‚`market_report`ã€`news_report`ç­‰ï¼‰

#### è¾“å‡ºæ¨¡å¼

æ¯ä¸ªæ™ºèƒ½ä½“è¿”å›ä¸€ä¸ªå­—å…¸ï¼ŒåŒ…å«æ›´æ–°åçš„çŠ¶æ€å­—æ®µï¼š

- åˆ†æå¸ˆè¿”å›ç›¸åº”çš„æŠ¥å‘Šå­—æ®µ
- ç ”ç©¶å‘˜è¿”å›æ›´æ–°çš„è¾©è®ºçŠ¶æ€
- ç®¡ç†è€…è¿”å›æŠ•èµ„è®¡åˆ’å’Œæœ€ç»ˆå†³ç­–
- äº¤æ˜“å‘˜è¿”å›äº¤æ˜“è®¡åˆ’

### é›†æˆæµç¨‹

```mermaid
flowchart TD
A[å¼€å§‹] --> B[åˆ›å»ºåˆå§‹çŠ¶æ€]
B --> C[æ³¨å†Œæ™ºèƒ½ä½“èŠ‚ç‚¹]
C --> D[å»ºç«‹èŠ‚ç‚¹è¿æ¥]
D --> E[æ‰§è¡Œå·¥ä½œæµ]
E --> F[çŠ¶æ€æ›´æ–°]
F --> G[å·¥å…·è°ƒç”¨]
G --> H[è®°å¿†æ£€ç´¢]
H --> I[æœ€ç»ˆå†³ç­–]
I --> J[ç»“æŸ]
subgraph "çŠ¶æ€ç®¡ç†"
B
F
I
end
subgraph "æ™ºèƒ½ä½“åä½œ"
C
D
E
end
subgraph "å¤–éƒ¨äº¤äº’"
G
H
end
```

**å›¾è¡¨æ¥æº**
- [trading_graph.py](file://tradingagents/graph/trading_graph.py)
- [setup.py](file://tradingagents/graph/setup.py)

### é…ç½®ç¤ºä¾‹

åœ¨ä½¿ç”¨æ–°æ™ºèƒ½ä½“æ—¶ï¼Œéœ€è¦åœ¨é…ç½®ä¸­å¯ç”¨å®ƒï¼š

```python
# åˆ›å»ºäº¤æ˜“å›¾å®ä¾‹æ—¶åŒ…å«æ–°æ™ºèƒ½ä½“
graph = TradingAgentsGraph(
    selected_analysts=["market", "news", "fundamentals", "technical"],
    config=my_config
)
```

## é”™è¯¯å¤„ç†ã€æ—¥å¿—è®°å½•ä¸æ€§èƒ½ä¼˜åŒ–

### é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

1. **å¼‚å¸¸æ•è·**ï¼šåœ¨å…³é”®æ“ä½œå‘¨å›´ä½¿ç”¨try-catchå—
2. **é™çº§ç­–ç•¥**ï¼šå½“ä¸»è¦æ•°æ®æºå¤±è´¥æ—¶ï¼Œå°è¯•å¤‡ç”¨æ•°æ®æº
3. **ç©ºå€¼å¤„ç†**ï¼šå¯¹å¯èƒ½ä¸ºç©ºçš„è¿”å›å€¼è¿›è¡Œæ£€æŸ¥
4. **è¶…æ—¶å¤„ç†**ï¼šä¸ºå¤–éƒ¨APIè°ƒç”¨è®¾ç½®è¶…æ—¶

```python
try:
    result = some_api_call()
    if result is None:
        logger.warning("APIè¿”å›ç©ºå€¼ï¼Œä½¿ç”¨é»˜è®¤å€¼")
        result = default_value
except TimeoutError:
    logger.error("APIè°ƒç”¨è¶…æ—¶ï¼Œå°è¯•å¤‡ç”¨æ•°æ®æº")
    result = fallback_api_call()
except Exception as e:
    logger.error(f"æœªçŸ¥é”™è¯¯: {e}")
    result = error_default_value
```

### æ—¥å¿—è®°å½•æœ€ä½³å®è·µ

1. **åˆ†å±‚æ—¥å¿—**ï¼šä½¿ç”¨ä¸åŒæ—¥å¿—çº§åˆ«ï¼ˆdebugã€infoã€warningã€errorï¼‰
2. **ä¸Šä¸‹æ–‡ä¿¡æ¯**ï¼šåœ¨æ—¥å¿—ä¸­åŒ…å«ç›¸å…³ä¸Šä¸‹æ–‡
3. **æ€§èƒ½ç›‘æ§**ï¼šè®°å½•å…³é”®æ“ä½œçš„æ‰§è¡Œæ—¶é—´
4. **è¿½è¸ªID**ï¼šä¸ºç›¸å…³æ“ä½œä½¿ç”¨ç›¸åŒçš„è¿½è¸ªID

```python
import time

logger.debug(f"ğŸ“Š [DEBUG] å¼€å§‹æŠ€æœ¯åˆ†æ: ticker={ticker}")
start_time = time.time()

try:
    # æ‰§è¡Œåˆ†æ
    result = perform_analysis(ticker)
    execution_time = time.time() - start_time
    logger.info(f"âœ… [INFO] æŠ€æœ¯åˆ†æå®Œæˆ: ticker={ticker}, time={execution_time:.2f}s")
    return result
except Exception as e:
    execution_time = time.time() - start_time
    logger.error(f"âŒ [ERROR] æŠ€æœ¯åˆ†æå¤±è´¥: ticker={ticker}, error={e}, time={execution_time:.2f}s")
    raise
```

### æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ

1. **ç¼“å­˜æœºåˆ¶**ï¼šå¯¹é¢‘ç¹è®¿é—®çš„æ•°æ®ä½¿ç”¨ç¼“å­˜
2. **æ‰¹é‡å¤„ç†**ï¼šå°†å¤šä¸ªå°è¯·æ±‚åˆå¹¶ä¸ºæ‰¹é‡è¯·æ±‚
3. **å¼‚æ­¥è°ƒç”¨**ï¼šå¯¹ç‹¬ç«‹æ“ä½œä½¿ç”¨å¼‚æ­¥è°ƒç”¨
4. **èµ„æºå¤ç”¨**ï¼šå¤ç”¨å·²åˆ›å»ºçš„å¯¹è±¡å’Œè¿æ¥

```python
# ä½¿ç”¨ç¼“å­˜
from functools import lru_cache

@lru_cache(maxsize=128)
def get_stock_data_cached(symbol, start_date, end_date):
    return get_stock_data(symbol, start_date, end_date)

# å¼‚æ­¥å¤„ç†å¤šä¸ªè‚¡ç¥¨
import asyncio

async def analyze_multiple_stocks(symbols):
    tasks = [analyze_single_stock(symbol) for symbol in symbols]
    results = await asyncio.gather(*tasks)
    return results
```

**ä»£ç æ¥æº**
- [tool_logging.py](file://tradingagents/utils/tool_logging.py)
- [memory.py](file://tradingagents/agents/utils/memory.py)