# 系统监控

<cite>
**本文档引用的文件**
- [docker-compose.yml](file://docker-compose.yml)
- [Dockerfile](file://Dockerfile)
- [config/logging.toml](file://config/logging.toml)
- [config/logging_docker.toml](file://config/logging_docker.toml)
- [scripts/docker/mongo-init.js](file://scripts/docker/mongo-init.js)
- [scripts/view_logs.py](file://scripts/view_logs.py)
- [scripts/log_analyzer.py](file://scripts/log_analyzer.py)
- [scripts/get_container_logs.py](file://scripts/get_container_logs.py)
- [scripts/verify_docker_logs.py](file://scripts/verify_docker_logs.py)
- [scripts/validation/check_system_status.py](file://scripts/validation/check_system_status.py)
- [scripts/debug_docker.sh](file://scripts/debug_docker.sh)
- [scripts/debug_docker.ps1](file://scripts/debug_docker.ps1)
- [scripts/setup/setup_databases.py](file://scripts/setup/setup_databases.py)
- [scripts/setup/initialize_system.py](file://scripts/setup/initialize_system.py)
</cite>

## 目录
1. [简介](#简介)
2. [Docker健康检查机制](#docker健康检查机制)
3. [日志收集策略](#日志收集策略)
4. [管理界面监控](#管理界面监控)
5. [日志分析工具](#日志分析工具)
6. [系统状态监控](#系统状态监控)
7. [性能指标跟踪](#性能指标跟踪)
8. [故障排查指南](#故障排查指南)
9. [监控最佳实践](#监控最佳实践)

## 简介

TradingAgents-CN系统采用现代化的Docker容器化架构，提供了完整的系统监控解决方案。本文档详细介绍了基于Docker健康检查机制的服务可用性监控配置、日志收集策略、管理界面监控方法，以及各种实用的监控工具和脚本。

## Docker健康检查机制

### Web应用健康检查

系统为Web应用配置了完善的健康检查机制，确保服务可用性：

```mermaid
sequenceDiagram
participant HealthCheck as "健康检查器"
participant WebApp as "Web应用"
participant Docker as "Docker守护进程"
HealthCheck->>WebApp : curl -f http : //localhost : 8501/_stcore/health
WebApp-->>HealthCheck : HTTP 200 OK
HealthCheck->>Docker : 报告健康状态
Docker->>Docker : 启动/重启容器
Note over HealthCheck,Docker : 每30秒检查一次，超时10秒，重试3次
```

**图表来源**
- [docker-compose.yml](file://docker-compose.yml#L50-L60)

#### 健康检查配置参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 检查间隔 | 30秒 | 每30秒执行一次健康检查 |
| 超时时间 | 10秒 | 健康检查的最大等待时间 |
| 重试次数 | 3次 | 失败时的最大重试次数 |
| 启动期 | 60秒 | 容器启动后等待60秒再开始检查 |

### MongoDB健康检查

MongoDB服务使用专门的健康检查命令：

```mermaid
flowchart TD
Start([健康检查开始]) --> TestCmd["执行: echo 'db.runCommand(\"ping\").ok' | mongo localhost:27017/test --quiet"]
TestCmd --> CheckResult{"检查返回值"}
CheckResult --> |返回1| Healthy["MongoDB健康"]
CheckResult --> |返回0| Unhealthy["MongoDB不健康"]
Healthy --> End([检查完成])
Unhealthy --> End
```

**图表来源**
- [docker-compose.yml](file://docker-compose.yml#L75-L85)

#### MongoDB健康检查参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 检查命令 | `echo 'db.runCommand("ping").ok' \| mongo localhost:27017/test --quiet` | MongoDB原生命令 |
| 检查间隔 | 30秒 | 每30秒检查一次 |
| 超时时间 | 10秒 | 最大等待时间 |
| 重试次数 | 3次 | 失败时重试次数 |
| 启动期 | 40秒 | 等待40秒后开始检查 |

### Redis健康检查

Redis服务使用CLI命令进行健康检查：

```mermaid
flowchart TD
Start([Redis健康检查]) --> ExecCmd["执行: redis-cli --raw incr ping"]
ExecCmd --> CheckResp{"检查响应"}
CheckResp --> |返回数字| Success["Redis健康"]
CheckResp --> |连接失败| Failure["Redis不健康"]
Success --> End([检查结束])
Failure --> End
```

**图表来源**
- [docker-compose.yml](file://docker-compose.yml#L95-L105)

#### Redis健康检查参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 检查命令 | `redis-cli --raw incr ping` | Redis CLI命令 |
| 检查间隔 | 30秒 | 每30秒检查一次 |
| 超时时间 | 10秒 | 最大等待时间 |
| 重试次数 | 3次 | 失败时重试次数 |
| 启动期 | 30秒 | 等待30秒后开始检查 |

**章节来源**
- [docker-compose.yml](file://docker-compose.yml#L50-L105)

## 日志收集策略

### JSON文件日志驱动配置

系统采用多层次的日志配置策略，支持不同的部署环境：

```mermaid
graph TB
subgraph "日志配置层次"
Global[全局配置<br/>logging.toml]
Docker[Docker配置<br/>logging_docker.toml]
Dev[开发配置<br/>development]
Prod[生产配置<br/>production]
end
subgraph "日志处理器"
Console[控制台处理器]
File[文件处理器]
Structured[结构化日志处理器]
end
subgraph "日志级别"
Debug[DEBUG]
Info[INFO]
Warning[WARNING]
Error[ERROR]
Critical[CRITICAL]
end
Global --> Console
Global --> File
Global --> Structured
Docker --> Console
Docker --> File
Dev --> Debug
Prod --> Error
```

**图表来源**
- [config/logging.toml](file://config/logging.toml#L1-L111)
- [config/logging_docker.toml](file://config/logging_docker.toml#L1-L100)

### 日志轮转策略

系统实现了智能的日志轮转机制：

| 配置项 | 开发环境 | Docker环境 | 说明 |
|--------|----------|------------|------|
| 最大文件大小 | 10MB | 100MB | 单个日志文件最大大小 |
| 备份文件数量 | 5个 | 5个 | 保留的旧日志文件数量 |
| 日志目录 | ./logs | /app/logs | 日志文件存储位置 |
| 格式化模式 | console/file | structured | 日志输出格式 |

### 集中式日志存储

#### Docker环境日志映射

```mermaid
graph LR
subgraph "容器内"
App[应用程序<br/>/app/logs]
Logs[日志文件<br/>tradingagents.log]
end
subgraph "主机上"
HostLogs[./logs目录]
LocalFiles[本地日志文件]
end
App --> Logs
Logs --> HostLogs
HostLogs --> LocalFiles
```

**图表来源**
- [docker-compose.yml](file://docker-compose.yml#L15-L20)

#### 日志目录映射配置

系统通过Docker卷挂载实现日志持久化：

- **容器路径**: `/app/logs`
- **主机路径**: `./logs`
- **权限设置**: 读写权限
- **所有权**: 容器内用户

**章节来源**
- [config/logging.toml](file://config/logging.toml#L1-L111)
- [config/logging_docker.toml](file://config/logging_docker.toml#L1-L100)
- [docker-compose.yml](file://docker-compose.yml#L15-L20)

## 管理界面监控

### Redis Commander监控

Redis Commander提供了直观的Redis管理界面：

```mermaid
graph TB
subgraph "Redis Commander管理界面"
WebUI[Web界面<br/>端口: 8081]
RedisConn[Redis连接<br/>redis:6379]
DBList[数据库列表]
KeyViewer[键值查看器]
Monitor[实时监控]
end
WebUI --> RedisConn
RedisConn --> DBList
RedisConn --> KeyViewer
RedisConn --> Monitor
```

**图表来源**
- [docker-compose.yml](file://docker-compose.yml#L110-L125)

#### Redis Commander配置

| 配置项 | 值 | 说明 |
|--------|-----|------|
| 容器名称 | tradingagents-redis-commander | 容器标识符 |
| 端口映射 | 8081:8081 | Web界面端口 |
| Redis连接 | redis:6379 | Redis服务地址 |
| 认证密码 | tradingagents123 | 连接密码 |
| 健康检查 | wget --quiet --tries=1 --spider http://localhost:8081 | 检查命令 |

### Mongo Express监控

Mongo Express提供了MongoDB的Web管理界面：

```mermaid
sequenceDiagram
participant Browser as "浏览器"
participant MongoExpress as "Mongo Express"
participant MongoDB as "MongoDB"
Browser->>MongoExpress : 访问管理界面
MongoExpress->>MongoExpress : 验证认证信息
MongoExpress->>MongoDB : 连接数据库
MongoDB-->>MongoExpress : 返回连接状态
MongoExpress-->>Browser : 显示管理界面
Note over Browser,MongoDB : 默认用户名/密码 : admin/tradingagents123
```

**图表来源**
- [docker-compose.yml](file://docker-compose.yml#L130-L145)

#### Mongo Express配置

| 配置项 | 值 | 说明 |
|--------|-----|------|
| 容器名称 | tradingagents-mongo-express | 容器标识符 |
| 端口映射 | 8082:8081 | Web界面端口 |
| MongoDB URL | mongodb://admin:tradingagents123@mongodb:27017/ | 连接字符串 |
| 认证配置 | admin/tradingagents123 | 管理员凭据 |
| 健康检查 | wget --quiet --tries=1 --spider http://localhost:8082 | 检查命令 |

**章节来源**
- [docker-compose.yml](file://docker-compose.yml#L110-L145)

## 日志分析工具

### view_logs.py脚本功能

系统提供了强大的日志查看和分析工具：

```mermaid
flowchart TD
Start([启动日志工具]) --> Menu[显示菜单选项]
Menu --> ShowFiles[显示日志文件列表]
Menu --> ViewFile[查看日志文件内容]
Menu --> TailLog[实时跟踪日志]
Menu --> SearchLog[搜索日志内容]
Menu --> GetDockerLogs[获取Docker日志]
ShowFiles --> FileList[列出所有日志文件]
ViewFile --> SelectFile[选择文件]
SelectFile --> ShowContent[显示文件内容]
TailLog --> RealTime[实时跟踪]
SearchLog --> KeywordSearch[关键词搜索]
GetDockerLogs --> DockerCmd[显示Docker命令]
FileList --> Menu
ShowContent --> Menu
RealTime --> Menu
KeywordSearch --> Menu
DockerCmd --> Menu
```

**图表来源**
- [scripts/view_logs.py](file://scripts/view_logs.py#L1-L228)

#### 主要功能特性

| 功能 | 描述 | 使用场景 |
|------|------|----------|
| 文件浏览 | 显示所有日志文件及其元信息 | 日志文件管理 |
| 内容查看 | 支持指定行数显示和全量查看 | 日志内容分析 |
| 实时跟踪 | 实时监控日志文件变化 | 故障排查 |
| 关键词搜索 | 在所有日志文件中搜索关键词 | 异常定位 |
| Docker集成 | 提供Docker日志查看建议 | 容器环境监控 |

### log_analyzer.py高级分析

系统提供了专业的日志分析工具，能够深入挖掘系统运行状况：

```mermaid
graph TB
subgraph "日志分析流程"
Parse[解析日志文件]
Extract[提取关键信息]
Analyze[深度分析]
Report[生成报告]
end
subgraph "分析维度"
Perf[性能分析]
Errors[错误分析]
Usage[使用情况分析]
Security[安全审计]
end
Parse --> Extract
Extract --> Analyze
Analyze --> Report
Analyze --> Perf
Analyze --> Errors
Analyze --> Usage
Analyze --> Security
```

**图表来源**
- [scripts/log_analyzer.py](file://scripts/log_analyzer.py#L1-L373)

#### 分析功能详解

| 分析类型 | 检测内容 | 输出指标 |
|----------|----------|----------|
| 性能分析 | 慢操作、分析时间、Token使用 | 平均响应时间、慢操作数量、总成本 |
| 错误分析 | 错误计数、错误分类、错误趋势 | 错误总数、各类错误分布、最近错误 |
| 使用分析 | 日活统计、模块使用、分析类型 | 每日使用量、活跃模块、分析类型分布 |
| 安全审计 | API调用、Token使用、敏感数据 | API调用统计、成本分析、数据脱敏 |

**章节来源**
- [scripts/view_logs.py](file://scripts/view_logs.py#L1-L228)
- [scripts/log_analyzer.py](file://scripts/log_analyzer.py#L1-L373)

## 系统状态监控

### check_system_status.py综合检查

系统提供了全面的系统状态检查工具：

```mermaid
flowchart TD
Start([系统状态检查]) --> EnvCheck[检查环境配置]
EnvCheck --> DBCheck[检查数据库配置]
DBCheck --> CacheCheck[检查缓存系统]
CacheCheck --> ConnTest[测试连接功能]
ConnTest --> PerfTest[性能测试]
PerfTest --> Suggest[生成优化建议]
Suggest --> Report[生成检查报告]
EnvCheck --> APICheck[API密钥检查]
DBCheck --> DBManager[数据库管理器]
CacheCheck --> CacheStats[缓存统计]
ConnTest --> TestData[测试数据]
PerfTest --> LoadTime[加载时间]
```

**图表来源**
- [scripts/validation/check_system_status.py](file://scripts/validation/check_system_status.py#L1-L257)

#### 检查项目清单

| 检查类别 | 具体检查项 | 预期状态 |
|----------|------------|----------|
| 环境配置 | .env文件存在性 | ✅ 存在 |
| 数据库配置 | MongoDB连接状态 | ✅ 可用 |
| 缓存配置 | Redis连接状态 | ✅ 可用 |
| API密钥 | 各平台API密钥完整性 | ✅ 配置完整 |
| 缓存功能 | 数据保存/加载测试 | ✅ 功能正常 |
| 性能指标 | 缓存加载时间 | < 0.1秒 |

### 数据库可用性监控

系统实现了智能的数据库可用性检测机制：

```mermaid
graph TB
subgraph "数据库检测流程"
Detect[自动检测]
MongoDB[MongoDB可用?]
Redis[Redis可用?]
Fallback[降级策略]
end
subgraph "优先级选择"
Primary[主要缓存后端]
Secondary[备用缓存后端]
FileCache[文件缓存]
end
Detect --> MongoDB
Detect --> Redis
MongoDB --> |可用| Primary
Redis --> |可用| Primary
MongoDB --> |不可用| Secondary
Redis --> |不可用| FileCache
Primary --> Fallback
Secondary --> Fallback
FileCache --> Fallback
```

**图表来源**
- [scripts/validation/check_system_status.py](file://scripts/validation/check_system_status.py#L150-L200)

#### 缓存后端选择策略

| 数据库状态 | 主要后端 | 备用后端 | 性能模式 |
|------------|----------|----------|----------|
| MongoDB+Redis | Redis | MongoDB | 最佳性能 |
| 仅Redis | Redis | 文件缓存 | 高性能 |
| 仅MongoDB | MongoDB | 文件缓存 | 中等性能 |
| 无数据库 | 文件缓存 | 无 | 基础性能 |

**章节来源**
- [scripts/validation/check_system_status.py](file://scripts/validation/check_system_status.py#L1-L257)

## 性能指标跟踪

### 关键性能指标

系统监控多个关键性能指标：

```mermaid
graph TB
subgraph "性能监控指标"
CPUMonitor[CPU使用率]
MemoryMonitor[内存使用量]
ResponseTime[响应时间]
Throughput[吞吐量]
ErrorRate[错误率]
end
subgraph "监控方法"
DockerStats[docker stats]
LogAnalysis[日志分析]
SystemMetrics[系统指标]
CustomMetrics[自定义指标]
end
CPUMonitor --> DockerStats
MemoryMonitor --> DockerStats
ResponseTime --> LogAnalysis
Throughput --> SystemMetrics
ErrorRate --> LogAnalysis
```

#### 性能监控配置

| 指标类型 | 监控方法 | 阈值建议 | 告警条件 |
|----------|----------|----------|----------|
| CPU使用率 | docker stats | < 80% | > 90% |
| 内存使用率 | docker stats | < 85% | > 95% |
| 响应时间 | 日志分析 | < 5秒 | > 10秒 |
| 缓存命中率 | 自定义指标 | > 90% | < 80% |
| 错误率 | 日志分析 | < 1% | > 5% |

### 缓存性能监控

系统提供了详细的缓存性能监控：

```mermaid
sequenceDiagram
participant App as "应用程序"
participant Cache as "缓存系统"
participant Monitor as "性能监控"
App->>Cache : 请求数据
Cache->>Monitor : 记录请求时间
alt 缓存命中
Cache-->>App : 返回缓存数据
Cache->>Monitor : 记录命中时间
else 缓存未命中
Cache->>Cache : 从源获取数据
Cache->>Cache : 存储到缓存
Cache-->>App : 返回数据
Cache->>Monitor : 记录加载时间
end
Monitor->>Monitor : 计算性能指标
```

**图表来源**
- [scripts/validation/check_system_status.py](file://scripts/validation/check_system_status.py#L180-L220)

#### 缓存性能指标

| 指标名称 | 计算方法 | 正常范围 | 优化建议 |
|----------|----------|----------|----------|
| 缓存命中率 | 命中次数/总请求次数 | > 90% | 优化缓存策略 |
| 平均加载时间 | 总加载时间/加载次数 | < 0.1秒 | 优化数据源 |
| 缓存大小 | 实际缓存占用空间 | < 1GB | 调整TTL设置 |
| 内存使用率 | 缓存内存/总内存 | < 80% | 调整缓存大小 |

**章节来源**
- [scripts/validation/check_system_status.py](file://scripts/validation/check_system_status.py#L180-L257)

## 故障排查指南

### debug_docker.sh脚本功能

系统提供了跨平台的Docker故障排查工具：

```mermaid
flowchart TD
Start([开始排查]) --> CheckDocker[检查Docker服务]
CheckDocker --> CheckContainers[检查容器状态]
CheckContainers --> CheckNetwork[检查网络连接]
CheckNetwork --> CheckVolumes[检查数据卷]
CheckVolumes --> CheckPorts[检查端口占用]
CheckPorts --> CheckDisk[检查磁盘空间]
CheckDisk --> Summary[生成排查报告]
CheckDocker --> DockerOK{Docker正常?}
DockerOK --> |否| DockerError[Docker服务问题]
DockerOK --> |是| CheckContainers
CheckContainers --> ContainerOK{容器正常?}
ContainerOK --> |否| ContainerError[容器状态问题]
ContainerOK --> |是| CheckNetwork
```

**图表来源**
- [scripts/debug_docker.sh](file://scripts/debug_docker.sh#L1-L46)
- [scripts/debug_docker.ps1](file://scripts/debug_docker.ps1#L1-L47)

#### 排查项目清单

| 排查项目 | 检查命令 | 预期结果 |
|----------|----------|----------|
| Docker服务状态 | `docker version` | 服务正常运行 |
| 容器状态 | `docker-compose ps -a` | 所有容器运行中 |
| 网络连接 | `docker network ls` | 网络存在且正常 |
| 数据卷状态 | `docker volume ls` | 数据卷正常 |
| 端口占用 | `lsof -i :8501` | 端口空闲或被占用 |
| 磁盘空间 | `docker system df` | 磁盘空间充足 |

### verify_docker_logs.py日志验证

专门的日志功能验证脚本：

```mermaid
sequenceDiagram
participant Script as "验证脚本"
participant Container as "Docker容器"
participant FileSystem as "文件系统"
participant Docker as "Docker守护进程"
Script->>Container : 检查容器状态
Container-->>Script : 容器运行状态
Script->>Container : 触发日志生成
Container->>FileSystem : 写入日志文件
Script->>FileSystem : 检查本地日志
Script->>Container : 检查容器内日志
Script->>Docker : 获取Docker标准日志
Docker-->>Script : 日志输出
Script->>Script : 生成验证报告
```

**图表来源**
- [scripts/verify_docker_logs.py](file://scripts/verify_docker_logs.py#L1-L242)

#### 验证检查点

| 检查点 | 验证方法 | 通过标准 |
|--------|----------|----------|
| 容器状态 | `docker-compose ps` | TradingAgents-web状态为Up |
| 日志生成 | 容器内写入测试日志 | 成功写入测试日志 |
| 本地日志 | 检查logs目录 | 找到日志文件 |
| 容器内日志 | 检查/app/logs目录 | 日志文件存在 |
| Docker日志 | `docker logs` | 获取容器标准输出 |

### get_container_logs.py容器日志获取

专门用于从运行容器获取日志文件的工具：

```mermaid
flowchart TD
Start([开始获取日志]) --> FindContainer[查找容器]
FindContainer --> ExploreFS[探索文件系统]
ExploreFS --> CheckLogs[检查日志文件]
CheckLogs --> GetDockerLogs[获取Docker日志]
GetDockerLogs --> SelectFile[选择目标文件]
SelectFile --> FileInfo[获取文件信息]
FileInfo --> Preview[预览文件内容]
Preview --> CopyFile[复制到本地]
CopyFile --> Complete[完成]
```

**图表来源**
- [scripts/get_container_logs.py](file://scripts/get_container_logs.py#L1-L274)

#### 日志获取流程

| 步骤 | 操作 | 输出 |
|------|------|------|
| 1 | 查找容器 | 容器名称 |
| 2 | 探索文件系统 | 日志文件列表 |
| 3 | 获取文件信息 | 文件大小、修改时间 |
| 4 | 预览内容 | 文件最后几行 |
| 5 | 复制到本地 | 本地文件路径 |

**章节来源**
- [scripts/debug_docker.sh](file://scripts/debug_docker.sh#L1-L46)
- [scripts/debug_docker.ps1](file://scripts/debug_docker.ps1#L1-L47)
- [scripts/verify_docker_logs.py](file://scripts/verify_docker_logs.py#L1-L242)
- [scripts/get_container_logs.py](file://scripts/get_container_logs.py#L1-L274)

## 监控最佳实践

### 日志级别管理

根据不同的监控需求，合理设置日志级别：

```mermaid
graph TB
subgraph "日志级别策略"
Production[生产环境]
Development[开发环境]
Debug[调试环境]
end
subgraph "级别设置"
ErrorOnly[仅错误级别<br/>ERROR+]
InfoLevel[信息级别<br/>INFO+]
DebugLevel[调试级别<br/>DEBUG+]
end
Production --> ErrorOnly
Development --> InfoLevel
Debug --> DebugLevel
ErrorOnly --> Monitoring[监控告警]
InfoLevel --> Analysis[数据分析]
DebugLevel --> Troubleshooting[故障排查]
```

#### 日志级别配置建议

| 环境类型 | 推荐级别 | 主要用途 | 性能影响 |
|----------|----------|----------|----------|
| 生产环境 | ERROR | 监控告警 | 最低 |
| 测试环境 | INFO | 数据分析 | 中等 |
| 开发环境 | DEBUG | 故障排查 | 较高 |

### 监控工具组合使用

建议采用多层监控策略：

```mermaid
graph TB
subgraph "监控层次"
Infrastructure[基础设施监控<br/>Docker健康检查]
Application[应用监控<br/>系统状态检查]
Business[业务监控<br/>性能指标]
Security[安全监控<br/>访问审计]
end
subgraph "工具组合"
HealthChecks[健康检查]
StatusScripts[状态脚本]
LogTools[日志工具]
Metrics[指标收集]
end
Infrastructure --> HealthChecks
Application --> StatusScripts
Business --> Metrics
Security --> LogTools
```

### 常见监控场景

| 场景 | 推荐工具 | 关键指标 | 告警阈值 |
|------|----------|----------|----------|
| 服务启动 | healthcheck | 响应时间 | < 30秒 |
| 数据库连接 | check_system_status | 连接状态 | 可用 |
| 缓存性能 | log_analyzer | 加载时间 | < 0.1秒 |
| 错误率 | view_logs | 错误数量 | < 1% |
| 磁盘空间 | debug_docker | 使用率 | < 80% |

### 维护建议

1. **定期检查**: 每日检查系统状态，每周分析日志
2. **容量规划**: 监控磁盘空间和内存使用，提前扩容
3. **备份策略**: 定期备份配置文件和日志文件
4. **升级维护**: 及时更新Docker镜像和依赖包
5. **安全审计**: 定期检查API密钥和数据库连接

通过以上监控方案，管理员可以全面掌握TradingAgents-CN系统的运行状态，及时发现和解决问题，确保系统的稳定性和高性能运行。