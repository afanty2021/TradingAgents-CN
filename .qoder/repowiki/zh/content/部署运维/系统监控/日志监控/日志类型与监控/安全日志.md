# å®‰å…¨æ—¥å¿—

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [logging_manager.py](file://tradingagents/utils/logging_manager.py)
- [logging.toml](file://config/logging.toml)
- [logging_docker.toml](file://config/logging_docker.toml)
- [config_manager.py](file://tradingagents/config/config_manager.py)
- [tool_logging.py](file://tradingagents/utils/tool_logging.py)
- [token_tracking_demo.py](file://examples/token_tracking_demo.py)
- [deepseek_adapter.py](file://tradingagents/llm_adapters/deepseek_adapter.py)
- [openai_compatible_base.py](file://tradingagents/llm_adapters/openai_compatible_base.py)
- [log_analyzer.py](file://scripts/log_analyzer.py)
- [api_checker.py](file://web/utils/api_checker.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [å®‰å…¨æ—¥å¿—æ¶æ„æ¦‚è§ˆ](#å®‰å…¨æ—¥å¿—æ¶æ„æ¦‚è§ˆ)
3. [APIè°ƒç”¨è®°å½•åŠŸèƒ½](#apiè°ƒç”¨è®°å½•åŠŸèƒ½)
4. [Tokenç”¨é‡è¿½è¸ªæœºåˆ¶](#tokenç”¨é‡è¿½è¸ªæœºåˆ¶)
5. [æ•æ„Ÿæ•°æ®å±è”½åŠŸèƒ½](#æ•æ„Ÿæ•°æ®å±è”½åŠŸèƒ½)
6. [å®‰å…¨ç›¸å…³æ•°æ®çš„ç»“æ„åŒ–è®°å½•](#å®‰å…¨ç›¸å…³æ•°æ®çš„ç»“æ„åŒ–è®°å½•)
7. [é…ç½®ç¤ºä¾‹ä¸æœ€ä½³å®è·µ](#é…ç½®ç¤ºä¾‹ä¸æœ€ä½³å®è·µ)
8. [æ—¥å¿—è¾“å‡ºæ ·ä¾‹](#æ—¥å¿—è¾“å‡ºæ ·ä¾‹)
9. [ç›‘æ§ä¸åˆ†æå·¥å…·](#ç›‘æ§ä¸åˆ†æå·¥å…·)
10. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)

## ç®€ä»‹

TradingAgents-CNçš„å®‰å…¨æ—¥å¿—ç³»ç»Ÿæ˜¯ä¸€ä¸ªå…¨é¢çš„ç›‘æ§å’Œå®¡è®¡æ¡†æ¶ï¼Œä¸“é—¨è®¾è®¡ç”¨äºä¿æŠ¤ç”¨æˆ·éšç§ã€ç›‘æ§APIä½¿ç”¨æƒ…å†µä»¥åŠè·Ÿè¸ªLLMæˆæœ¬ã€‚è¯¥ç³»ç»Ÿé€šè¿‡ä¸‰ä¸ªæ ¸å¿ƒé…ç½®é¡¹å®ç°äº†å¤šå±‚æ¬¡çš„å®‰å…¨ä¿éšœï¼š`log_api_calls`ã€`log_token_usage`å’Œ`mask_sensitive_data`ã€‚

å®‰å…¨æ—¥å¿—ç³»ç»Ÿä¸ä»…æä¾›äº†å®æ—¶çš„ç›‘æ§èƒ½åŠ›ï¼Œè¿˜å…·å¤‡å¼ºå¤§çš„æ•°æ®åˆ†æåŠŸèƒ½ï¼Œèƒ½å¤Ÿå¸®åŠ©å¼€å‘è€…å’Œè¿ç»´äººå‘˜æ·±å…¥äº†è§£ç³»ç»Ÿçš„ä½¿ç”¨æ¨¡å¼ï¼Œè¯†åˆ«æ½œåœ¨çš„å®‰å…¨é£é™©ï¼Œå¹¶ä¼˜åŒ–èµ„æºåˆ†é…ã€‚

## å®‰å…¨æ—¥å¿—æ¶æ„æ¦‚è§ˆ

å®‰å…¨æ—¥å¿—ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œé›†æˆäº†å¤šä¸ªå…³é”®ç»„ä»¶æ¥æä¾›å…¨é¢çš„å®‰å…¨ç›‘æ§èƒ½åŠ›ã€‚

```mermaid
graph TB
subgraph "å®‰å…¨æ—¥å¿—ç³»ç»Ÿæ¶æ„"
A[æ—¥å¿—ç®¡ç†å™¨] --> B[å®‰å…¨é…ç½®]
A --> C[Tokenè·Ÿè¸ªå™¨]
A --> D[å·¥å…·æ—¥å¿—è£…é¥°å™¨]
B --> E[APIè°ƒç”¨è®°å½•]
B --> F[Tokenä½¿ç”¨ç›‘æ§]
B --> G[æ•æ„Ÿæ•°æ®å±è”½]
C --> H[æˆæœ¬è®¡ç®—]
C --> I[ä½¿ç”¨ç»Ÿè®¡]
C --> J[æˆæœ¬è­¦å‘Š]
D --> K[LLMè°ƒç”¨æ—¥å¿—]
D --> L[å·¥å…·è°ƒç”¨æ—¥å¿—]
D --> M[æ•°æ®æºè°ƒç”¨æ—¥å¿—]
N[æ—¥å¿—åˆ†æå™¨] --> O[æ€§èƒ½åˆ†æ]
N --> P[é”™è¯¯åˆ†æ]
N --> Q[æˆæœ¬ç»Ÿè®¡]
end
```

**å›¾è¡¨æ¥æº**
- [logging_manager.py](file://tradingagents/utils/logging_manager.py#L1-L411)
- [config_manager.py](file://tradingagents/config/config_manager.py#L652-L726)
- [tool_logging.py](file://tradingagents/utils/tool_logging.py#L1-L424)

**ç« èŠ‚æ¥æº**
- [logging_manager.py](file://tradingagents/utils/logging_manager.py#L1-L411)
- [logging.toml](file://config/logging.toml#L71-L109)

## APIè°ƒç”¨è®°å½•åŠŸèƒ½

### å¯ç”¨APIè°ƒç”¨è®°å½•

APIè°ƒç”¨è®°å½•åŠŸèƒ½é€šè¿‡`log_api_calls`é…ç½®é¡¹æ§åˆ¶ï¼Œè¯¥é…ç½®ä½äºå®‰å…¨æ—¥å¿—éƒ¨åˆ†ï¼š

```toml
[logging.security]
enabled = true
log_api_calls = true  # å¯ç”¨APIè°ƒç”¨è®°å½•
log_token_usage = true  # è®°å½•Tokenä½¿ç”¨
mask_sensitive_data = true  # å±è”½æ•æ„Ÿæ•°æ®
```

### å®ç°åŸç†

APIè°ƒç”¨è®°å½•é€šè¿‡è£…é¥°å™¨æ¨¡å¼å®ç°ï¼Œè‡ªåŠ¨æ•è·æ‰€æœ‰APIè°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯ï¼š

```mermaid
sequenceDiagram
participant Client as å®¢æˆ·ç«¯
participant Decorator as å·¥å…·æ—¥å¿—è£…é¥°å™¨
participant Logger as æ—¥å¿—è®°å½•å™¨
participant Security as å®‰å…¨ç›‘æ§
Client->>Decorator : è°ƒç”¨API
Decorator->>Security : æ£€æŸ¥æ•æ„Ÿæ•°æ®
Security->>Decorator : è¿”å›å¤„ç†åæ•°æ®
Decorator->>Logger : è®°å½•è°ƒç”¨å¼€å§‹
Decorator->>Client : æ‰§è¡ŒAPIè°ƒç”¨
Client-->>Decorator : è¿”å›ç»“æœ
Decorator->>Logger : è®°å½•è°ƒç”¨å®Œæˆ
Decorator-->>Client : è¿”å›ç»“æœ
```

**å›¾è¡¨æ¥æº**
- [tool_logging.py](file://tradingagents/utils/tool_logging.py#L20-L100)
- [logging_manager.py](file://tradingagents/utils/logging_manager.py#L250-L350)

### è®°å½•å†…å®¹

APIè°ƒç”¨è®°å½•åŒ…å«ä»¥ä¸‹å…³é”®ä¿¡æ¯ï¼š
- è°ƒç”¨æ—¶é—´æˆ³
- APIæä¾›å•†æ ‡è¯†
- è¯·æ±‚å‚æ•°æ‘˜è¦
- å“åº”çŠ¶æ€ç 
- æ‰§è¡Œè€—æ—¶
- ç”¨æˆ·ä¼šè¯æ ‡è¯†

**ç« èŠ‚æ¥æº**
- [tool_logging.py](file://tradingagents/utils/tool_logging.py#L20-L150)
- [logging.toml](file://config/logging.toml#L95-L102)

## Tokenç”¨é‡è¿½è¸ªæœºåˆ¶

### é…ç½®å¯ç”¨

Tokenç”¨é‡è¿½è¸ªé€šè¿‡`log_token_usage`é…ç½®é¡¹å¯ç”¨ï¼š

```toml
[logging.security]
enabled = true
log_api_calls = true
log_token_usage = true  # å¯ç”¨Tokenä½¿ç”¨è®°å½•
mask_sensitive_data = true
```

### è·Ÿè¸ªæœºåˆ¶

Tokenè·Ÿè¸ªå™¨è´Ÿè´£ç›‘æ§æ‰€æœ‰LLMè°ƒç”¨çš„Tokenä½¿ç”¨æƒ…å†µï¼š

```mermaid
flowchart TD
A[LLMè°ƒç”¨å¼€å§‹] --> B[è®°å½•è¾“å…¥Token]
B --> C[æ‰§è¡ŒLLMè°ƒç”¨]
C --> D[è®°å½•è¾“å‡ºToken]
D --> E[è®¡ç®—æˆæœ¬]
E --> F{æˆæœ¬è·Ÿè¸ªå¯ç”¨?}
F --> |æ˜¯| G[æ·»åŠ ä½¿ç”¨è®°å½•]
F --> |å¦| H[è·³è¿‡è®°å½•]
G --> I[æ£€æŸ¥æˆæœ¬è­¦å‘Š]
I --> J[è®°å½•Tokenä½¿ç”¨]
H --> K[å®Œæˆ]
J --> K
```

**å›¾è¡¨æ¥æº**
- [config_manager.py](file://tradingagents/config/config_manager.py#L652-L690)
- [deepseek_adapter.py](file://tradingagents/llm_adapters/deepseek_adapter.py#L126-L150)

### æˆæœ¬è®¡ç®—ä¸ç›‘æ§

Tokenè·Ÿè¸ªå™¨æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

| åŠŸèƒ½ | æè¿° | é…ç½®é¡¹ |
|------|------|--------|
| å®æ—¶è·Ÿè¸ª | è‡ªåŠ¨è®°å½•æ¯æ¬¡LLMè°ƒç”¨çš„Tokenä½¿ç”¨ | `enable_cost_tracking` |
| æˆæœ¬ä¼°ç®— | æ ¹æ®Tokenæ•°é‡ä¼°ç®—ä½¿ç”¨æˆæœ¬ | `pricing_config` |
| æˆæœ¬è­¦å‘Š | å½“æ—¥æˆæœ¬è¶…è¿‡é˜ˆå€¼æ—¶å‘å‡ºè­¦å‘Š | `cost_alert_threshold` |
| ä¼šè¯ç»Ÿè®¡ | è·Ÿè¸ªç‰¹å®šä¼šè¯çš„Tokenä½¿ç”¨æƒ…å†µ | `session_id` |

### è°ƒç”¨æ–¹å¼

Tokenä½¿ç”¨å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è®°å½•ï¼š

1. **è‡ªåŠ¨è®°å½•**ï¼šLLMé€‚é…å™¨è‡ªåŠ¨è®°å½•Tokenä½¿ç”¨
2. **æ‰‹åŠ¨è®°å½•**ï¼šé€šè¿‡`log_token_usage`æ–¹æ³•æ‰‹åŠ¨è®°å½•
3. **æ‰¹é‡è®°å½•**ï¼šé€šè¿‡é…ç½®ç®¡ç†å™¨æ‰¹é‡å¤„ç†ä½¿ç”¨è®°å½•

**ç« èŠ‚æ¥æº**
- [config_manager.py](file://tradingagents/config/config_manager.py#L652-L726)
- [deepseek_adapter.py](file://tradingagents/llm_adapters/deepseek_adapter.py#L126-L150)
- [token_tracking_demo.py](file://examples/token_tracking_demo.py#L242-L283)

## æ•æ„Ÿæ•°æ®å±è”½åŠŸèƒ½

### å±è”½æœºåˆ¶

æ•æ„Ÿæ•°æ®å±è”½é€šè¿‡`mask_sensitive_data`é…ç½®é¡¹å¯ç”¨ï¼Œè¯¥åŠŸèƒ½ç¡®ä¿APIå¯†é’¥ã€ç”¨æˆ·å‡­æ®ç­‰æ•æ„Ÿä¿¡æ¯ä¸ä¼šå‡ºç°åœ¨æ—¥å¿—ä¸­ï¼š

```toml
[logging.security]
enabled = true
log_api_calls = true
log_token_usage = true
mask_sensitive_data = true  # å¯ç”¨æ•æ„Ÿæ•°æ®å±è”½
```

### å±è”½ç­–ç•¥

ç³»ç»Ÿé‡‡ç”¨æ™ºèƒ½è¯†åˆ«å’Œæ©ç ç­–ç•¥ï¼š

```mermaid
flowchart TD
A[æ£€æµ‹æ•æ„Ÿæ•°æ®] --> B{æ•°æ®ç±»å‹åˆ¤æ–­}
B --> |APIå¯†é’¥| C[æ©ç å‰8ä½]
B --> |ç”¨æˆ·å‡­è¯| D[å®Œå…¨æ©ç ]
B --> |ä¸ªäººæ•°æ®| E[éƒ¨åˆ†æ©ç ]
B --> |å…¶ä»–| F[æ­£å¸¸è®°å½•]
C --> G[ç”Ÿæˆæ©ç å­—ç¬¦ä¸²]
D --> G
E --> G
F --> H[ç›´æ¥è®°å½•]
G --> I[è®°å½•è„±æ•æ•°æ®]
H --> I
```

**å›¾è¡¨æ¥æº**
- [api_checker.py](file://web/utils/api_checker.py#L0-L80)
- [logging_manager.py](file://tradingagents/utils/logging_manager.py#L250-L350)

### æ”¯æŒçš„æ•æ„Ÿæ•°æ®ç±»å‹

| æ•°æ®ç±»å‹ | æ©ç ç­–ç•¥ | ç¤ºä¾‹ |
|----------|----------|------|
| APIå¯†é’¥ | æ©ç å‰8ä½ï¼Œæ˜¾ç¤ºå4ä½ | `sk-abcde...xyz123` |
| ç”¨æˆ·å¯†ç  | å®Œå…¨æ©ç  | `******` |
| é‚®ç®±åœ°å€ | æ©ç ä¸­é—´å­—ç¬¦ | `u***@domain.com` |
| æ‰‹æœºå·ç  | æ©ç ä¸­é—´æ•°å­— | `138****5678` |
| èº«ä»½è¯å· | æ©ç ä¸­é—´æ•°å­— | `110101****1234` |

### éšç§ä¿æŠ¤ä»·å€¼

æ•æ„Ÿæ•°æ®å±è”½åŠŸèƒ½æä¾›äº†ä»¥ä¸‹å®‰å…¨ä»·å€¼ï¼š

1. **åˆè§„æ€§ä¿éšœ**ï¼šç¬¦åˆGDPRç­‰æ•°æ®ä¿æŠ¤æ³•è§„è¦æ±‚
2. **é£é™©é™ä½**ï¼šé˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²
3. **å®¡è®¡æ”¯æŒ**ï¼šæä¾›å¯å®¡è®¡çš„è„±æ•æ—¥å¿—
4. **ç”¨æˆ·ä½“éªŒ**ï¼šä¿æŠ¤ç”¨æˆ·éšç§ï¼Œå¢å¼ºä¿¡ä»»

**ç« èŠ‚æ¥æº**
- [api_checker.py](file://web/utils/api_checker.py#L0-L80)
- [logging_manager.py](file://tradingagents/utils/logging_manager.py#L250-L350)

## å®‰å…¨ç›¸å…³æ•°æ®çš„ç»“æ„åŒ–è®°å½•

### Extraå­—æ®µä¼ é€’æœºåˆ¶

Logging Manageré€šè¿‡`extra`å­—æ®µæœºåˆ¶å®ç°å®‰å…¨ç›¸å…³æ•°æ®çš„ç»“æ„åŒ–è®°å½•ï¼š

```mermaid
classDiagram
class LoggingManager {
+log_token_usage(logger, provider, model, input_tokens, output_tokens, cost, session_id)
+log_analysis_start(logger, stock_symbol, analysis_type, session_id)
+log_analysis_complete(logger, stock_symbol, analysis_type, session_id, duration, cost)
+log_module_start(logger, module_name, stock_symbol, session_id, **extra_data)
+log_module_complete(logger, module_name, stock_symbol, session_id, duration, success, result_length, **extra_data)
}
class StructuredFormatter {
+format(record)
+add_security_fields(log_entry)
+add_cost_fields(log_entry)
+add_session_fields(log_entry)
}
class SecurityLogger {
+mask_sensitive_data(data)
+validate_security_context(context)
+enforce_access_control(context)
}
LoggingManager --> StructuredFormatter : ä½¿ç”¨
LoggingManager --> SecurityLogger : è°ƒç”¨
StructuredFormatter --> SecurityLogger : ä¾èµ–
```

**å›¾è¡¨æ¥æº**
- [logging_manager.py](file://tradingagents/utils/logging_manager.py#L250-L411)

### ç»“æ„åŒ–æ•°æ®å­—æ®µ

å®‰å…¨æ—¥å¿—åŒ…å«ä»¥ä¸‹ç»“æ„åŒ–å­—æ®µï¼š

| å­—æ®µå | ç±»å‹ | æè¿° | ç¤ºä¾‹ |
|--------|------|------|------|
| `event_type` | string | äº‹ä»¶ç±»å‹æ ‡è¯† | `"token_usage"` |
| `provider` | string | LLMæä¾›å•† | `"dashscope"` |
| `model` | string | æ¨¡å‹åç§° | `"qwen-turbo"` |
| `tokens` | object | Tokenä½¿ç”¨è¯¦æƒ… | `{"input": 1000, "output": 500}` |
| `cost` | float | ä½¿ç”¨æˆæœ¬ | `0.0025` |
| `session_id` | string | ä¼šè¯æ ‡è¯†ç¬¦ | `"session_20241201_123456"` |
| `timestamp` | string | ISOæ ¼å¼æ—¶é—´æˆ³ | `"2024-12-01T12:34:56.789Z"` |
| `stock_symbol` | string | è‚¡ç¥¨ä»£ç  | `"AAPL"` |
| `analysis_type` | string | åˆ†æç±»å‹ | `"fundamental_analysis"` |

### æ•°æ®éªŒè¯ä¸è¿‡æ»¤

ç³»ç»Ÿåœ¨è®°å½•å®‰å…¨æ•°æ®æ—¶å®æ–½ä¸¥æ ¼çš„æ•°æ®éªŒè¯ï¼š

```mermaid
flowchart TD
A[æ¥æ”¶æ—¥å¿—æ•°æ®] --> B[æ•°æ®éªŒè¯]
B --> C{æ•°æ®æ ¼å¼æ­£ç¡®?}
C --> |å¦| D[æ‹’ç»è®°å½•]
C --> |æ˜¯| E[æ•æ„Ÿæ•°æ®æ£€æŸ¥]
E --> F{åŒ…å«æ•æ„Ÿæ•°æ®?}
F --> |æ˜¯| G[åº”ç”¨æ©ç ç­–ç•¥]
F --> |å¦| H[ç›´æ¥è®°å½•]
G --> I[ç”Ÿæˆè„±æ•æ•°æ®]
I --> J[è®°å½•å®‰å…¨æ—¥å¿—]
H --> J
D --> K[è®°å½•é”™è¯¯æ—¥å¿—]
```

**å›¾è¡¨æ¥æº**
- [logging_manager.py](file://tradingagents/utils/logging_manager.py#L40-L90)

**ç« èŠ‚æ¥æº**
- [logging_manager.py](file://tradingagents/utils/logging_manager.py#L250-L411)

## é…ç½®ç¤ºä¾‹ä¸æœ€ä½³å®è·µ

### å¼€å‘ç¯å¢ƒé…ç½®

```toml
# config/logging.toml
[logging.security]
enabled = true
log_api_calls = true
log_token_usage = true
mask_sensitive_data = true

[logging.performance]
log_slow_operations = true
slow_threshold_seconds = 5.0

[logging.business]
log_analysis_events = true
log_user_actions = true
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®

```toml
# config/logging_docker.toml
[logging.security]
enabled = true
log_api_calls = true
log_token_usage = true
mask_sensitive_data = true

[logging.production]
structured_only = true
error_notification = true
max_log_size = "100MB"

[logging.performance]
log_slow_operations = true
slow_threshold_seconds = 10.0
```

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# å¯ç”¨å®‰å…¨æ—¥å¿—
export TRADINGAGENTS_SECURITY_LOGGING=true
export LOG_API_CALLS=true
export LOG_TOKEN_USAGE=true
export MASK_SENSITIVE_DATA=true

# æˆæœ¬ç›‘æ§é…ç½®
export ENABLE_COST_TRACKING=true
export COST_ALERT_THRESHOLD=100.0
```

### æœ€ä½³å®è·µå»ºè®®

1. **åˆ†çº§é…ç½®**ï¼šæ ¹æ®ç¯å¢ƒå·®å¼‚é…ç½®ä¸åŒçš„å®‰å…¨çº§åˆ«
2. **å®šæœŸå®¡æŸ¥**ï¼šå®šæœŸæ£€æŸ¥æ—¥å¿—é…ç½®çš„æœ‰æ•ˆæ€§
3. **æƒé™æ§åˆ¶**ï¼šé™åˆ¶å¯¹æ—¥å¿—æ–‡ä»¶çš„è®¿é—®æƒé™
4. **å¤‡ä»½ç­–ç•¥**ï¼šå»ºç«‹æ—¥å¿—æ–‡ä»¶çš„å¤‡ä»½å’Œå½’æ¡£ç­–ç•¥
5. **ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®æˆæœ¬å’Œå¼‚å¸¸ä½¿ç”¨çš„ç›‘æ§å‘Šè­¦

**ç« èŠ‚æ¥æº**
- [logging.toml](file://config/logging.toml#L71-L109)
- [logging_docker.toml](file://config/logging_docker.toml#L76-L98)

## æ—¥å¿—è¾“å‡ºæ ·ä¾‹

### Tokenä½¿ç”¨è®°å½•ç¤ºä¾‹

```
2024-12-01 12:34:56.789 | INFO     | tools | ğŸ“Š Tokenä½¿ç”¨ - dashscope/qwen-turbo: è¾“å…¥=1000, è¾“å‡º=500, æˆæœ¬=Â¥0.0025
{
    "timestamp": "2024-12-01T12:34:56.789Z",
    "level": "INFO",
    "logger": "tools",
    "message": "ğŸ“Š Tokenä½¿ç”¨ - dashscope/qwen-turbo: è¾“å…¥=1000, è¾“å‡º=500, æˆæœ¬=Â¥0.0025",
    "module": "tool_logging",
    "function": "log_token_usage",
    "line": 250,
    "provider": "dashscope",
    "model": "qwen-turbo",
    "tokens": {
        "input": 1000,
        "output": 500
    },
    "cost": 0.0025,
    "session_id": "session_20241201_123456",
    "event_type": "token_usage"
}
```

### APIè°ƒç”¨è®°å½•ç¤ºä¾‹

```
2024-12-01 12:34:57.123 | INFO     | tools | ğŸ”§ [å·¥å…·è°ƒç”¨] stock_analysis - å¼€å§‹
{
    "timestamp": "2024-12-01T12:34:57.123Z",
    "level": "INFO",
    "logger": "tools",
    "message": "ğŸ”§ [å·¥å…·è°ƒç”¨] stock_analysis - å¼€å§‹",
    "module": "tool_logging",
    "function": "log_tool_call",
    "line": 30,
    "tool_name": "stock_analysis",
    "event_type": "tool_call_start",
    "timestamp": "2024-12-01T12:34:57.123Z",
    "args_info": {
        "args": ["AAPL"],
        "kwargs": {
            "analysis_type": "fundamental"
        }
    }
}
```

### æ•æ„Ÿæ•°æ®å±è”½ç¤ºä¾‹

```
# åŸå§‹APIå¯†é’¥
DASHSCOPE_API_KEY=sk-abcde1234567890abcdef1234567890

# æ—¥å¿—ä¸­çš„æ˜¾ç¤º
DASHSCOPE_API_KEY=sk-abcd...7890
```

### æˆæœ¬è­¦å‘Šç¤ºä¾‹

```
2024-12-01 12:35:00.000 | WARNING  | tools | âš ï¸ æˆæœ¬è­¦å‘Š: ä»Šæ—¥æˆæœ¬å·²è¾¾åˆ° Â¥125.50, è¶…è¿‡é˜ˆå€¼ Â¥100.00
{
    "timestamp": "2024-12-01T12:35:00.000Z",
    "level": "WARNING",
    "logger": "tools",
    "message": "âš ï¸ æˆæœ¬è­¦å‘Š: ä»Šæ—¥æˆæœ¬å·²è¾¾åˆ° Â¥125.50, è¶…è¿‡é˜ˆå€¼ Â¥100.00",
    "module": "token_tracker",
    "function": "_check_cost_alert",
    "line": 680,
    "cost": 125.50,
    "threshold": 100.0,
    "event_type": "cost_alert"
}
```

**ç« èŠ‚æ¥æº**
- [tool_logging.py](file://tradingagents/utils/tool_logging.py#L20-L100)
- [logging_manager.py](file://tradingagents/utils/logging_manager.py#L350-L411)

## ç›‘æ§ä¸åˆ†æå·¥å…·

### æ—¥å¿—åˆ†æå™¨

ç³»ç»Ÿæä¾›äº†ä¸“é—¨çš„æ—¥å¿—åˆ†æå·¥å…·æ¥ç›‘æ§å®‰å…¨æ—¥å¿—ï¼š

```mermaid
flowchart TD
A[æ—¥å¿—æ–‡ä»¶] --> B[LogAnalyzer]
B --> C[æ€§èƒ½åˆ†æ]
B --> D[é”™è¯¯åˆ†æ]
B --> E[æˆæœ¬ç»Ÿè®¡]
C --> F[æ…¢æ“ä½œæ£€æµ‹]
C --> G[å“åº”æ—¶é—´åˆ†æ]
D --> H[é”™è¯¯åˆ†ç±»]
D --> I[å¼‚å¸¸æ¨¡å¼è¯†åˆ«]
E --> J[Tokenä½¿ç”¨ç»Ÿè®¡]
E --> K[æˆæœ¬åˆ†å¸ƒåˆ†æ]
F --> L[æ€§èƒ½æŠ¥å‘Š]
G --> L
H --> M[é”™è¯¯æŠ¥å‘Š]
I --> M
J --> N[æˆæœ¬æŠ¥å‘Š]
K --> N
```

**å›¾è¡¨æ¥æº**
- [log_analyzer.py](file://scripts/log_analyzer.py#L20-L100)

### å…³é”®ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ç±»åˆ« | å…·ä½“æŒ‡æ ‡ | ç›‘æ§ç›®çš„ |
|----------|----------|----------|
| APIä½¿ç”¨ | è°ƒç”¨é¢‘ç‡ã€æˆåŠŸç‡ã€å“åº”æ—¶é—´ | ç›‘æ§APIå¥åº·çŠ¶å†µ |
| Tokenæ¶ˆè€— | è¾“å…¥Tokenã€è¾“å‡ºTokenã€æ€»æˆæœ¬ | æ§åˆ¶LLMä½¿ç”¨æˆæœ¬ |
| å®‰å…¨äº‹ä»¶ | æ•æ„Ÿæ•°æ®è®¿é—®ã€å¼‚å¸¸è¡Œä¸º | è¯†åˆ«å®‰å…¨å¨èƒ |
| ç³»ç»Ÿæ€§èƒ½ | æ…¢æ“ä½œã€å†…å­˜ä½¿ç”¨ã€é”™è¯¯ç‡ | ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§ |

### æŠ¥å‘Šç”Ÿæˆ

ç³»ç»Ÿèƒ½å¤Ÿç”Ÿæˆå¤šç§ç±»å‹çš„æŠ¥å‘Šï¼š

1. **å®æ—¶ç›‘æ§æŠ¥å‘Š**ï¼šæ˜¾ç¤ºå½“å‰ç³»ç»ŸçŠ¶æ€
2. **å†å²è¶‹åŠ¿æŠ¥å‘Š**ï¼šåˆ†æé•¿æœŸä½¿ç”¨æ¨¡å¼
3. **å¼‚å¸¸æ£€æµ‹æŠ¥å‘Š**ï¼šè¯†åˆ«æ½œåœ¨é—®é¢˜
4. **æˆæœ¬åˆ†ææŠ¥å‘Š**ï¼šä¼˜åŒ–èµ„æºä½¿ç”¨

**ç« èŠ‚æ¥æº**
- [log_analyzer.py](file://scripts/log_analyzer.py#L20-L200)

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### 1. å®‰å…¨æ—¥å¿—æœªå¯ç”¨

**ç—‡çŠ¶**ï¼šå®‰å…¨ç›¸å…³æ—¥å¿—ä¸è®°å½•æˆ–ç¼ºå¤±

**æ’æŸ¥æ­¥éª¤**ï¼š
```python
# æ£€æŸ¥é…ç½®
from tradingagents.utils.logging_manager import get_logger_manager
logger_manager = get_logger_manager()
security_config = logger_manager.config.get('security', {})

print(f"å®‰å…¨æ—¥å¿—å¯ç”¨: {security_config.get('enabled', False)}")
print(f"APIè°ƒç”¨è®°å½•: {security_config.get('log_api_calls', False)}")
print(f"Tokenä½¿ç”¨è®°å½•: {security_config.get('log_token_usage', False)}")
print(f"æ•æ„Ÿæ•°æ®å±è”½: {security_config.get('mask_sensitive_data', False)}")
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®è®¤é…ç½®æ–‡ä»¶ä¸­å®‰å…¨æ—¥å¿—éƒ¨åˆ†å·²å¯ç”¨
- æ£€æŸ¥ç¯å¢ƒå˜é‡è®¾ç½®
- éªŒè¯æ—¥å¿—çº§åˆ«é…ç½®

#### 2. Tokenä½¿ç”¨ç»Ÿè®¡ä¸å‡†ç¡®

**ç—‡çŠ¶**ï¼šTokenä½¿ç”¨é‡ä¸é¢„æœŸä¸ç¬¦

**æ’æŸ¥æ­¥éª¤**ï¼š
```python
# æ£€æŸ¥Tokenè·Ÿè¸ªå™¨çŠ¶æ€
from tradingagents.config.config_manager import token_tracker

# éªŒè¯æˆæœ¬è·Ÿè¸ªé…ç½®
settings = token_tracker.config_manager.load_settings()
print(f"æˆæœ¬è·Ÿè¸ªå¯ç”¨: {settings.get('enable_cost_tracking', True)}")
print(f"æˆæœ¬é˜ˆå€¼: {settings.get('cost_alert_threshold', 100.0)}")

# æ£€æŸ¥æœ€è¿‘çš„ä½¿ç”¨è®°å½•
records = token_tracker.config_manager.load_usage_records()
print(f"æœ€è¿‘è®°å½•æ•°é‡: {len(records)}")
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®è®¤LLMé€‚é…å™¨æ­£ç¡®é›†æˆTokenè·Ÿè¸ª
- æ£€æŸ¥æˆæœ¬è®¡ç®—å…¬å¼é…ç½®
- éªŒè¯ä¼šè¯IDçš„ä¸€è‡´æ€§

#### 3. æ•æ„Ÿæ•°æ®æœªæ­£ç¡®å±è”½

**ç—‡çŠ¶**ï¼šæ•æ„Ÿä¿¡æ¯å‡ºç°åœ¨æ—¥å¿—ä¸­

**æ’æŸ¥æ­¥éª¤**ï¼š
```python
# æµ‹è¯•æ•æ„Ÿæ•°æ®å±è”½
from tradingagents.utils.api_checker import check_api_keys

# æ£€æŸ¥APIå¯†é’¥éªŒè¯
api_status = check_api_keys()
for key, info in api_status['details'].items():
    if info['configured']:
        print(f"{key}: {info['display']} (å·²é…ç½®)")
    else:
        print(f"{key}: æœªé…ç½®")
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥`mask_sensitive_data`é…ç½®
- éªŒè¯æ•°æ®è¿‡æ»¤è§„åˆ™
- ç¡®è®¤æ—¥å¿—æ ¼å¼åŒ–å™¨æ­£ç¡®åº”ç”¨

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ—¥å¿—è½®è½¬é…ç½®**ï¼šåˆç†è®¾ç½®æ—¥å¿—æ–‡ä»¶å¤§å°å’Œä¿ç•™ç­–ç•¥
2. **å¼‚æ­¥å†™å…¥**ï¼šå¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œè€ƒè™‘å¼‚æ­¥æ—¥å¿—å†™å…¥
3. **é‡‡æ ·ç­–ç•¥**ï¼šå¯¹é«˜é¢‘æ“ä½œå®æ–½æ—¥å¿—é‡‡æ ·
4. **å‹ç¼©å­˜å‚¨**ï¼šå¯ç”¨æ—¥å¿—æ–‡ä»¶å‹ç¼©ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´

### å®‰å…¨åŠ å›ºæªæ–½

1. **è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶æ—¥å¿—æ–‡ä»¶çš„è¯»å–æƒé™
2. **ä¼ è¾“åŠ å¯†**ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­åŠ å¯†æ—¥å¿—ä¼ è¾“
3. **å®Œæ•´æ€§æ ¡éªŒ**ï¼šå®æ–½æ—¥å¿—å®Œæ•´æ€§éªŒè¯æœºåˆ¶
4. **å®¡è®¡è·Ÿè¸ª**ï¼šè®°å½•å¯¹æ—¥å¿—ç³»ç»Ÿçš„è®¿é—®å’Œä¿®æ”¹

**ç« èŠ‚æ¥æº**
- [log_analyzer.py](file://scripts/log_analyzer.py#L150-L200)
- [api_checker.py](file://web/utils/api_checker.py#L0-L80)

## æ€»ç»“

TradingAgents-CNçš„å®‰å…¨æ—¥å¿—ç³»ç»Ÿæä¾›äº†å…¨é¢çš„ç›‘æ§å’Œä¿æŠ¤èƒ½åŠ›ï¼Œé€šè¿‡`log_api_calls`ã€`log_token_usage`å’Œ`mask_sensitive_data`ä¸‰ä¸ªæ ¸å¿ƒé…ç½®é¡¹ï¼Œå®ç°äº†APIè°ƒç”¨ç›‘æ§ã€Tokenä½¿ç”¨è¿½è¸ªå’Œæ•æ„Ÿæ•°æ®ä¿æŠ¤çš„æœ‰æœºç»“åˆã€‚

è¯¥ç³»ç»Ÿä¸ä»…æ»¡è¶³äº†ä¼ä¸šçº§çš„å®‰å…¨åˆè§„è¦æ±‚ï¼Œè¿˜æä¾›äº†ä¸°å¯Œçš„æ•°æ®åˆ†æåŠŸèƒ½ï¼Œå¸®åŠ©å¼€å‘è€…å’Œè¿ç»´äººå‘˜æ›´å¥½åœ°ç†è§£ç³»ç»Ÿä½¿ç”¨æ¨¡å¼ï¼Œä¼˜åŒ–èµ„æºé…ç½®ï¼Œå¹¶åŠæ—¶å‘ç°æ½œåœ¨çš„å®‰å…¨é£é™©ã€‚

é€šè¿‡åˆç†çš„é…ç½®å’ŒæŒç»­çš„ç›‘æ§ï¼Œå®‰å…¨æ—¥å¿—ç³»ç»Ÿå°†æˆä¸ºTradingAgents-CNç¨³å®šè¿è¡Œçš„é‡è¦ä¿éšœï¼Œä¸ºç”¨æˆ·æä¾›å¯é ã€å®‰å…¨çš„æœåŠ¡ä½“éªŒã€‚